<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Javaåœºæ™¯100é¢˜ | SwimmingLiu&#39;s Blog</title>
<meta name="keywords" content="Java">
<meta name="description" content="å¹¶å‘ä¸æ€§èƒ½ä¼˜åŒ–
1. å¤§æ–‡ä»¶ä¸Šä¼ å¦‚ä½•å¤„ç†ï¼Ÿåˆ†ç‰‡ä¸Šä¼ 
ç›¸å…³ä»£ç ï¼šhttps://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson001
1.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ä¸Šä¼ ?
å¤§æ–‡ä»¶åœ¨ä¸Šä¼ çš„è¿‡ç¨‹ä¸­ï¼Œè€—è´¹çš„æ—¶é—´æ¯”è¾ƒé•¿ã€‚å¦‚æœç½‘ç»œä¸ç¨³å®šï¼Œå¾ˆå¯èƒ½å¯¼è‡´ä¸Šä¼ å¤±è´¥ï¼Œéœ€è¦é‡æ–°ä¸Šä¼ ã€‚åˆ†ç‰‡ä¸Šä¼ ï¼Œå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
åˆ†ç‰‡ä¸Šä¼ å®šä¹‰ï¼šå°†å¤§æ–‡ä»¶æ‹†åˆ†ä¸ºä¸åŒçš„æ–‡ä»¶å—ï¼Œé€å—è¿›è¡Œä¸Šä¼ 
1.2 å¦‚ä½•å®ç°åˆ†ç‰‡ä¸Šä¼ ï¼Ÿ
1.2.1 å¦‚ä½•å­˜å‚¨åˆ†ç‰‡ä¿¡æ¯
åˆ†ç‰‡ä¸Šä¼ éœ€è¦è®°å½•æ–‡ä»¶çš„å±æ€§ (md5ã€å¤§å°ã€åç§°)ã€åˆ†ç‰‡æ•°é‡ã€æ–‡ä»¶å­˜å‚¨çš„å®Œæ•´è·¯å¾„ (æœ¬åœ°è·¯å¾„)ï¼Œè¿˜éœ€è¦è®°å½•æ¯ä¸ªåˆ†å—çš„ä¸Šä¼ æƒ…å†µ (åˆ†å—å¤§å°ã€åˆ†å—é¡ºåºã€åˆ†å—ä»»åŠ¡id)ã€‚å¯ä»¥ç”¨ åˆ†å—ä¸Šä¼ ä»»åŠ¡è¡¨ å’Œ åˆ†å—æ–‡ä»¶è¡¨ æ¥è®°å½•ã€‚


åˆ†å—ä»»åŠ¡è¡¨ (t_shard_upload)
create table if not exists t_shard_upload(
    id varchar(32) primary key,
    file_name varchar(256) not null comment &#39;æ–‡ä»¶åç§°&#39;,
    part_num int not null comment &#39;åˆ†ç‰‡æ•°é‡&#39;,
    md5 varchar(128) comment &#39;æ–‡ä»¶md5å€¼&#39;,
    file_full_path varchar(512) comment &#39;æ–‡ä»¶å®Œæ•´è·¯å¾„&#39;
) comment = &#39;åˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡è¡¨&#39;;


åˆ†å—æ–‡ä»¶è¡¨ (t_shard_upload_partï¼‰
create table if not exists  t_shard_upload_part(
    id varchar(32) primary key,
    shard_upload_id varchar(32) not null comment &#39;åˆ†ç‰‡ä»»åŠ¡idï¼ˆt_shard_upload.idï¼‰&#39;,
    part_order int not null comment &#39;ç¬¬å‡ ä¸ªåˆ†ç‰‡ï¼Œä»1å¼€å§‹&#39;,
    file_full_path varchar(512) comment &#39;æ–‡ä»¶å®Œæ•´è·¯å¾„&#39;,
    UNIQUE KEY `uq_part_order` (`shard_upload_id`,`part_order`)
) comment = &#39;åˆ†ç‰‡æ–‡ä»¶è¡¨ï¼Œæ¯ä¸ªåˆ†ç‰‡æ–‡ä»¶å¯¹åº”ä¸€æ¡è®°å½•&#39;;


åˆ†å—æ–‡ä»¶è¡¨å’Œåˆ†å—ä¸Šä¼ è¡¨æ˜¯ 1 to M çš„å…³ç³»ï¼Œå‡å¦‚å½“å‰æ–‡ä»¶åˆ†ä¸º10å—ã€‚åˆ™ä¼šå‡ºç°1ä¸ªåˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡ï¼Œå’Œ10ä¸ªåˆ†ç‰‡æ–‡ä»¶è®°å½•ã€‚">
<meta name="author" content="SwimmingLiu">
<link rel="canonical" href="https://swimmingliu.cn/posts/job/java-scene-quiz-100/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6ecbb0040febd20e47edd88a662c19f1ea945bf7427774b86594271d18f88faf.css" integrity="sha256-bsuwBA/r0g5H7diKZiwZ8eqUW/dCd3S4ZZQnHRj4j68=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://swimmingliu.cn/images/swimmingliu_icon.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://swimmingliu.cn/images/swimmingliu_icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://swimmingliu.cn/images/swimmingliu_icon.png">
<link rel="apple-touch-icon" href="https://swimmingliu.cn/images/swimmingliu_icon.png">
<link rel="mask-icon" href="https://swimmingliu.cn/images/swimmingliu_icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://swimmingliu.cn/posts/job/java-scene-quiz-100/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            
            
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: true }
            ],
            
            throwOnError: false
        });
    });
</script>

<meta property="og:url" content="https://swimmingliu.cn/posts/job/java-scene-quiz-100/">
  <meta property="og:site_name" content="SwimmingLiu&#39;s Blog">
  <meta property="og:title" content="Javaåœºæ™¯100é¢˜">
  <meta property="og:description" content="å¹¶å‘ä¸æ€§èƒ½ä¼˜åŒ– 1. å¤§æ–‡ä»¶ä¸Šä¼ å¦‚ä½•å¤„ç†ï¼Ÿåˆ†ç‰‡ä¸Šä¼  ç›¸å…³ä»£ç ï¼šhttps://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson001
1.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ä¸Šä¼ ? å¤§æ–‡ä»¶åœ¨ä¸Šä¼ çš„è¿‡ç¨‹ä¸­ï¼Œè€—è´¹çš„æ—¶é—´æ¯”è¾ƒé•¿ã€‚å¦‚æœç½‘ç»œä¸ç¨³å®šï¼Œå¾ˆå¯èƒ½å¯¼è‡´ä¸Šä¼ å¤±è´¥ï¼Œéœ€è¦é‡æ–°ä¸Šä¼ ã€‚åˆ†ç‰‡ä¸Šä¼ ï¼Œå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
åˆ†ç‰‡ä¸Šä¼ å®šä¹‰ï¼šå°†å¤§æ–‡ä»¶æ‹†åˆ†ä¸ºä¸åŒçš„æ–‡ä»¶å—ï¼Œé€å—è¿›è¡Œä¸Šä¼ 
1.2 å¦‚ä½•å®ç°åˆ†ç‰‡ä¸Šä¼ ï¼Ÿ 1.2.1 å¦‚ä½•å­˜å‚¨åˆ†ç‰‡ä¿¡æ¯ åˆ†ç‰‡ä¸Šä¼ éœ€è¦è®°å½•æ–‡ä»¶çš„å±æ€§ (md5ã€å¤§å°ã€åç§°)ã€åˆ†ç‰‡æ•°é‡ã€æ–‡ä»¶å­˜å‚¨çš„å®Œæ•´è·¯å¾„ (æœ¬åœ°è·¯å¾„)ï¼Œè¿˜éœ€è¦è®°å½•æ¯ä¸ªåˆ†å—çš„ä¸Šä¼ æƒ…å†µ (åˆ†å—å¤§å°ã€åˆ†å—é¡ºåºã€åˆ†å—ä»»åŠ¡id)ã€‚å¯ä»¥ç”¨ åˆ†å—ä¸Šä¼ ä»»åŠ¡è¡¨ å’Œ åˆ†å—æ–‡ä»¶è¡¨ æ¥è®°å½•ã€‚
åˆ†å—ä»»åŠ¡è¡¨ (t_shard_upload)
create table if not exists t_shard_upload( id varchar(32) primary key, file_name varchar(256) not null comment &#39;æ–‡ä»¶åç§°&#39;, part_num int not null comment &#39;åˆ†ç‰‡æ•°é‡&#39;, md5 varchar(128) comment &#39;æ–‡ä»¶md5å€¼&#39;, file_full_path varchar(512) comment &#39;æ–‡ä»¶å®Œæ•´è·¯å¾„&#39; ) comment = &#39;åˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡è¡¨&#39;; åˆ†å—æ–‡ä»¶è¡¨ (t_shard_upload_partï¼‰
create table if not exists t_shard_upload_part( id varchar(32) primary key, shard_upload_id varchar(32) not null comment &#39;åˆ†ç‰‡ä»»åŠ¡idï¼ˆt_shard_upload.idï¼‰&#39;, part_order int not null comment &#39;ç¬¬å‡ ä¸ªåˆ†ç‰‡ï¼Œä»1å¼€å§‹&#39;, file_full_path varchar(512) comment &#39;æ–‡ä»¶å®Œæ•´è·¯å¾„&#39;, UNIQUE KEY `uq_part_order` (`shard_upload_id`,`part_order`) ) comment = &#39;åˆ†ç‰‡æ–‡ä»¶è¡¨ï¼Œæ¯ä¸ªåˆ†ç‰‡æ–‡ä»¶å¯¹åº”ä¸€æ¡è®°å½•&#39;; åˆ†å—æ–‡ä»¶è¡¨å’Œåˆ†å—ä¸Šä¼ è¡¨æ˜¯ 1 to M çš„å…³ç³»ï¼Œå‡å¦‚å½“å‰æ–‡ä»¶åˆ†ä¸º10å—ã€‚åˆ™ä¼šå‡ºç°1ä¸ªåˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡ï¼Œå’Œ10ä¸ªåˆ†ç‰‡æ–‡ä»¶è®°å½•ã€‚">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-07-06T13:27:35+08:00">
    <meta property="article:modified_time" content="2025-07-06T13:27:35+08:00">
    <meta property="article:tag" content="Java">
      <meta property="og:image" content="https://swimmingliu.cn/papermod-cover.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://swimmingliu.cn/papermod-cover.png">
<meta name="twitter:title" content="Javaåœºæ™¯100é¢˜">
<meta name="twitter:description" content="å¹¶å‘ä¸æ€§èƒ½ä¼˜åŒ–
1. å¤§æ–‡ä»¶ä¸Šä¼ å¦‚ä½•å¤„ç†ï¼Ÿåˆ†ç‰‡ä¸Šä¼ 
ç›¸å…³ä»£ç ï¼šhttps://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson001
1.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ä¸Šä¼ ?
å¤§æ–‡ä»¶åœ¨ä¸Šä¼ çš„è¿‡ç¨‹ä¸­ï¼Œè€—è´¹çš„æ—¶é—´æ¯”è¾ƒé•¿ã€‚å¦‚æœç½‘ç»œä¸ç¨³å®šï¼Œå¾ˆå¯èƒ½å¯¼è‡´ä¸Šä¼ å¤±è´¥ï¼Œéœ€è¦é‡æ–°ä¸Šä¼ ã€‚åˆ†ç‰‡ä¸Šä¼ ï¼Œå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
åˆ†ç‰‡ä¸Šä¼ å®šä¹‰ï¼šå°†å¤§æ–‡ä»¶æ‹†åˆ†ä¸ºä¸åŒçš„æ–‡ä»¶å—ï¼Œé€å—è¿›è¡Œä¸Šä¼ 
1.2 å¦‚ä½•å®ç°åˆ†ç‰‡ä¸Šä¼ ï¼Ÿ
1.2.1 å¦‚ä½•å­˜å‚¨åˆ†ç‰‡ä¿¡æ¯
åˆ†ç‰‡ä¸Šä¼ éœ€è¦è®°å½•æ–‡ä»¶çš„å±æ€§ (md5ã€å¤§å°ã€åç§°)ã€åˆ†ç‰‡æ•°é‡ã€æ–‡ä»¶å­˜å‚¨çš„å®Œæ•´è·¯å¾„ (æœ¬åœ°è·¯å¾„)ï¼Œè¿˜éœ€è¦è®°å½•æ¯ä¸ªåˆ†å—çš„ä¸Šä¼ æƒ…å†µ (åˆ†å—å¤§å°ã€åˆ†å—é¡ºåºã€åˆ†å—ä»»åŠ¡id)ã€‚å¯ä»¥ç”¨ åˆ†å—ä¸Šä¼ ä»»åŠ¡è¡¨ å’Œ åˆ†å—æ–‡ä»¶è¡¨ æ¥è®°å½•ã€‚


åˆ†å—ä»»åŠ¡è¡¨ (t_shard_upload)
create table if not exists t_shard_upload(
    id varchar(32) primary key,
    file_name varchar(256) not null comment &#39;æ–‡ä»¶åç§°&#39;,
    part_num int not null comment &#39;åˆ†ç‰‡æ•°é‡&#39;,
    md5 varchar(128) comment &#39;æ–‡ä»¶md5å€¼&#39;,
    file_full_path varchar(512) comment &#39;æ–‡ä»¶å®Œæ•´è·¯å¾„&#39;
) comment = &#39;åˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡è¡¨&#39;;


åˆ†å—æ–‡ä»¶è¡¨ (t_shard_upload_partï¼‰
create table if not exists  t_shard_upload_part(
    id varchar(32) primary key,
    shard_upload_id varchar(32) not null comment &#39;åˆ†ç‰‡ä»»åŠ¡idï¼ˆt_shard_upload.idï¼‰&#39;,
    part_order int not null comment &#39;ç¬¬å‡ ä¸ªåˆ†ç‰‡ï¼Œä»1å¼€å§‹&#39;,
    file_full_path varchar(512) comment &#39;æ–‡ä»¶å®Œæ•´è·¯å¾„&#39;,
    UNIQUE KEY `uq_part_order` (`shard_upload_id`,`part_order`)
) comment = &#39;åˆ†ç‰‡æ–‡ä»¶è¡¨ï¼Œæ¯ä¸ªåˆ†ç‰‡æ–‡ä»¶å¯¹åº”ä¸€æ¡è®°å½•&#39;;


åˆ†å—æ–‡ä»¶è¡¨å’Œåˆ†å—ä¸Šä¼ è¡¨æ˜¯ 1 to M çš„å…³ç³»ï¼Œå‡å¦‚å½“å‰æ–‡ä»¶åˆ†ä¸º10å—ã€‚åˆ™ä¼šå‡ºç°1ä¸ªåˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡ï¼Œå’Œ10ä¸ªåˆ†ç‰‡æ–‡ä»¶è®°å½•ã€‚">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“š Posts",
      "item": "https://swimmingliu.cn/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ’» Job",
      "item": "https://swimmingliu.cn/posts/job/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Javaåœºæ™¯100é¢˜",
      "item": "https://swimmingliu.cn/posts/job/java-scene-quiz-100/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Javaåœºæ™¯100é¢˜",
  "name": "Javaåœºæ™¯100é¢˜",
  "description": "å¹¶å‘ä¸æ€§èƒ½ä¼˜åŒ– 1. å¤§æ–‡ä»¶ä¸Šä¼ å¦‚ä½•å¤„ç†ï¼Ÿåˆ†ç‰‡ä¸Šä¼  ç›¸å…³ä»£ç ï¼šhttps://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson001\n1.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ä¸Šä¼ ? å¤§æ–‡ä»¶åœ¨ä¸Šä¼ çš„è¿‡ç¨‹ä¸­ï¼Œè€—è´¹çš„æ—¶é—´æ¯”è¾ƒé•¿ã€‚å¦‚æœç½‘ç»œä¸ç¨³å®šï¼Œå¾ˆå¯èƒ½å¯¼è‡´ä¸Šä¼ å¤±è´¥ï¼Œéœ€è¦é‡æ–°ä¸Šä¼ ã€‚åˆ†ç‰‡ä¸Šä¼ ï¼Œå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\nåˆ†ç‰‡ä¸Šä¼ å®šä¹‰ï¼šå°†å¤§æ–‡ä»¶æ‹†åˆ†ä¸ºä¸åŒçš„æ–‡ä»¶å—ï¼Œé€å—è¿›è¡Œä¸Šä¼ \n1.2 å¦‚ä½•å®ç°åˆ†ç‰‡ä¸Šä¼ ï¼Ÿ 1.2.1 å¦‚ä½•å­˜å‚¨åˆ†ç‰‡ä¿¡æ¯ åˆ†ç‰‡ä¸Šä¼ éœ€è¦è®°å½•æ–‡ä»¶çš„å±æ€§ (md5ã€å¤§å°ã€åç§°)ã€åˆ†ç‰‡æ•°é‡ã€æ–‡ä»¶å­˜å‚¨çš„å®Œæ•´è·¯å¾„ (æœ¬åœ°è·¯å¾„)ï¼Œè¿˜éœ€è¦è®°å½•æ¯ä¸ªåˆ†å—çš„ä¸Šä¼ æƒ…å†µ (åˆ†å—å¤§å°ã€åˆ†å—é¡ºåºã€åˆ†å—ä»»åŠ¡id)ã€‚å¯ä»¥ç”¨ åˆ†å—ä¸Šä¼ ä»»åŠ¡è¡¨ å’Œ åˆ†å—æ–‡ä»¶è¡¨ æ¥è®°å½•ã€‚\nåˆ†å—ä»»åŠ¡è¡¨ (t_shard_upload)\ncreate table if not exists t_shard_upload( id varchar(32) primary key, file_name varchar(256) not null comment \u0026#39;æ–‡ä»¶åç§°\u0026#39;, part_num int not null comment \u0026#39;åˆ†ç‰‡æ•°é‡\u0026#39;, md5 varchar(128) comment \u0026#39;æ–‡ä»¶md5å€¼\u0026#39;, file_full_path varchar(512) comment \u0026#39;æ–‡ä»¶å®Œæ•´è·¯å¾„\u0026#39; ) comment = \u0026#39;åˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡è¡¨\u0026#39;; åˆ†å—æ–‡ä»¶è¡¨ (t_shard_upload_partï¼‰\ncreate table if not exists t_shard_upload_part( id varchar(32) primary key, shard_upload_id varchar(32) not null comment \u0026#39;åˆ†ç‰‡ä»»åŠ¡idï¼ˆt_shard_upload.idï¼‰\u0026#39;, part_order int not null comment \u0026#39;ç¬¬å‡ ä¸ªåˆ†ç‰‡ï¼Œä»1å¼€å§‹\u0026#39;, file_full_path varchar(512) comment \u0026#39;æ–‡ä»¶å®Œæ•´è·¯å¾„\u0026#39;, UNIQUE KEY `uq_part_order` (`shard_upload_id`,`part_order`) ) comment = \u0026#39;åˆ†ç‰‡æ–‡ä»¶è¡¨ï¼Œæ¯ä¸ªåˆ†ç‰‡æ–‡ä»¶å¯¹åº”ä¸€æ¡è®°å½•\u0026#39;; åˆ†å—æ–‡ä»¶è¡¨å’Œåˆ†å—ä¸Šä¼ è¡¨æ˜¯ 1 to M çš„å…³ç³»ï¼Œå‡å¦‚å½“å‰æ–‡ä»¶åˆ†ä¸º10å—ã€‚åˆ™ä¼šå‡ºç°1ä¸ªåˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡ï¼Œå’Œ10ä¸ªåˆ†ç‰‡æ–‡ä»¶è®°å½•ã€‚\n",
  "keywords": [
    "Java"
  ],
  "articleBody": "å¹¶å‘ä¸æ€§èƒ½ä¼˜åŒ– 1. å¤§æ–‡ä»¶ä¸Šä¼ å¦‚ä½•å¤„ç†ï¼Ÿåˆ†ç‰‡ä¸Šä¼  ç›¸å…³ä»£ç ï¼šhttps://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson001\n1.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ä¸Šä¼ ? å¤§æ–‡ä»¶åœ¨ä¸Šä¼ çš„è¿‡ç¨‹ä¸­ï¼Œè€—è´¹çš„æ—¶é—´æ¯”è¾ƒé•¿ã€‚å¦‚æœç½‘ç»œä¸ç¨³å®šï¼Œå¾ˆå¯èƒ½å¯¼è‡´ä¸Šä¼ å¤±è´¥ï¼Œéœ€è¦é‡æ–°ä¸Šä¼ ã€‚åˆ†ç‰‡ä¸Šä¼ ï¼Œå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\nåˆ†ç‰‡ä¸Šä¼ å®šä¹‰ï¼šå°†å¤§æ–‡ä»¶æ‹†åˆ†ä¸ºä¸åŒçš„æ–‡ä»¶å—ï¼Œé€å—è¿›è¡Œä¸Šä¼ \n1.2 å¦‚ä½•å®ç°åˆ†ç‰‡ä¸Šä¼ ï¼Ÿ 1.2.1 å¦‚ä½•å­˜å‚¨åˆ†ç‰‡ä¿¡æ¯ åˆ†ç‰‡ä¸Šä¼ éœ€è¦è®°å½•æ–‡ä»¶çš„å±æ€§ (md5ã€å¤§å°ã€åç§°)ã€åˆ†ç‰‡æ•°é‡ã€æ–‡ä»¶å­˜å‚¨çš„å®Œæ•´è·¯å¾„ (æœ¬åœ°è·¯å¾„)ï¼Œè¿˜éœ€è¦è®°å½•æ¯ä¸ªåˆ†å—çš„ä¸Šä¼ æƒ…å†µ (åˆ†å—å¤§å°ã€åˆ†å—é¡ºåºã€åˆ†å—ä»»åŠ¡id)ã€‚å¯ä»¥ç”¨ åˆ†å—ä¸Šä¼ ä»»åŠ¡è¡¨ å’Œ åˆ†å—æ–‡ä»¶è¡¨ æ¥è®°å½•ã€‚\nåˆ†å—ä»»åŠ¡è¡¨ (t_shard_upload)\ncreate table if not exists t_shard_upload( id varchar(32) primary key, file_name varchar(256) not null comment 'æ–‡ä»¶åç§°', part_num int not null comment 'åˆ†ç‰‡æ•°é‡', md5 varchar(128) comment 'æ–‡ä»¶md5å€¼', file_full_path varchar(512) comment 'æ–‡ä»¶å®Œæ•´è·¯å¾„' ) comment = 'åˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡è¡¨'; åˆ†å—æ–‡ä»¶è¡¨ (t_shard_upload_partï¼‰\ncreate table if not exists t_shard_upload_part( id varchar(32) primary key, shard_upload_id varchar(32) not null comment 'åˆ†ç‰‡ä»»åŠ¡idï¼ˆt_shard_upload.idï¼‰', part_order int not null comment 'ç¬¬å‡ ä¸ªåˆ†ç‰‡ï¼Œä»1å¼€å§‹', file_full_path varchar(512) comment 'æ–‡ä»¶å®Œæ•´è·¯å¾„', UNIQUE KEY `uq_part_order` (`shard_upload_id`,`part_order`) ) comment = 'åˆ†ç‰‡æ–‡ä»¶è¡¨ï¼Œæ¯ä¸ªåˆ†ç‰‡æ–‡ä»¶å¯¹åº”ä¸€æ¡è®°å½•'; åˆ†å—æ–‡ä»¶è¡¨å’Œåˆ†å—ä¸Šä¼ è¡¨æ˜¯ 1 to M çš„å…³ç³»ï¼Œå‡å¦‚å½“å‰æ–‡ä»¶åˆ†ä¸º10å—ã€‚åˆ™ä¼šå‡ºç°1ä¸ªåˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡ï¼Œå’Œ10ä¸ªåˆ†ç‰‡æ–‡ä»¶è®°å½•ã€‚\n1.2.2 å¦‚ä½•å®šä¹‰åˆ†å—ä¸Šä¼ æ¥å£ åˆ†å—ä¸Šä¼ å¯ä»¥åˆ†ä¸ºä¸‹é¢ 5 ä¸ªæ¥å£\n**åˆ›å»ºåˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡æ¥å£ ** (/shardUpload/init) å…¥å‚ï¼šæ–‡ä»¶åç§°ã€æ–‡ä»¶å¤§å°ã€æ–‡ä»¶md5 å‡ºå‚ï¼šä»»åŠ¡idã€åˆ†ç‰‡æ•°é‡ å®ç°ï¼šè®¡ç®—åˆ†ç‰‡æ•°é‡ï¼Œåˆ›å»ºåˆ†ç‰‡ä»»åŠ¡ ä¸Šä¼ åˆ†ç‰‡æ–‡ä»¶ (/shardUpload/uploadPart) å…¥å‚ï¼šMultiPartFile æ–‡ä»¶ å‡ºå‚ ï¼šåˆ†ç‰‡æ–‡ä»¶è®°å½•idã€ä»»åŠ¡id å®ç°ï¼šå­˜å…¥æ–‡ä»¶åˆ°ç£ç›˜è‡ªåŠ¨ä½ç½®ï¼Œåˆ›å»ºåˆ†ç‰‡æ–‡ä»¶è®°å½• åˆå¹¶åˆ†ç‰‡ã€å®Œæˆä¸Šä¼  (/shardUpload/complete) å…¥å‚ï¼šä»»åŠ¡id å‡ºå‚ï¼šå¸ƒå°”å€¼ å®ç°ï¼šæŒ‰ç…§é¡ºåºåˆå¹¶æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶ è·å–åˆ†ç‰‡ä»»åŠ¡è¯¦ç»†ä¿¡æ¯(/shardUpload/detail) å…¥å‚ï¼šä»»åŠ¡id ã€æ–‡ä»¶md5 (äºŒé€‰ä¸€) å‡ºå‚ï¼šä»»åŠ¡è¿›åº¦ã€æ–‡ä»¶åç§°ã€æ–‡ä»¶md5 å®ç°ï¼šè¯»å–åˆ†ç‰‡æ–‡ä»¶è¡¨æŸ¥çœ‹ä¸Šä¼ æƒ…å†µ åŠŸèƒ½ï¼šè·å–åˆ†ç‰‡ä»»åŠ¡çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¦‚åˆ†ç‰‡ä»»åŠ¡æ˜¯å¦ä¸Šä¼ å®Œæ¯•ï¼Œå“ªäº›åˆ†ç‰‡å·²ä¸Šä¼ ç­‰ä¿¡æ¯ï¼Œç½‘ç»œå‡ºç°æ•…éšœï¼Œå¯ä»¥å€ŸåŠ©æ­¤æ¥å£æ¢å¤ä¸Šä¼  1.3 å¦‚æœä¸Šä¼ è¿‡ç¨‹ä¸­ï¼Œå‡ºç°æ•…éšœå¦‚ä½•å¤„ç†ï¼Ÿ æƒ…å†µ1ï¼šæµè§ˆå™¨æ— æ³•è¯»å–åˆšæ‰ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶äº† æ­¤æ—¶éœ€è¦ç”¨æˆ·é‡æ–°é€‰æ‹©æ–‡ä»¶ï¼Œé‡æ–°ä¸Šä¼ ã€‚è¿™ä¸ªåœ°æ–¹ä¹Ÿå¯ä»¥ç»™å¤§å®¶æä¾›å¦å¤–ä¸€ç§æ€è·¯ï¼Œç¬¬1ä¸ªæ¥å£åˆ›å»ºåˆ†ç‰‡ä»»åŠ¡çš„æ—¶å€™ä¼ å…¥äº†æ–‡ä»¶çš„md5ï¼ŒæŒ‰è¯´è¿™ä¸ªå€¼æ˜¯å…·æœ‰å”¯ä¸€æ€§çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡è¿™ä¸ªå€¼æ‰¾åˆ°åˆšæ‰çš„ä»»åŠ¡ï¼ŒæŒ‰ç…§è¿™ç§æ€è·¯ï¼Œå°±éœ€è¦åç«¯æä¾›ä¸€ä¸ªæ–°çš„æ¥å£ï¼šé€šè¿‡æ–‡ä»¶çš„md5å€¼æ‰¾åˆ°åˆšæ‰å¤±è´¥çš„é‚£ä¸ªä»»åŠ¡ï¼Œç„¶åç»§ç»­ä¸Šä¼ æœªä¸Šä¼ çš„åˆ†ç‰‡ã€‚\næƒ…å†µ2ï¼šæµè§ˆå™¨å¯ä»¥ç»§ç»­è¯»å–åˆšæ‰ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶ è¿™ç§æƒ…å†µï¼Œå¯ä»¥å…ˆè°ƒç”¨ç¬¬4ä¸ªæ¥å£ï¼Œé€šè¿‡æ­¤æ¥å£å¯ä»¥çŸ¥é“é‚£äº›åˆ†ç‰‡è¿˜æœªä¸Šä¼ ï¼Œç„¶åç»§ç»­ä¸Šä¼ è¿™äº›åˆ†ç‰‡å°±å¯ä»¥äº†ã€‚\n2. å¤šçº¿ç¨‹ä»»åŠ¡æ‰¹å¤„ç†é€šç”¨å·¥å…·ç±» ç›¸å…³ä»£ç ï¼šhttps://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson002\nä½¿ç”¨çº¿ç¨‹æ± æ‰¹é‡å‘é€çŸ­ä¿¡ï¼Œå½“çŸ­ä¿¡å‘é€å®Œæ¯•ä¹‹åï¼Œè®°å½•è€—æ—¶æƒ…å†µ ã€ä¸»è¦çŸ¥è¯†ç‚¹ã€‘\nCountDownLatchï¼šå¦‚æœæƒ³è¦ç­‰å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œä¹‹åï¼Œå†ç»§ç»­å›åˆ°åŸæ–¹æ³•ä¸­ï¼Œå¯ä»¥ä½¿ç”¨CountDownLatch Executorsï¼šç”¨äºåˆ›å»ºçº¿ç¨‹æ± ï¼Œé‡å†™ executor.execute ä¸­çš„ Runnable æ–¹æ³•ï¼Œå¯å®ç°å¼‚æ­¥æ‰§è¡Œçº¿ç¨‹ public class TaskDisposeUtils { /** * ä½¿ç”¨çº¿ç¨‹æ± æ‰¹å¤„ç†æ–‡ä»¶ï¼Œå½“æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œæ¯•åæ‰ä¼šè¿”å› * * @param taskList ä»»åŠ¡åˆ—è¡¨ * @param consumer å¤„ç†ä»»åŠ¡çš„æ–¹æ³• * @param executor çº¿ç¨‹æ±  * @param * @throws InterruptedException */ public static \u003cT\u003e void dispose(List\u003cT\u003e taskList, Consumer\u003c? super T\u003e consumer, Executor executor) throws InterruptedException { if (taskList == null || taskList.isEmpty() || consumer == null) return; CountDownLatch latch = new CountDownLatch(taskList.size()); for (T item : taskList) { executor.execute(() -\u003e { try { consumer.accept(item); } finally { latch.countDown(); } }); } latch.await(); } public static void main(String[] args) throws InterruptedException { long startTime = System.currentTimeMillis(); List\u003cString\u003e taskList = List.of(\"çŸ­ä¿¡-1\", \"çŸ­ä¿¡-2\", \"çŸ­ä¿¡-3\"); ExecutorService executor = Executors.newFixedThreadPool(10); dispose(taskList, TaskDisposeUtils::doTask, executor); System.out.println(\"ä»»åŠ¡å¤„ç†å®Œæ¯•,è€—æ—¶(ms):\" + (System.currentTimeMillis() - startTime)); executor.shutdown(); } public static void doTask(String task) { System.out.println(task + \"å‘é€æˆåŠŸ\"); try { TimeUnit.SECONDS.sleep(1); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } } } 3. æ¥å£æ€§èƒ½å‹åŠ›æµ‹è¯•å·¥å…· ç›¸å…³ä»£ç ï¼šhttps://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson003\n3.1 å¸¸ç”¨å‹æµ‹å·¥å…·ç±» Jemeter ã€LoadRunnerã€ApiFox - è‡ªåŠ¨åŒ–æµ‹è¯•\nã€æ³¨æ„ã€‘LoadRunner åªæœ‰windowå¯ä»¥ç”¨\n3.2 æ‰‹å†™å‹æµ‹å·¥å…·ç±» ã€ä¸»è¦çŸ¥è¯†ç‚¹ã€‘\nä¸ºä»€ä¹ˆ updateFastestTime æ–¹æ³•éœ€è¦ä½¿ç”¨å¾ªç¯è€Œä¸æ˜¯ç›´æ¥ compareAndSet ï¼šå› ä¸ºç›´æ¥ä½¿ç”¨ compareAndSet ä¼šå‡ºç°çº¿ç¨‹ä¸å®‰å…¨çš„æƒ…å†µï¼Œæ¯”å¦‚ä¸‹é¢çš„æƒ…å†µ\n// é”™è¯¯çš„åšæ³•ï¼ˆéçº¿ç¨‹å®‰å…¨ï¼‰ int current = fastestCostTime.get(); // çº¿ç¨‹Aè¯»å–åˆ°å€¼100 if (current \u003e costTime) { // çº¿ç¨‹Aåˆ¤æ–­100 \u003e 30ï¼Œå‡†å¤‡æ›´æ–° // æ­¤æ—¶çº¿ç¨‹Bä¹Ÿè¯»å–åˆ°100ï¼Œä¹Ÿåˆ¤æ–­100 \u003e 50ï¼Œä¹Ÿå‡†å¤‡æ›´æ–° fastestCostTime.set(costTime); // çº¿ç¨‹Aè®¾ç½®ä¸º30 // çº¿ç¨‹Bè®¾ç½®ä¸º50ï¼Œè¦†ç›–äº†çº¿ç¨‹Açš„ç»“æœ (æœ€å°æ—¶é—´åº”è¯¥æ˜¯30s) } // ä½¿ç”¨whileå¾ªç¯ä¿è¯çº¿ç¨‹å®‰å…¨ ï¼ˆå…¶å®å°±æ˜¯CASï¼‰ while (true){ int fsCostTime = fastestCostTime.get(); // çº¿ç¨‹Aè¯»å–åˆ°100 // çº¿ç¨‹Bæ­¤æ—¶å°†å€¼æ”¹ä¸º90 if (fastestCostTime.compareAndSet(fsCostTime, costTime)) { // çº¿ç¨‹Aå°è¯•å°†100æ”¹ä¸º50 // å¤±è´¥ï¼å› ä¸ºå½“å‰å€¼å·²ç»æ˜¯90ï¼Œä¸ç­‰äºé¢„æœŸçš„100 break; } // ç»§ç»­å¾ªç¯ï¼Œé‡æ–°è·å–æœ€æ–°å€¼90ï¼Œå†æ¬¡å°è¯• } çº¿ç¨‹æ± å‚æ•°ï¼šæ•°ä¾æ¬¡ä¸º coolPoolSize ã€maxPoolSizeã€keepAliveTimeã€TimeUnitã€waitQueue ç­‰å¾…é˜Ÿåˆ—\nä¸ºä»€ä¹ˆçº¿ç¨‹éœ€è¦é¢„çƒ­ï¼šé¢„çƒ­æ˜¯ä¸ºäº†é¿å…çº¿ç¨‹åˆ›å»ºæ—¶å¸¦æ¥çš„é¢å¤–å¼€é”€ï¼Œå¦‚æœä¸é¢„çƒ­ï¼Œå¾ˆå¯èƒ½å‰ 100 ä¸ªæ ¸å¿ƒçº¿ç¨‹éœ€è¦å¤šæ¶ˆè€— 10~50 ms æ¥åˆ›å»ºçº¿ç¨‹\nAtomicIntegerï¼šé˜²æ­¢å¤šçº¿ç¨‹ä¿®æ”¹åŒä¸€æ•°æ®æ—¶ï¼Œå‡ºç°çº¿ç¨‹ä¸å®‰å…¨çš„æƒ…å†µ\n// æ™®é€šIntegerçš„é—®é¢˜ int value = counter; // 1. è¯»å– value = value + 1; // 2. ä¿®æ”¹ counter = value; // 3. å†™å…¥ // è¿™ä¸‰æ­¥ä¸æ˜¯åŸå­çš„ï¼Œå¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­ // AtomicIntegeré‡‡ç”¨CAS + volatile ä¿è¯åŸå­æ€§ atomicCounter.incrementAndGet(); // åŸå­æ“ä½œ volatile å…³é”®å­—åœ¨AtomicIntegerä½œç”¨ï¼švolatile å°±åƒæ˜¯ç»™å˜é‡è´´äº†ä¸ª\"å®æ—¶æ›´æ–°\"çš„æ ‡ç­¾ã€‚é€šè¿‡å†…å­˜å¯è§æ€§å’Œç¦æ­¢æŒ‡ä»¤é‡æ’åºæ¥ä¿è¯å®æ—¶æ›´æ–°\n// æ²¡æœ‰volatileçš„æƒ…å†µ int count = 0; // çº¿ç¨‹Aä¿®æ”¹äº†count = 100 // çº¿ç¨‹Bå¯èƒ½è¿˜æ˜¯çœ‹åˆ°count = 0ï¼ˆå› ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ç¼“å­˜ï¼‰ æ‰€ä»¥ï¼Œå¦‚æœ æ²¡æœ‰volatile å…³é”®å­—ï¼Œ æ²¡æœ‰çº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„\"å°æœ¬æœ¬\"ï¼ˆCPUç¼“å­˜ï¼Œçº¿ç¨‹ç§æœ‰ï¼‰ï¼Œå¯èƒ½è®°å½•çš„æ•°æ®ä¸æ˜¯æœ€æ–°çš„ã€‚\npublic class LoadRunnerUtils { public static class LoadRunnerResult { private int requests; // è¯·æ±‚æ€»æ•° private int concurrency; // å¹¶å‘é‡ private int successRequests; // æˆåŠŸè¯·æ±‚æ•° private int failRequests; // å¤±è´¥è¯·æ±‚æ•° private int timeTakenForTests; // è¯·æ±‚æ€»è€—æ—¶(ms) private float requestsPerSecond; // æ¯ç§’è¯·æ±‚æ•°ï¼ˆååé‡ï¼‰ private float timePerRequest; // æ¯ä¸ªè¯·æ±‚å¹³å‡è€—æ—¶(ms) private float fastestCostTime; // æœ€å¿«çš„è¯·æ±‚è€—æ—¶(ms) private float slowestCostTime; // æœ€æ…¢çš„è¯·æ±‚è€—æ—¶(ms) } /** * æ‰§è¡Œå¹¶å‘å‹åŠ›æµ‹è¯• * @param requests æ€»è¯·æ±‚æ•° * @param concurrency å¹¶å‘æ•°é‡ * @param command è¢«æµ‹è¯•çš„ä»£ç  * @return å‹æµ‹ç»“æœ */ public static LoadRunnerResult run(int requests, int concurrency, Runnable command) throws InterruptedException { log.info(\"å‹æµ‹å¼€å§‹......\"); // åˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ï¼Œé¢„çƒ­æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹ ThreadPoolExecutor executor = createThreadPool(concurrency); // ç”¨äºç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆçš„åŒæ­¥å™¨ CountDownLatch latch = new CountDownLatch(requests); // ç»Ÿè®¡æ•°æ®ï¼ˆä½¿ç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨ï¼‰ AtomicInteger successCount = new AtomicInteger(0); AtomicInteger fastestTime = new AtomicInteger(Integer.MAX_VALUE); AtomicInteger slowestTime = new AtomicInteger(Integer.MIN_VALUE); long startTime = System.currentTimeMillis(); // æäº¤æ‰€æœ‰å‹æµ‹ä»»åŠ¡ for (int i = 0; i \u003c requests; i++) { executor.execute(() -\u003e executeRequest(command, successCount, fastestTime, slowestTime, latch)); } // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ latch.await(); executor.shutdown(); long endTime = System.currentTimeMillis(); log.info(\"å‹æµ‹ç»“æŸï¼Œæ€»è€—æ—¶(ms):{}\", (endTime - startTime)); // è¿”å›å‹æµ‹ç»“æœ } /** * åˆ›å»ºçº¿ç¨‹æ± å¹¶é¢„çƒ­æ ¸å¿ƒçº¿ç¨‹ */ private static ThreadPoolExecutor createThreadPool(int concurrency) { // å‚æ•°ä¾æ¬¡ä¸º coolPoolSizeã€maxPoolSizeã€keepAliveTimeã€TimeUnitã€ç­‰å¾…é˜Ÿåˆ— ThreadPoolExecutor executor = new ThreadPoolExecutor(concurrency, concurrency, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue\u003c\u003e()); executor.prestartAllCoreThreads(); return executor; } /** * æ‰§è¡Œå•ä¸ªè¯·æ±‚å¹¶ç»Ÿè®¡ç»“æœ */ private static void executeRequest(Runnable command, AtomicInteger successCount, AtomicInteger fastestTime, AtomicInteger slowestTime, CountDownLatch latch) { try { long requestStart = System.currentTimeMillis(); command.run(); // æ‰§è¡Œè¢«æµ‹è¯•çš„æ–¹æ³• int costTime = (int)(System.currentTimeMillis() - requestStart); // æ›´æ–°ç»Ÿè®¡æ•°æ® updateFastestTime(fastestTime, costTime); updateSlowestTime(slowestTime, costTime); successCount.incrementAndGet(); } catch (Exception e) { log.error(\"è¯·æ±‚æ‰§è¡Œå¤±è´¥: {}\", e.getMessage()); } finally { latch.countDown(); // æ ‡è®°å½“å‰è¯·æ±‚å®Œæˆ } } /** * åŸå­æ›´æ–°æœ€å¿«è€—æ—¶ */ private static void updateFastestTime(AtomicInteger fastestTime, int costTime) { while (true) { int current = fastestTime.get(); if (current \u003c= costTime || fastestTime.compareAndSet(current, costTime)) { break; } } } } 4. Semaphoreå®ç°æ¥å£é™æµ å¦‚æœåç«¯æœåŠ¡æ˜¯å•ä½“æœåŠ¡ï¼Œä¸”åªéƒ¨ç½²åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥é‡‡ç”¨ Semaphore ä¿¡å·é‡çš„æ–¹å¼å®ç°ç®€å•çš„æ¥å£é™æµæœºåˆ¶\nç›¸å…³ä»£ç ï¼šhttps://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson005\nSemaphore : JUCå½“ä¸­å¯¹ä¿¡å·é‡çš„å®ç°ï¼Œç”¨äºæ§åˆ¶åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚\npublic class TestController { /** * Jucä¸­çš„Semaphoreå¯ä»¥å®ç°é™æµåŠŸèƒ½ï¼Œå¯ä»¥å°† Semaphore æƒ³è±¡æˆåœè½¦åœºå…¥å£çš„å¤§çˆ·ï¼Œ * å¤§çˆ·æ‰‹é‡Œé¢æ‹¥æœ‰ä¸€å®šæ•°é‡çš„åœè½¦å¡ï¼ˆä¹Ÿå¯ä»¥è¯´æ˜¯ä»¤ç‰Œï¼‰ï¼Œå¡çš„æ•°é‡æ˜¯å¤šå°‘å‘¢ï¼Ÿå°±æ˜¯Semaphoreæ„é€ æ–¹æ³•ä¸­æŒ‡å®šçš„ï¼Œå¦‚ä¸‹å°±æ˜¯50ä¸ªå¡ï¼Œ * è½¦ä¸»æƒ³è¿›å»åœè½¦ï¼Œå…ˆè¦ä»å¤§çˆ·æ‰‹ä¸­æ‹¿åˆ°ä¸€å¼ å¡ï¼Œå‡ºæ¥çš„æ—¶å€™ï¼Œéœ€è¦è¿˜ç»™å¤§çˆ·ï¼Œå¦‚æœæ‹¿ä¸åˆ°å¡ï¼Œå°±ä¸èƒ½è¿›å»åœè½¦ã€‚ * semaphore å†…éƒ¨æä¾›äº†è·å–ä»¤ç‰Œï¼Œå’Œè¿˜ä»¤ç‰Œçš„ä¸€äº›æ–¹æ³• */ private Semaphore semaphore = new Semaphore(50); /** * æ¥ä¸ªæ¡ˆä¾‹ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¸‹å•çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æœ€å¤šåªå…è®¸ 50 ä¸ªå¹¶å‘ï¼Œè‹¥è¶…è¿‡50ä¸ªå¹¶å‘ï¼Œåˆ™è¿›æ¥çš„è¯·æ±‚ï¼Œæœ€å¤šç­‰å¾…1ç§’ï¼Œå¦‚æœæ— æ³•è·å–åˆ°ä»¤ç‰Œï¼Œåˆ™å¿«é€Ÿè¿”å›å¤±è´¥ï¼Œè¯·é‡è¯• * @return */ @GetMapping(\"/placeOrder\") public String placeOrder() throws InterruptedException { /** * semaphore åœ¨ä¸Šé¢å®šä¹‰çš„ï¼Œé‡Œé¢æœ‰50ä¸ªä»¤ç‰Œï¼Œä¹Ÿå°±æ˜¯åŒæ—¶å¯ä»¥æ”¯æŒ50ä¸ªå¹¶å‘è¯·æ±‚ * ä¸‹é¢çš„ä»£ç ï¼Œå°è¯•æœ€å¤šç­‰å¾…1ç§’å»è·å–ä»¤ç‰Œï¼Œè·å–æˆåŠŸï¼Œåˆ™è¿›å…¥ä¸‹å•é€»è¾‘ï¼Œè·å–å¤±è´¥ï¼Œåˆ™è¿”å›ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯• */ boolean flag = this.semaphore.tryAcquire(1, 1L, TimeUnit.SECONDS); // è·å–åˆ°ä»¤ç‰Œï¼Œåˆ™è¿›å…¥ä¸‹å•é€»è¾‘ if (flag) { try { //è¿™é‡Œä¼‘çœ 2ç§’ï¼Œæ¨¡æ‹Ÿä¸‹å•çš„æ“ä½œ TimeUnit.SECONDS.sleep(2); return \"ä¸‹å•æˆåŠŸ\"; } finally { //è¿™é‡Œä¸€å®šä¸è¦æ¼æ‰äº†ï¼Œä»¤ç‰Œç”¨å®Œäº†ï¼Œè¦è¿˜å›å» this.semaphore.release(); } } else { return \"ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•\"; } } } 5. å¹¶è¡ŒæŸ¥è¯¢ - æäº¤æ¥å£å“åº”é€Ÿåº¦ éœ€æ±‚åˆ†æï¼šå½“å‰æ¥å£éœ€è¦å®ç°ä¸‹é¢çš„åŠŸèƒ½\næ¥æ”¶ä¸€ä¸ªå•†å“idï¼Œéœ€è¦è¿”å›å•†å“ä¸‹é¢è¿™äº›ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯éƒ½åœ¨ä¸åŒçš„è¡¨ä¸­ï¼Œé€šè¿‡å•†å“idå°±å¯ä»¥æŸ¥åˆ°\nå•†å“åŸºæœ¬ä¿¡æ¯ï¼ˆå¦‚å•†å“åç§°ã€ä»·æ ¼ç­‰åŸºæœ¬ä¿¡æ¯) å•†å“æè¿°ä¿¡æ¯ï¼ˆå¯èƒ½æ˜¯å¯Œæ–‡æœ¬ï¼Œæ”¾åœ¨å•ç‹¬çš„è¡¨ä¸­ï¼‰ å•†å“æ”¶è—é‡ å•†å“è¯„è®ºé‡ ç›¸å…³ä»£ç ï¼šhttps://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson006\n5.1 å¸¸è§„åšæ³• æŒ‰ç…§å•†å“ id åˆ†åˆ«æŸ¥è¯¢ä¸åŒçš„æ•°æ®åº“ï¼Œåœ¨JVMå†…å­˜ä¸­å¯¹ç»“æœè¿›è¡Œç»„è£…ã€‚\npublic class GoodsController { /** * æ ¹æ®å•†å“idè·å–å•†å“ä¿¡æ¯(åŸºæœ¬ä¿¡æ¯ã€æè¿°ä¿¡æ¯ã€è¯„è®ºé‡ï¼Œæ”¶è—é‡) * * @param goodsId å•†å“id * @return * @throws InterruptedException */ @GetMapping(\"/getGoodsDetail\") public GoodsDetailResponse getGoodsDetail(@RequestParam(\"goodsId\") String goodsId) { long st = System.currentTimeMillis(); GoodsDetailResponse goodsDetailResponse = new GoodsDetailResponse(); // 1ã€è·å–å•†å“åŸºæœ¬ä¿¡æ¯ï¼Œè€—æ—¶100ms goodsDetailResponse.setGoodsInfo(this.getGoodsInfo(goodsId)); //2ã€è·å–å•†å“æè¿°ä¿¡æ¯ï¼Œè€—æ—¶100ms goodsDetailResponse.setGoodsDescription(this.getGoodsDescription(goodsId)); //3ã€è·å–å•†å“è¯„è®ºé‡ï¼Œè€—æ—¶100ms goodsDetailResponse.setCommentCount(this.getGoodsCommentCount(goodsId)); //4ã€è·å–å•†å“æ”¶è—é‡ï¼Œè€—æ—¶100ms goodsDetailResponse.setFavoriteCount(this.getGoodsFavoriteCount(goodsId)); // æ€»è€—æ—¶ä¸º500mså·¦å³ LOGGER.info(\"è·å–å•†å“ä¿¡æ¯ï¼Œæ™®é€šç‰ˆè€—æ—¶ï¼š{} ms\", (System.currentTimeMillis() - st)); } // ä½¿ç”¨sleepæ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢çš„å»¶è¿Ÿ private int getGoodsFavoriteCount(String goodsId) { try { log.info(\"è·å–å•†å“æ”¶è—é‡\"); TimeUnit.MILLISECONDS.sleep(100); } catch (InterruptedException e) { Thread.currentThread().interrupt(); throw new RuntimeException(e); } return 10000; } 5.2 ä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡ŒæŸ¥è¯¢å•†å“ä¿¡æ¯ åˆ†æï¼šä¸Šæ–¹çš„4ä¸ªå•†å“ä¿¡æ¯æŸ¥è¯¢ä¹‹é—´å¹¶æ²¡æœ‰ä»»ä½•ä¾èµ–ï¼Œè¿™äº›æ²¡æœ‰ä¾èµ–çš„æŸ¥è¯¢å…¶å®æ˜¯å¯ä»¥å¹¶è¡ŒæŸ¥è¯¢çš„ã€‚æ‰€ä»¥å¯ä»¥ä½¿ç”¨çº¿ç¨‹æ± åŒæ—¶å»æ‹¿è¿™4ä¸ªç»“æœï¼Œç„¶ååœ¨JVMå†…å­˜ä¸­è¿›è¡Œç»„è£…\nã€ä¸»è¦çŸ¥è¯†ç‚¹ã€‘\nCompletableFuture (CF)ï¼šä¸»è¦ç”¨äºå¼‚æ­¥æ‰§è¡Œå¤šä¸ªç›¸äº’ç‹¬ç«‹çš„ä»»åŠ¡ ï¼ˆé€‚åˆå¼‚æ­¥ä»»åŠ¡ç¼–æ’ï¼Œå¯ä»¥æ–¹ä¾¿åœ°ç»„åˆå’Œè½¬æ¢ä»»åŠ¡ç»“æœï¼‰\nCountDownLatch (CDL): ä¸»è¦ç”¨äºçº¿ç¨‹åè°ƒï¼Œç­‰å¾…ä¸€ç»„çº¿ç¨‹å®Œæˆ ï¼ˆä¸€èˆ¬å°±æ˜¯ç”¨æ¥ç­‰å¾…ä¸€æ‰¹çº¿ç¨‹æ‰§è¡Œå®Œï¼‰\nCF å’Œ CDL åŒºåˆ«\nCountDownLatch ğŸ‘‰ è¿åŠ¨ä¼šèµ·è·‘ è£åˆ¤ï¼ˆä¸»çº¿ç¨‹ï¼‰ç­‰å¾…æ‰€æœ‰è¿åŠ¨å‘˜ï¼ˆå­çº¿ç¨‹ï¼‰å°±ä½ï¼ˆcountDownï¼‰ï¼Œæªå“ï¼ˆè®¡æ•°å™¨å½’é›¶ï¼‰åç»Ÿä¸€å¼€è·‘ã€‚ CompletableFuture ğŸ‘‰ å¤–å–è®¢å•æµç¨‹ ä¸‹å•ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰â†’ åˆ¶ä½œï¼ˆthenApply åŠ å·¥ï¼‰â†’ é…é€ï¼ˆthenAccept äº¤ä»˜ï¼‰ï¼Œæ¯ä¸ªç¯èŠ‚è‡ªåŠ¨è§¦å‘ä¸‹ä¸€æ­¥ï¼Œæ— éœ€é˜»å¡ å¯¹æ¯”ç»´åº¦ CountDownLatch CompletableFuture æ ¸å¿ƒç”¨é€” çº¿ç¨‹ç­‰å¾…æœºåˆ¶ï¼ˆé˜»å¡çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆï¼‰ å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ï¼ˆéé˜»å¡é“¾å¼ä»»åŠ¡å¤„ç†ï¼‰ å·¥ä½œæ–¹å¼ é€šè¿‡è®¡æ•°å™¨é€’å‡ï¼ˆcountDown()ï¼‰è§¦å‘é‡Šæ”¾ é€šè¿‡å›è°ƒé“¾ï¼ˆthenApply()/thenAccept()ï¼‰ä¼ é€’ç»“æœ çº¿ç¨‹é˜»å¡ è°ƒç”¨çº¿ç¨‹ä¸»åŠ¨é˜»å¡ï¼ˆawait()ï¼‰ è°ƒç”¨çº¿ç¨‹ä¸é˜»å¡ï¼Œé€šè¿‡å›è°ƒå¤„ç†ç»“æœ ç»“æœä¼ é€’ âŒ ä¸æ”¯æŒä»»åŠ¡ç»“æœä¼ é€’ âœ… æ”¯æŒä»»åŠ¡ç»“æœä¼ é€’å’Œè½¬æ¢ å¼‚å¸¸å¤„ç† âŒ éœ€æ‰‹åŠ¨æ•è·å¼‚å¸¸ âœ… å†…ç½®å¼‚å¸¸å¤„ç†ï¼ˆexceptionally()/handle()ï¼‰ ä»»åŠ¡ç»„åˆ âŒ ä»…æ”¯æŒå•æ¬¡è®¡æ•° âœ… æ”¯æŒå¤šä»»åŠ¡ç»„åˆï¼ˆallOf()/anyOf()ï¼‰ å¤ç”¨æ€§ âŒ è®¡æ•°å™¨å½’é›¶åä¸å¯é‡ç”¨ âœ… å¯é‡å¤ç»„åˆæ–°ä»»åŠ¡ å…¸å‹åœºæ™¯ å¯åŠ¨å‰ç­‰å¾…èµ„æºåˆå§‹åŒ–ã€æ‰¹é‡ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œ å¼‚æ­¥APIè°ƒç”¨ã€æµæ°´çº¿å¼æ•°æ®å¤„ç†ã€å¾®æœåŠ¡ç¼–æ’ ä¸‹é¢çœ‹ä¸€ç»„CFå’ŒCDLçš„ä»£ç å¯¹æ¯”ï¼š\npublic class AsyncDemo { // æ¨¡æ‹Ÿçº¿ç¨‹æ±  private static final ExecutorService executor = Executors.newFixedThreadPool(3); /** * CompletableFutureæ–¹å¼ - æ”¯æŒä»»åŠ¡ç¼–æ’å’Œç»“æœå¤„ç† */ public GoodsInfo getGoodsInfoWithCF(String goodsId) { GoodsInfo result = new GoodsInfo(); // 1. åˆ›å»ºå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ CompletableFuture\u003cString\u003e basicInfoFuture = CompletableFuture .supplyAsync(() -\u003e queryBasicInfo(goodsId), executor); CompletableFuture\u003cInteger\u003e priceFuture = CompletableFuture .supplyAsync(() -\u003e queryPrice(goodsId), executor); // 2. å¯¹ç»“æœè¿›è¡Œå¤„ç†è½¬æ¢ CompletableFuture\u003cString\u003e processedInfo = basicInfoFuture .thenApply(info -\u003e \"å¤„ç†åçš„å•†å“ä¿¡æ¯: \" + info) .exceptionally(ex -\u003e \"è·å–å•†å“ä¿¡æ¯å¤±è´¥\"); // 3. ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆå¹¶ç»„è£…ç»“æœ CompletableFuture.allOf(processedInfo, priceFuture).join(); result.setInfo(processedInfo.join()); result.setPrice(priceFuture.join()); return result; } /** * CountDownLatchæ–¹å¼ - ä»…æ”¯æŒç­‰å¾…å¤šä¸ªçº¿ç¨‹å®Œæˆ */ public GoodsInfo getGoodsInfoWithCDL(String goodsId) throws InterruptedException { GoodsInfo result = new GoodsInfo(); CountDownLatch latch = new CountDownLatch(2); // 1. éœ€è¦æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ executor.submit(() -\u003e { try { result.setInfo(queryBasicInfo(goodsId)); } finally { latch.countDown(); } }); executor.submit(() -\u003e { try { result.setPrice(queryPrice(goodsId)); } finally { latch.countDown(); } }); // 2. ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ latch.await(); return result; } å¦‚æœéœ€è¦å¼‚æ­¥å¹¶è¡Œ + ä»»åŠ¡ç¼–æ’ï¼Œå°±ç”¨ CompletableFuture ï¼›å¦‚æœåªæ˜¯ç”¨äºç­‰å¾…ä¸€æ‰¹å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œï¼Œå°±ç”¨ CountDownLaunch\npublic class GoodsController { /** * ä¼˜åŒ–åçš„æ–¹æ³•ï¼Œæ ¹æ®å•†å“idè·å–å•†å“ä¿¡æ¯(åŸºæœ¬ä¿¡æ¯ã€æè¿°ä¿¡æ¯ã€è¯„è®ºé‡ï¼Œæ”¶è—é‡) * * @param goodsId å•†å“id * @return * @throws InterruptedException */ @GetMapping(\"/getGoodsDetailNew\") public GoodsDetailResponse getGoodsDetailNew(@RequestParam(\"goodsId\") String goodsId) { long st = System.currentTimeMillis(); GoodsDetailResponse goodsDetailResponse = new GoodsDetailResponse(); // 1ã€è·å–å•†å“åŸºæœ¬ä¿¡æ¯ï¼Œè€—æ—¶100ms CompletableFuture\u003cVoid\u003e goodsInfoCf = CompletableFuture.runAsync(() -\u003e goodsDetailResponse.setGoodsInfo(this.getGoodsInfo(goodsId)), this.goodsThreadPool); //2ã€è·å–å•†å“æè¿°ä¿¡æ¯ï¼Œè€—æ—¶100ms CompletableFuture\u003cVoid\u003e goodsDescriptionCf = CompletableFuture.runAsync(() -\u003e goodsDetailResponse.setGoodsDescription(this.getGoodsDescription(goodsId)), this.goodsThreadPool); //3ã€è·å–å•†å“è¯„è®ºé‡ï¼Œè€—æ—¶100ms CompletableFuture\u003cVoid\u003e goodsCommentCountCf = CompletableFuture.runAsync(() -\u003e goodsDetailResponse.setCommentCount(this.getGoodsCommentCount(goodsId)), this.goodsThreadPool); //4ã€è·å–å•†å“æ”¶è—é‡ï¼Œè€—æ—¶100ms CompletableFuture\u003cVoid\u003e goodsFavoriteCountCf = CompletableFuture.runAsync(() -\u003e goodsDetailResponse.setFavoriteCount(this.getGoodsFavoriteCount(goodsId)), this.goodsThreadPool); //ç­‰å¾…ä¸Šé¢æ‰§è¡Œç»“æŸ CompletableFuture.allOf(goodsInfoCf, goodsDescriptionCf, goodsCommentCountCf, goodsFavoriteCountCf).join(); // æ€»è€—æ—¶å¤§çº¦åœ¨100mså·¦å³ LOGGER.info(\"è·å–å•†å“ä¿¡æ¯ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡ŒæŸ¥è¯¢è€—æ—¶ï¼š{} ms\", (System.currentTimeMillis() - st)); return goodsDetailResponse; } } 6. å¹¶è¡ŒæŸ¥è¯¢å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ ç›¸å…³ä»£ç ï¼šhttps://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson006\n6.1 å¹¶è¡ŒæŸ¥è¯¢ä¸­å­˜åœ¨çš„é—®é¢˜ å¹¶è¡ŒæŸ¥è¯¢æ‰€ç”¨åˆ°çš„çº¿ç¨‹æ± é…ç½®æ˜¯éå¸¸å…³é”®ä¸”é‡è¦çš„é…ç½®ï¼Œå¦‚æœè®¾ç½®ä¸å½“å¯èƒ½å‡ºç°ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚\næ¯”å¦‚å°†æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸ºäº† 1 ï¼Œè€Œé˜Ÿåˆ—å¤§å°æ²¡æœ‰é™åˆ¶ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„è¯·æ±‚éƒ½å˜æˆä¸²è¡Œäº†ï¼Œä¼šå¯¼è‡´è¯·æ±‚å“åº”éå¸¸æ…¢ã€‚å¦å¤–ï¼Œæ ¸å¿ƒçº¿ç¨‹æ± å’Œé˜Ÿåˆ—å¤§å°çš„ä¸Šé™ä¹Ÿåº”è¯¥åŒ¹é…ã€‚å¦‚æœæ ¸å¿ƒçº¿ç¨‹æ± è®¾ç½®ä¸º 10 ï¼Œè€Œé˜Ÿåˆ—å¤§å°æ²¡æœ‰è®¾ç½®ä¸Šé™ã€‚è¯¥çº¿ç¨‹æ± åŒæ—¶åªå¯æ”¯æŒ 10 ä¸ªä»»åŠ¡å¹¶è¡Œï¼Œå…¶ä»–çš„è¯·æ±‚éƒ½ä¼šå˜æˆä¸²è¡Œæ‰§è¡Œäº†ï¼Œè¿›å…¥é˜Ÿåˆ—æ’é˜Ÿï¼Œä»è€Œå¯¼è‡´æ¥å£å“åº”ç‰¹åˆ«æ…¢ã€‚\n6.2 å¦‚ä½•è§£å†³å¹¶è¡ŒæŸ¥è¯¢çš„é—®é¢˜ è§£å†³å¹¶è¡ŒæŸ¥è¯¢é—®é¢˜çš„æ ¸å¿ƒï¼šä¸è¦è®©ä»»åŠ¡æ’é˜Ÿæˆ–è€…æ’é˜Ÿæ—¶é—´ä¸è¦å¤ªé•¿\nä¸‹é¢ä»çº¿ç¨‹æ± çš„æ‰§è¡Œæµç¨‹å…¥æ‰‹ï¼Œä¼˜åŒ–å¹¶è¡ŒæŸ¥è¯¢é—®é¢˜\nã€è§£å†³æ–¹æ¡ˆã€‘\nå¢å¤§çº¿ç¨‹æ•°ï¼šå¯ä»¥å°†æ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°è°ƒå¤§ï¼Œä½†ä¸èƒ½è°ƒåˆ°è¶…è¿‡CPUçš„æœ€å¤§è´Ÿè½½ï¼Œä¸ç„¶å¯èƒ½ä¼šé™ä½ç³»ç»Ÿæ€§èƒ½åˆ†ã€‚è¯¥å‚æ•°åº”è¯¥æ ¹æ®ä¸šåŠ¡çš„æŒ‡æ ‡è¿›è¡Œå‹æµ‹å¾—åˆ°ä¸€ä¸ªåˆç†çš„å€¼\nå‡å°‘é˜Ÿåˆ—æ•°ï¼š\nå°†é˜Ÿåˆ—å¤§å°è®¾ç½®çš„æ¯”è¾ƒå°ï¼Œè¿™æ ·æ’é˜Ÿçš„æ—¶é—´å¤§æ¦‚ç‡ä¼šæ¯”è¾ƒçŸ­ï¼Œæˆ–è€…æ’é˜Ÿå¤±è´¥ï¼Œç›´æ¥åé¢çš„æµç¨‹\nâš ï¸ ä¹‹å‰ç†è§£å­˜åœ¨è¯¯åŒºï¼šåº”è¯¥æ˜¯æ ¸å¿ƒçº¿ç¨‹æ£€æŸ¥å®Œäº†ï¼Œå°±æ£€æŸ¥èƒ½å¦æ”¾å…¥é˜Ÿåˆ—ï¼Œå†æ£€æŸ¥æœ€å¤§çº¿ç¨‹æ•°ã€‚è€Œä¸æ˜¯æ ¸å¿ƒçº¿ç¨‹æ£€æŸ¥å®Œï¼Œå°±å»æ£€æŸ¥æœ€å¤§çº¿ç¨‹æ•°ã€‚\nå‡å°‘é˜Ÿåˆ—æ•°è‡³ 0ï¼šè¿™æ ·ä»»åŠ¡å°±ä¸ä¼šè¿›å…¥é˜Ÿåˆ—ï¼Œè€Œç›´æ¥åˆ›å»ºæ–°çš„çº¿ç¨‹å»æ‰§è¡Œï¼Œæˆ–è€…èµ°æ‹’ç»ç­–ç•¥\nLinkedBlockingQueueã€ArrayBlockingQueue å®¹é‡æ˜¯ä¸å…è®¸ä¸º0çš„ï¼Œå¦‚æœéœ€è¦ç”¨åˆ°å®¹é‡ä¸º0çš„é˜Ÿåˆ—ï¼Œåˆ™éœ€è¦ä½¿ç”¨åŒæ­¥é˜»å¡é˜Ÿåˆ— SynchronousQueue\næ‹’ç»ç­–ç•¥ï¼šå¯ä»¥ä½¿ç”¨ CallerRunsPolicyï¼Œè¿™ä¸ªç­–ç•¥æ˜¯ç›´æ¥åœ¨è°ƒç”¨çº¿ç¨‹çš„å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œã€‚è¯¥ç­–ç•¥å¯ä»¥ä¿è¯ä»»åŠ¡èƒ½å¿«é€Ÿè¢«å¤„ç†ï¼Œä¸ä¼šä¸€ç›´å¤„äºé˜»å¡æ€\nç­–ç•¥åç§° è¡Œä¸ºæè¿° é€‚ç”¨åœºæ™¯ ç”Ÿæ´»å®ä¾‹ç±»æ¯” AbortPolicy ç›´æ¥æŠ›å‡º RejectedExecutionException å¼‚å¸¸ éœ€è¦ä¸¥æ ¼ä¿è¯ä»»åŠ¡ä¸ä¸¢å¤±çš„åœºæ™¯ é¤å…æ»¡å‘˜æ—¶ç›´æ¥æ‹’ç»æ–°é¡¾å®¢ CallerRunsPolicy è®©æäº¤ä»»åŠ¡çš„çº¿ç¨‹è‡ªå·±æ‰§è¡Œè¯¥ä»»åŠ¡ éœ€è¦é™ä½ä»»åŠ¡æäº¤é€Ÿåº¦çš„åœºæ™¯ ç»ç†äº²è‡ªå¤„ç†æ— æ³•åˆ†é…çš„ä»»åŠ¡ DiscardPolicy é™é»˜ä¸¢å¼ƒæ–°ä»»åŠ¡ï¼Œä¸æŠ›å¼‚å¸¸ä¹Ÿä¸æ‰§è¡Œ å…è®¸ä¸¢å¼ƒéå…³é”®ä»»åŠ¡çš„åœºæ™¯ å¿«é€’çˆ†ä»“æ—¶ç›´æ¥ä¸¢å¼ƒæ–°åŒ…è£¹ DiscardOldestPolicy ä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ä»»åŠ¡ï¼Œç„¶åå°è¯•é‡æ–°æäº¤å½“å‰ä»»åŠ¡ ä¼˜å…ˆå¤„ç†æ–°ä»»åŠ¡çš„åœºæ™¯ è¶…å¸‚æ’é˜Ÿæ—¶è®©ç­‰å¾…æœ€ä¹…çš„é¡¾å®¢ç¦»å¼€ çº¿ç¨‹æ± éš”ç¦»ï¼šä¸åŒçš„ä¸šåŠ¡æœ€å¥½ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼Œäº’ä¸å½±å“ï¼Œå¼ºçƒˆå»ºè®®æ ¸å¿ƒä¸šåŠ¡ä¸€å®šè¦ä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹æ± ã€‚\nã€ä¼˜åŒ–åçš„çº¿ç¨‹æ± é…ç½®ã€‘\n@Bean public ThreadPoolTaskExecutor goodsThreadPool() { ThreadPoolTaskExecutor threadPoolTaskExecutor = new ThreadPoolTaskExecutor(); threadPoolTaskExecutor.setThreadNamePrefix(\"ThreadPool-Goods-\"); // æ ¸å¿ƒçº¿ç¨‹æ•°ä¸ºcpuæ ¸æ•° * 4ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ®ä¸ºcpuæ ¸æ•° * 8 threadPoolTaskExecutor.setCorePoolSize(Runtime.getRuntime().availableProcessors() * 4); threadPoolTaskExecutor.setMaxPoolSize(Runtime.getRuntime().availableProcessors() * 8); // é˜Ÿåˆ—å®¹é‡ä¸º0ï¼Œåˆ™ä»»åŠ¡å°±ä¸ä¼šè¿›å…¥é˜Ÿåˆ— threadPoolTaskExecutor.setQueueCapacity(0); // æ‹’ç»ç­–ç•¥ä½¿ç”¨CallerRunsPolicyï¼Œè®©å½“å‰çº¿ç¨‹å»å…œåº•å»æ‰§è¡Œä»»åŠ¡ threadPoolTaskExecutor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy()); return threadPoolTaskExecutor; } 7. æ¥å£æ€§èƒ½è°ƒä¼˜ä¹‹å¤§ (é•¿) äº‹åŠ¡ä¼˜åŒ– æ—¥å¸¸ç¼–ç¨‹ä¸­ï¼Œå®¹æ˜“é‡åˆ°äº‹åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„æƒ…å†µã€‚å¦‚æœè¯¥äº‹åŠ¡çš„å¯¹åº”çš„æ¥å£ï¼Œè¯·æ±‚é‡æš´å¢ï¼Œç”±äºæ•°æ®åº“è¿æ¥æ± çš„é™åˆ¶ï¼Œå¤§éƒ¨åˆ†è¯·æ±‚å¯èƒ½ä¼šå¤±è´¥ã€‚\nç›¸å…³ä»£ç ï¼šhttps://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson009\n7.1 å¤§(é•¿)äº‹åŠ¡æ‰€å¸¦æ¥çš„é—®é¢˜ ä¸‹é¢çš„ä»£ç å¸¦æœ‰ @Transcational æ³¨è§£ï¼Œ è¯´æ˜è¯¥æ–¹æ³•ä¼šäº¤ç»™ Spring æ¥ç®¡ç†è¯¥æ–¹æ³•çš„äº‹åŠ¡ã€‚å…·ä½“æ‰§è¡Œé€»è¾‘å¦‚ä¸‹ï¼š\n1ã€Springå»æ•°æ®åº“è¿æ¥æ± æ‹¿åˆ°ä¸€ä¸ªæ•°æ®åº“è¿æ¥ 2ã€å¼€å¯äº‹åŠ¡ 3ã€æ‰§è¡ŒbigTransaction()ä¸­çš„ä»£ç  4ã€æäº¤äº‹åŠ¡ 5ã€å°†æ•°æ®åº“è¿æ¥è¿˜ç»™æ•°æ®åº“è¿æ¥æ± ä¸­ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ•°æ®åº“è¿æ¥ä¼šä¸€ç›´è¢«å ç”¨ã€‚å› ä¸ºæ•°æ®åº“è¿æ¥æ—¶æœ‰é™çš„ï¼Œå¹¶ä¸”æ˜¯éå¸¸ç¨€ç¼ºçš„èµ„ã€‚å¦‚æœé•¿æ—¶é—´è¢«å ç”¨ï¼Œå¹¶ä¸”æ•°æ®åº“è¿æ¥æ± ä¸­çš„å¯ç”¨è¿æ¥éƒ½è¢«å ç”¨äº†ï¼Œåˆ™å…¶ä»–è¯·æ±‚æ— æ³•è¿æ¥æ•°æ®åº“ã€‚å®ƒä¼šå¯¼è‡´è¿æ¥è¶…æ—¶ï¼Œæ‰§è¡Œæ–¹æ³•å¤±è´¥ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢æ–¹æ³•ä¸­ this.getData() æ–¹æ³•ä¼šå ç”¨ 5s çš„æ—¶é—´ã€‚å¦‚æœ 5s å†…æœ‰ 100 æ¡è¯·æ±‚å¹¶å‘æ‰§è¡Œï¼Œä¸”æ•°æ®åº“è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ä¸º 20ï¼Œè¶…æ—¶æ—¶é—´ä¸º3sã€‚ åˆ™å‰©ä½™çš„ 80 æ¡è¯·æ±‚ï¼Œéƒ½ä¼šå‡ºç°è¿æ¥å¤±è´¥çš„ç°è±¡ã€‚\n@Transactional public void bigTransaction() throws InterruptedException { // 1ã€getData()æ–¹æ³•æ¨¡æ‹Ÿä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„è·å–æ•°æ®çš„æ“ä½œï¼Œè¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¼šä¼‘çœ 5ç§’ String data = this.getData(); //2ã€å°†ä¸Šé¢è·å–åˆ°çš„æ•°æ®å†™å…¥åˆ°dbä¸­ Lesson007PO po = new Lesson007PO(); po.setId(UUID.randomUUID().toString()); po.setData(data); this.lesson007Mapper.insert(po); } public String getData() throws InterruptedException { //ä¼‘çœ 5ç§’ TimeUnit.SECONDS.sleep(5); return UUID.randomUUID().toString(); } 7.2 å¦‚ä½•è§£å†³å¤§ (é•¿) äº‹åŠ¡çš„é—®é¢˜ (æ‹†åˆ†ä¸ºå°äº‹åŠ¡) ä¼˜åŒ–æ–¹æ³•ï¼šå°†å¤§(é•¿)äº‹åŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œå°†æ— éœ€æ•°æ®åº“è¿æ¥çš„éƒ¨åˆ†æ‹†å‡ºæ¥ï¼Œå°†äº‹åŠ¡æœ€å°åŒ–ã€‚ ä¾‹å¦‚ï¼Œä¸Šæ–¹çš„ä»£ç ä¸­ï¼Œthis.getData() æ–¹æ³•æ˜¯ä¸éœ€è¦æ“ä½œæ•°æ®åº“çš„ï¼Œåªæœ‰æœ€åçš„ insert æ–¹æ³•æ‰éœ€è¦è¿æ¥æ•°æ®åº“ã€‚æ‰€ä»¥ï¼Œå¯ä»¥å°†äº‹åŠ¡çš„ç²’åº¦æ§åˆ¶åœ¨ insert æ–¹æ³•ä¸­ã€‚\nTranscationTemplateï¼šSpringä¸­çš„ TranscationTemplate å·¥å…·ç±»èƒ½å¤Ÿé‡‡ç”¨ç¼–ç¨‹å¼çš„æ–¹æ¡ˆï¼Œçµæ´»æ§åˆ¶äº‹åŠ¡çš„ç²’åº¦ã€‚\n/** * ä½¿ç”¨ TransactionTemplate ç¼–ç¨‹å¼äº‹åŠ¡ï¼Œå¯ä»¥çµæ´»çš„æ§åˆ¶äº‹åŠ¡çš„èŒƒå›´ * * @throws InterruptedException */ public void smallTransaction() throws InterruptedException { // 1ã€è°ƒç”¨getData()æ–¹æ³•ï¼Œè®²è·å–çš„æ•°æ®å†™åˆ°dbä¸­ï¼Œå‡è®¾ getDataæ–¹æ³•æ¯”è¾ƒè€—æ—¶ï¼Œæ¯”å¦‚è€—æ—¶ 5ç§’ String data = this.getData(); //2ã€å°†ä¸Šé¢è·å–åˆ°çš„æ•°æ®å†™å…¥åˆ°dbä¸­ Lesson007PO po = new Lesson007PO(); po.setId(UUID.randomUUID().toString()); po.setData(data); // this.transactionTemplate.executeWithoutResultå¯ä»¥ä¼ å…¥ä¸€ä¸ªConsumerï¼Œè¿™ä¸ªConsumerè¡¨è¿°éœ€è¦åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œçš„ä¸šåŠ¡æ“ä½œ this.transactionTemplate.executeWithoutResult(action -\u003e { this.lesson007Mapper.insert(po); }); } ã€æ€»ç»“ã€‘\næ§åˆ¶äº‹åŠ¡ç²’åº¦ ï¼šä½¿ç”¨ TransactionTemplate ç¼–ç¨‹å¼äº‹åŠ¡ï¼Œç²¾å‡†æ§åˆ¶äº‹åŠ¡çš„ç²’åº¦ï¼Œå°½é‡è®©äº‹åŠ¡å°å‹åŒ– éæ•°æ®åº“ç›¸å…³ä»£ç ï¼Œé¿å…å‡ºç°åœ¨äº‹åŠ¡ä¸­ï¼šå°½é‡é¿å…å°†æ²¡æœ‰äº‹åŠ¡çš„è€—æ—¶æ“ä½œæ”¾åˆ°äº‹åŠ¡ä»£ç ä¸­ï¼›é¿å…åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œè¿œç¨‹æ“ä½œï¼Œè¿œç¨‹æ“ä½œæ˜¯ä¸éœ€è¦ç”¨åˆ°æœ¬åœ°äº‹åŠ¡çš„ï¼Œæ‰€ä»¥æ²¡æœ‰å¿…è¦æ”¾åœ¨äº‹åŠ¡ä¸­ äº‹åŠ¡é›†ä¸­åŒ–ï¼šå°½é‡è®©äº‹åŠ¡çš„æ“ä½œé›†ä¸­åœ¨ä¸€èµ·æ‰§è¡Œï¼Œæ¯”å¦‚éƒ½æ”¾åˆ°æ–¹æ³•æœ€åï¼Œä½¿ç”¨ TransactionTemplate æ‰§è¡Œï¼Œè¿™æ ·å¯ä½¿äº‹åŠ¡æœ€å°åŒ– 8. åŠ¨æ€çº¿ç¨‹æ±  ç›¸å…³ä»£ç ï¼šhttps://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson009\n8.1 ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€çº¿ç¨‹æ±  å¹³æ—¶æˆ‘ä»¬åœ¨å¼€å‘ä¸­ï¼Œåˆ›å»ºäº†ä¸å°‘çº¿ç¨‹æ± ï¼Œè¿™äº›çº¿ç¨‹æ± éƒ½å¤„äºæ¸¸ç¦»çŠ¶æ€ï¼Œä¸æ–¹ä¾¿ç®¡ç†å’Œç›‘æ§ã€‚æ— æ³•çŸ¥é“ç›®å‰ç³»ç»Ÿä¸­æœ‰å“ªäº›çº¿ç¨‹æ± ã€ä»¥åŠæ¯ä¸ªçº¿ç¨‹æ± å½“å‰çš„ä¸€ä¸ªçŠ¶æ€ï¼Œè´Ÿè½½æƒ…å†µç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¼€å‘ä¸€ä¸ªçº¿ç¨‹æ± ç®¡ç†å™¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\n8.2 çº¿ç¨‹æ± ç®¡ç†å™¨ ç»Ÿç®¡ç³»ç»Ÿä¸­æ‰€æœ‰çº¿ç¨‹æ± ï¼Œè´Ÿè´£æ‰€æœ‰çº¿ç¨‹æ± çš„åˆ›å»ºã€ç›‘æ§ç­‰æ“ä½œã€‚\npublic class ThreadPoolManager { /** çº¿ç¨‹æ± Map */ private static Map\u003cString, ThreadPoolTaskExecutor\u003e threadPoolMap = new ConcurrentHashMap\u003cString, ThreadPoolTaskExecutor\u003e(16); /** * åˆ›å»ºæ–°çš„çº¿ç¨‹æ± ï¼Œå¦‚æœçº¿ç¨‹æ± å·²ç»åˆ›å»ºï¼Œè¿”å›å·²ç»åˆ›å»ºçš„çº¿ç¨‹æ±  * * @param name çº¿ç¨‹æ± åç§° * @param corePoolSize æ ¸å¿ƒçº¿ç¨‹æ•° * @param maxPoolSize æœ€å¤§çº¿ç¨‹æ•° * @param queueCapacity é˜Ÿåˆ—å¤§å° * @param keepAliveSeconds çº¿ç¨‹æ± å­˜æ´»æ—¶é—´ï¼ˆç§’ï¼‰ * @param threadFactory çº¿ç¨‹å·¥å‚ * @param rejectedExecutionHandler æ‹’ç»ç­–ç•¥ * @return */ public static ThreadPoolTaskExecutor newThreadPool(String name, int corePoolSize, int maxPoolSize, int queueCapacity, int keepAliveSeconds, ThreadFactory threadFactory, RejectedExecutionHandler rejectedExecutionHandler) { return threadPoolMap.computeIfAbsent(name, threadGroupName -\u003e { ThreadPoolTaskExecutor threadPoolExecutor = new ThreadPoolTaskExecutor() { private boolean initialized = false; // åˆå§‹åŒ–æ ‡è®° @Override protected BlockingQueue\u003cRunnable\u003e createQueue(int queueCapacity) { if (queueCapacity \u003e 0) { // ä½¿ç”¨è‡ªå®šä¹‰çš„ ResizeLinkedBlockingQueue æ›¿ä»£é»˜è®¤é˜Ÿåˆ—ï¼Œä¿è¯èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´é˜Ÿåˆ—å¤§å° return new ResizeLinkedBlockingQueue\u003c\u003e(queueCapacity); } else { // å½“é˜Ÿåˆ—å®¹é‡è®¾ç½®ä¸º0æ—¶ï¼Œä½¿ç”¨ SynchronousQueueã€‚è¡¨ç¤ºä»»åŠ¡å¿…é¡»ç«‹å³è¢«çº¿ç¨‹å¤„ç†ï¼Œå¦åˆ™å°±ä¼šè¢«æ‹’ç» return new SynchronousQueue\u003c\u003e(); } } @Override public void setQueueCapacity(int queueCapacity) { // ç¡®ä¿çº¿ç¨‹æ± å·²åˆå§‹åŒ–ä¸”é˜Ÿåˆ—ç±»å‹æ­£ç¡®æ—¶æ‰è°ƒæ•´å®¹é‡ if (this.initialized \u0026\u0026 this.getThreadPoolExecutor() != null \u0026\u0026 this.getThreadPoolExecutor().getQueue() != null \u0026\u0026 this.getThreadPoolExecutor().getQueue() instanceof ResizeLinkedBlockingQueue) { ((ResizeLinkedBlockingQueue) this.getThreadPoolExecutor().getQueue()).setCapacity(queueCapacity); } super.setQueueCapacity(queueCapacity); } @Override public void afterPropertiesSet() { // ä½¿ç”¨ initialized æ ‡è®°ç¡®ä¿çº¿ç¨‹æ± åªè¢«åˆå§‹åŒ–ä¸€æ¬¡ if (initialized) { return; } super.afterPropertiesSet(); this.initialized = true; } }; // è®¾ç½®å‚æ•° threadPoolExecutor.setCorePoolSize(corePoolSize); ... if (threadFactory != null) { // ThreadFactoryç›¸å½“äºçº¿ç¨‹æ± çš„ä¸€äº›è§„å®š (æ‹›è˜æ ‡å‡†) threadPoolExecutor.setThreadFactory(threadFactory); } if (rejectedExecutionHandler != null) { // æ‹’ç»æ‰§è¡Œçš„ç­–ç•¥ï¼Œä¸Šæ–¹æåˆ°çš„å››ç§æ‹’ç»ç­–ç•¥ threadPoolExecutor.setRejectedExecutionHandler(rejectedExecutionHandler); } threadPoolExecutor.afterPropertiesSet(); return threadPoolExecutor; }); } /** è·å–æ‰€æœ‰çº¿ç¨‹æ± ä¿¡æ¯ */ public static List\u003cThreadPoolInfo\u003e threadPoolInfoList() { return threadPoolMap .entrySet() .stream() .map(entry -\u003e threadPoolInfo(entry.getKey(), entry.getValue())) .collect(Collectors.toList()); } } 8.3 åŠ¨æ€çº¿ç¨‹æ±  åŠ¨æ€çº¿ç¨‹æ± ï¼šæ— éœ€é‡å¯çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å¯¹çº¿ç¨‹æ± è¿›è¡Œæ‰©ç¼©å®¹ï¼Œæ¯”å¦‚æ”¹å˜çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡ã€æœ€å¤§çº¿ç¨‹æ•°é‡ã€é˜Ÿåˆ—å®¹é‡ç­‰ã€‚\n8.3.1 å¸¸ç”¨åŠ¨æ€çº¿ç¨‹æ±  dynamic-tpï¼šhttps://github.com/dromara/dynamic-tp\n8.3.2 æ‰‹åŠ¨å®ç°åŠ¨æ€çº¿ç¨‹æ±  çº¿ç¨‹æ± ä¸­ä¼šç”¨åˆ°Javaä¸­çš„é˜»å¡é˜Ÿåˆ— java.util.concurrent.BlockingQueueï¼Œç›®å‰ jdkä¸­è‡ªå¸¦å‡ ä¸ªé˜»å¡é˜Ÿåˆ—éƒ½ä¸æ”¯æŒåŠ¨æ€æ‰©å®¹ã€‚ æ¯”å¦‚ java.util.concurrent.LinkedBlockingQueueï¼Œå®ƒçš„ capacity æ˜¯ final ä¿®é¥°çš„ï¼Œä¸æ”¯æŒä¿®æ”¹ã€‚\nåŠ¨æ€è°ƒæ•´å¤§å°çš„å‰æï¼šåŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å¤§å°éœ€è¦é˜Ÿåˆ—å®¹é‡èƒ½å¤Ÿæ”¯æŒè°ƒæ•´ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºå¯æ‰©å®¹çš„é˜»å¡é˜Ÿåˆ— ResizeLinkedBlockingQueueã€‚ä»£ç æ˜¯ä»LinkedBlockingQueue ä¸­æ‹·è´è¿‡æ¥çš„ï¼Œå¢åŠ å¯ä¿®æ”¹å®¹é‡ çš„setCapacity æ–¹æ³•ã€‚ç„¶ååˆ›å»ºçº¿ç¨‹æ± çš„æ—¶ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„é˜»å¡é˜Ÿåˆ—ä¾¿å¯ä»¥å®ç°çº¿ç¨‹æ± çš„åŠ¨æ€æ‰©å®¹ã€‚\n/** * è®¾ç½®å®¹é‡ * @param capacity */ public void setCapacity(int capacity) { if (capacity \u003c= 0) throw new IllegalArgumentException(); final ReentrantLock putLock = this.putLock; putLock.lock(); try { if (count.get() \u003e capacity) { throw new IllegalArgumentException(); } this.capacity = capacity; } finally { putLock.unlock(); } } åŠ¨æ€æ›´æ”¹çº¿ç¨‹æ± å¤§å°çš„æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š\npublic class ThreadPoolManager { /** * åŠ¨æ€å˜æ›´çº¿ç¨‹æ± ï¼ˆå¦‚ï¼šæ‰©ç¼©å®¹ã€æ‰©ç¼©é˜Ÿåˆ—å¤§å°ï¼‰ * @param threadPoolChange å˜æ›´çº¿ç¨‹æ± ä¿¡æ¯ */ public static void changeThreadPool(ThreadPoolChange threadPoolChange) { ThreadPoolTaskExecutor threadPoolTaskExecutor = threadPoolMap.get(threadPoolChange.getName()); if (threadPoolTaskExecutor == null) { throw new IllegalArgumentException(); } if (threadPoolChange.getCorePoolSize() \u003e threadPoolChange.getMaxPoolSize()) { throw new IllegalArgumentException(); } synchronized (ThreadPoolManager.class) { // å¢åŠ çº¿ç¨‹æƒ…å†µï¼šéœ€è¦ä¿®æ”¹çš„æœ€å¤§çº¿ç¨‹å¤§äºå½“å‰æ ¸å¿ƒçº¿ç¨‹ï¼Œåˆ™è®¾ç½®å½“å‰æ ¸å¿ƒçº¿ç¨‹ä¸ºä¿®æ”¹åçš„æœ€å¤§çº¿ç¨‹ if (threadPoolChange.getMaxPoolSize() \u003e threadPoolTaskExecutor.getCorePoolSize()) { // å…ˆè°ƒæ•´æœ€å¤§çº¿ç¨‹æ•°ï¼Œå†è°ƒæ•´æ ¸å¿ƒæ•° ï¼ˆå…ˆæ‰©å¤§æ€»é‡ï¼Œå†æ‰©å¤§å±€éƒ¨ï¼‰ threadPoolTaskExecutor.setMaxPoolSize(threadPoolChange.getMaxPoolSize()); threadPoolTaskExecutor.setCorePoolSize(threadPoolChange.getCorePoolSize()); threadPoolTaskExecutor.setQueueCapacity(threadPoolChange.getQueueCapacity()); } else { // å…ˆå‡å°‘å±€éƒ¨ï¼Œå†å‡å°‘æ€»é‡ threadPoolTaskExecutor.setCorePoolSize(threadPoolChange.getCorePoolSize()); threadPoolTaskExecutor.setMaxPoolSize(threadPoolChange.getMaxPoolSize()); threadPoolTaskExecutor.setQueueCapacity(threadPoolChange.getQueueCapacity()); } } } } åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡ 1. SpringBootå®ç°åŠ¨æ€Jobçš„å®æˆ˜ ç›¸å…³ä»£ç ï¼šhttps://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson011\n1.1 Jobè¡¨ - è¡¨ç»“æ„ å­—æ®µå ç±»å‹ å¯ç©º é»˜è®¤ å¤‡æ³¨ id varchar(50) å¦ - idï¼Œä¸»é”® name varchar(100) å¦ - jobåç§°ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªæœ‰æ„ä¹‰çš„åç§° cron varchar(50) å¦ - jobçš„æ‰§è¡Œå‘¨æœŸï¼Œcronè¡¨è¾¾å¼ bean_name varchar(100) å¦ - jobéœ€è¦æ‰§è¡Œé‚£ä¸ªbeanï¼Œå¯¹åº”springä¸­beançš„åç§° bean_method varchar(100) å¦ - jobæ‰§è¡Œçš„beançš„æ–¹æ³• status smallint å¦ 0 jobçš„çŠ¶æ€,0ï¼šåœæ­¢ï¼Œ1ï¼šæ‰§è¡Œä¸­ 1.2 Jobæ‰§è¡Œç®¡ç†å™¨ @Component public class SpringJobRunManager implements CommandLineRunner { // applicationContext ä¸»è¦ç”¨äºåœ¨ä»»åŠ¡æ‰§è¡Œæ—¶åŠ¨æ€è·å–å’Œè°ƒç”¨æŒ‡å®šçš„ Bean å’Œæ–¹æ³•ï¼Œå®ç°çµæ´»çš„ä»»åŠ¡è°ƒåº¦ã€‚ // å¯ä»¥æŠŠå®ƒç†è§£ä¸ºâ€œSpring ç®¡ç†çš„å¯¹è±¡å·¥å‚å’ŒæœåŠ¡æ€»çº¿â€ @Autowired private ApplicationContext applicationContext; // threadPoolTaskScheduler æ˜¯ Spring æä¾›çš„çº¿ç¨‹æ± å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ï¼Œä¸»è¦ç”¨äºåœ¨åº”ç”¨ä¸­ä»¥å¤šçº¿ç¨‹æ–¹å¼æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼ˆå¦‚å®šæ—¶æ‰§è¡Œã€Cronè¡¨è¾¾å¼è°ƒåº¦ç­‰ï¼‰ @Autowired private ThreadPoolTaskScheduler threadPoolTaskScheduler; // jobè¡¨ç›¸å…³æœåŠ¡ @Autowired private JobService jobService; /** * ç³»ç»Ÿé‡æ­£åœ¨è¿è¡Œä¸­çš„jobåˆ—è¡¨ */ private Map\u003cString, SpringJobTask\u003e runningJobMap = new ConcurrentHashMap\u003c\u003e(); /** * springbootåº”ç”¨å¯åŠ¨åä¼šå›è°ƒ * * @param args incoming main method arguments * @throws Exception */ @Override public void run(String... args) throws Exception { //1ã€å¯åŠ¨job this.startAllJob(); //2ã€ç›‘æ§dbä¸­jobçš„å˜åŒ–ï¼ˆjobå¢ã€åˆ ã€æ”¹ï¼‰ï¼Œç„¶ååŒæ­¥ç»™jobæ‰§è¡Œå™¨å»æ‰§è¡Œ this.monitorDbJobChange(); } } Springbootåº”ç”¨å¯åŠ¨ä¹‹åä¼šå›è°ƒ CommandLineRunner ä¸­çš„ run æ–¹æ³•ï¼Œä¾æ¬¡å¯åŠ¨jobï¼Œå¹¶ç›‘æ§jobä¸­çš„å˜åŒ–ã€‚\n1.2.1 å¯åŠ¨job å¯åŠ¨jobçš„æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ä»æ•°æ®åº“ä¸­æ‰¾å‡ºæ‰€æœ‰éœ€è¦å¯åŠ¨çš„jobï¼ˆçŠ¶æ€ä¸ºstartï¼‰ï¼Œç„¶åå¾ªç¯å¯åŠ¨ã€‚\nå¯åŠ¨jobå…·ä½“æ–¹å¼å¦‚ä¸‹ï¼š\nprivate void startAllJob() { List\u003cJob\u003e jobList = this.jobService.getStartJobList(); for (Job job : jobList) { this.startJob(job); } } /** * å¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼ˆjobï¼‰ * * @param job éœ€è¦å¯åŠ¨çš„ä»»åŠ¡å¯¹è±¡ */ private void startJob(Job job) { // 1. åˆ›å»ºä»»åŠ¡æ‰§è¡Œä½“ï¼Œæ³¨å…¥Springä¸Šä¸‹æ–‡ï¼Œä¾¿äºä»»åŠ¡å†…è·å–Beanå¯¹è±¡ SpringJobTask springJobTask = new SpringJobTask(job, this.applicationContext); // 2. æ ¹æ®jobçš„cronè¡¨è¾¾å¼åˆ›å»ºè°ƒåº¦è§¦å‘å™¨ CronTrigger trigger = new CronTrigger(job.getCron()); // 3. ä½¿ç”¨çº¿ç¨‹æ± è°ƒåº¦å™¨æ³¨å†Œä»»åŠ¡ï¼Œè¿”å›è°ƒåº¦å¥æŸ„ ScheduledFuture\u003c?\u003e scheduledFuture = this.threadPoolTaskScheduler.schedule(springJobTask, trigger); // 4. è®°å½•è°ƒåº¦å¥æŸ„åˆ°ä»»åŠ¡å¯¹è±¡ï¼Œä¾¿äºåç»­å–æ¶ˆ -\u003e springJobTask.setScheduledFuture(scheduledFuture); // 5. å°†ä»»åŠ¡æ”¾å…¥è¿è¡Œä¸­çš„ä»»åŠ¡Mapï¼Œæ–¹ä¾¿ç®¡ç†å’ŒæŸ¥æ‰¾ runningJobMap.put(job.getId(), springJobTask); // 6. è®°å½•æ—¥å¿—ï¼Œæ–¹ä¾¿è¿½è¸ª logger.info(\"å¯åŠ¨ job æˆåŠŸ:{}\", JSONUtil.toJsonStr(job)); } /** * åˆ é™¤ï¼ˆåœæ­¢ï¼‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ * @param job éœ€è¦åˆ é™¤çš„ä»»åŠ¡å¯¹è±¡ */ private void deleteJob(Job job) { if (job == null) { return; } // 1. ä»è¿è¡Œä¸­çš„ä»»åŠ¡Mapè·å–ä»»åŠ¡ SpringJobTask springJobTask = this.runningJobMap.get(job.getId()); if (springJobTask == null) { return;} // 2. å–æ¶ˆä»»åŠ¡è°ƒåº¦ï¼ˆåœæ­¢å®šæ—¶æ‰§è¡Œï¼‰ springJobTask.getScheduledFuture().cancel(false); // 3. ä»Mapä¸­ç§»é™¤è¯¥ä»»åŠ¡ runningJobMap.remove(job.getId()); // 4. è®°å½•æ—¥å¿— logger.info(\"ç§»é™¤ job æˆåŠŸ:{}\", JSONUtil.toJsonStr(job)); } /** * æ›´æ–°ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼ˆå…ˆåˆ é™¤å†å¯åŠ¨ï¼‰ * @param job éœ€è¦æ›´æ–°çš„ä»»åŠ¡å¯¹è±¡ */ public void updateJob(Job job) { // 1. å…ˆåˆ é™¤æ—§çš„ä»»åŠ¡ this.deleteJob(job); // 2. å†å¯åŠ¨æ–°çš„ä»»åŠ¡ this.startJob(job); // 3. è®°å½•æ—¥å¿— logger.info(\"æ›´æ–° job æˆåŠŸ:{}\", JSONUtil.toJsonStr(job)); } 1.2.2 åŠ¨æ€ç›‘æ§DBä¸­jobçš„å˜åŒ– /** * ç›‘æ§dbä¸­jobçš„å˜åŒ–ï¼Œæ¯5ç§’ç›‘æ§ä¸€æ¬¡ï¼Œè¿™ä¸ªé¢‘ç‡å¤§å®¶ä½¿ç”¨çš„æ—¶å€™å¯ä»¥ç¨å¾®è°ƒå¤§ç‚¹ */ private void monitorDbJobChange() { this.threadPoolTaskScheduler.scheduleWithFixedDelay(this::jobChangeDispose, Duration.ofSeconds(5)); } // ä»»åŠ¡å˜åŒ–å¤„ç† private void jobChangeDispose() { //1ã€ä»dbä¸­æ‹¿åˆ°æ‰€æœ‰jobï¼Œå’Œç›®å‰å†…å­˜ä¸­æ­£åœ¨è¿è¡Œçš„æ‰€æœ‰jobå¯¹æ¯”ï¼Œå¯å¾—åˆ°æœ¬æ¬¡æ–°å¢çš„jobã€åˆ é™¤çš„jobã€æ›´æ–°çš„job JobChange jobChange = this.getJobChange(); //2ã€å¤„ç†æ–°å¢çš„job for (Job job : jobChange.getAddJobList()) { this.startJob(job);} //3ã€å¤„ç†åˆ é™¤çš„job for (Job job : jobChange.getDeleteJobList()) { this.deleteJob(job);} //4ã€å¤„ç†å˜åŒ–çš„job for (Job job : jobChange.getUpdateJobList()) { this.updateJob(job);} } private JobChange getJobChange() { //æ–°å¢çš„job List\u003cJob\u003e addJobList = new ArrayList\u003c\u003e(); //åˆ é™¤çš„job List\u003cJob\u003e deleteJobList = new ArrayList\u003c\u003e(); //æ›´æ–°çš„job List\u003cJob\u003e updateJobList = new ArrayList\u003c\u003e(); //ä»dbä¸­æ‹¿åˆ°æ‰€æœ‰jobï¼Œå’Œç›®å‰å†…å­˜ä¸­æ­£åœ¨è¿è¡Œçš„æ‰€æœ‰jobå¯¹æ¯”ï¼Œå¯å¾—åˆ°æœ¬æ¬¡æ–°å¢çš„jobã€åˆ é™¤çš„jobã€æ›´æ–°çš„job List\u003cJob\u003e startJobList = this.jobService.getStartJobList(); for (Job job : startJobList) { SpringJobTask springJobTask = runningJobMap.get(job.getId()); if (springJobTask == null) { addJobList.add(job); } else { //jobçš„æ‰§è¡Œè§„åˆ™å˜äº† if (jobIsChange(job, springJobTask.getJob())) { updateJobList.add(job); } } } //è·å–è¢«åˆ é™¤çš„jobï¼ŒspringJobTaskMapä¸­å­˜åœ¨çš„ï¼Œè€ŒstartJobListä¸å­˜åœ¨çš„ï¼Œåˆ™æ˜¯éœ€è¦ä»å½“å‰è¿è¡Œåˆ—è¡¨ä¸­åœæ­¢ç§»é™¤çš„ Set\u003cString\u003e startJobIdList = CollUtils.convertSet(startJobList, Job::getId); for (Map.Entry\u003cString, SpringJobTask\u003e springJobTaskEntry : runningJobMap.entrySet()) { if (!startJobIdList.contains(springJobTaskEntry.getKey())) { deleteJobList.add(springJobTaskEntry.getValue().getJob()); } } //è¿”å›jobå˜æ›´ç»“æœ return new JobChange(addJobList, updateJobList, deleteJobList); } /** * æ£€æµ‹ä¸¤ä¸ªjobæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œï¼ˆcronã€beanNameã€beanMethodï¼‰ä¸­æœ‰ä»»æ„ä¸€é¡¹å˜åŠ¨äº†ï¼Œåˆ™è¿”å›true * * @param job1 * @param job2 * @return */ private boolean jobIsChange(Job job1, Job job2) { return !(Objects.equals(job1.getCron(), job2.getCron()) \u0026\u0026 Objects.equals(job1.getBeanName(), job2.getBeanName()) \u0026\u0026 Objects.equals(job1.getBeanMethod(), job2.getBeanMethod())); } ",
  "wordCount" : "2159",
  "inLanguage": "en",
  "image": "https://swimmingliu.cn/papermod-cover.png","datePublished": "2025-07-06T13:27:35+08:00",
  "dateModified": "2025-07-06T13:27:35+08:00",
  "author":[{
    "@type": "Person",
    "name": "SwimmingLiu"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://swimmingliu.cn/posts/job/java-scene-quiz-100/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "SwimmingLiu's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://swimmingliu.cn/images/swimmingliu_icon.png"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://swimmingliu.cn/" accesskey="h" title="ğ“¢ğ”€ğ“²ğ“¶ğ“¶ğ“²ğ“·ğ“°ğ“›ğ“²ğ“¾&#39;ğ“¼ ğ“‘ğ“µğ“¸ğ“° (Alt + H)">
                <img src="https://swimmingliu.cn/images/swimmingliu_icon.png" alt="" aria-label="logo"
                    height="30">ğ“¢ğ”€ğ“²ğ“¶ğ“¶ğ“²ğ“·ğ“°ğ“›ğ“²ğ“¾&#39;ğ“¼ ğ“‘ğ“µğ“¸ğ“°</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://swimmingliu.cn/index.html" title="ğŸ¡ Home">
                    <span>ğŸ¡ Home</span>
                </a>
            </li>
            <li>
                <a href="https://swimmingliu.cn/search/" title="ğŸ” Search">
                    <span>ğŸ” Search</span>
                </a>
            </li>
            <li>
                <a href="https://swimmingliu.cn/posts/" title="ğŸ—’ï¸ Posts">
                    <span>ğŸ—’ï¸ Posts</span>
                </a>
            </li>
            <li>
                <a href="https://swimmingliu.cn/archives/" title="ğŸ“ƒ Archive">
                    <span>ğŸ“ƒ Archive</span>
                </a>
            </li>
            <li>
                <a href="https://swimmingliu.cn/tags/" title="ğŸ“‘ Tags">
                    <span>ğŸ“‘ Tags</span>
                </a>
            </li>
            <li>
                <a href="https://bento.me/swimmingliu" title="ğŸ‘¨ğŸ»â€ğŸ“ About Me">
                    <span>ğŸ‘¨ğŸ»â€ğŸ“ About Me</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://www.emojisearch.app/" title="Emoji">
                    <span>Emoji</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://swimmingliu.cn/">Home</a>&nbsp;Â»&nbsp;<a href="https://swimmingliu.cn/posts/">ğŸ“š Posts</a>&nbsp;Â»&nbsp;<a href="https://swimmingliu.cn/posts/job/">ğŸ’» Job</a></div>
    <h1 class="post-title entry-hint-parent">
      Javaåœºæ™¯100é¢˜
    </h1>
    <div class="post-meta"><span title='2025-07-06 13:27:35 +0800 CST'>July 6, 2025</span>&nbsp;Â·&nbsp;11 min&nbsp;Â·&nbsp;SwimmingLiu

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%b9%b6%e5%8f%91%e4%b8%8e%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96" aria-label="å¹¶å‘ä¸æ€§èƒ½ä¼˜åŒ–">å¹¶å‘ä¸æ€§èƒ½ä¼˜åŒ–</a><ul>
                        
                <li>
                    <a href="#1-%e5%a4%a7%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0%e5%a6%82%e4%bd%95%e5%a4%84%e7%90%86%e5%88%86%e7%89%87%e4%b8%8a%e4%bc%a0" aria-label="1. å¤§æ–‡ä»¶ä¸Šä¼ å¦‚ä½•å¤„ç†ï¼Ÿåˆ†ç‰‡ä¸Šä¼ ">1. å¤§æ–‡ä»¶ä¸Šä¼ å¦‚ä½•å¤„ç†ï¼Ÿåˆ†ç‰‡ä¸Šä¼ </a><ul>
                        
                <li>
                    <a href="#11-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%88%86%e7%89%87%e4%b8%8a%e4%bc%a0" aria-label="1.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ä¸Šä¼ ?">1.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ä¸Šä¼ ?</a></li>
                <li>
                    <a href="#12-%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e5%88%86%e7%89%87%e4%b8%8a%e4%bc%a0" aria-label="1.2 å¦‚ä½•å®ç°åˆ†ç‰‡ä¸Šä¼ ï¼Ÿ">1.2 å¦‚ä½•å®ç°åˆ†ç‰‡ä¸Šä¼ ï¼Ÿ</a><ul>
                        
                <li>
                    <a href="#121-%e5%a6%82%e4%bd%95%e5%ad%98%e5%82%a8%e5%88%86%e7%89%87%e4%bf%a1%e6%81%af" aria-label="1.2.1 å¦‚ä½•å­˜å‚¨åˆ†ç‰‡ä¿¡æ¯">1.2.1 å¦‚ä½•å­˜å‚¨åˆ†ç‰‡ä¿¡æ¯</a></li>
                <li>
                    <a href="#122-%e5%a6%82%e4%bd%95%e5%ae%9a%e4%b9%89%e5%88%86%e5%9d%97%e4%b8%8a%e4%bc%a0%e6%8e%a5%e5%8f%a3" aria-label="1.2.2 å¦‚ä½•å®šä¹‰åˆ†å—ä¸Šä¼ æ¥å£">1.2.2 å¦‚ä½•å®šä¹‰åˆ†å—ä¸Šä¼ æ¥å£</a></li></ul>
                </li>
                <li>
                    <a href="#13-%e5%a6%82%e6%9e%9c%e4%b8%8a%e4%bc%a0%e8%bf%87%e7%a8%8b%e4%b8%ad%e5%87%ba%e7%8e%b0%e6%95%85%e9%9a%9c%e5%a6%82%e4%bd%95%e5%a4%84%e7%90%86" aria-label="1.3 å¦‚æœä¸Šä¼ è¿‡ç¨‹ä¸­ï¼Œå‡ºç°æ•…éšœå¦‚ä½•å¤„ç†ï¼Ÿ">1.3 å¦‚æœä¸Šä¼ è¿‡ç¨‹ä¸­ï¼Œå‡ºç°æ•…éšœå¦‚ä½•å¤„ç†ï¼Ÿ</a><ul>
                        
                <li>
                    <a href="#%e6%83%85%e5%86%b51%e6%b5%8f%e8%a7%88%e5%99%a8%e6%97%a0%e6%b3%95%e8%af%bb%e5%8f%96%e5%88%9a%e6%89%8d%e7%94%a8%e6%88%b7%e9%80%89%e6%8b%a9%e7%9a%84%e6%96%87%e4%bb%b6%e4%ba%86" aria-label="æƒ…å†µ1ï¼šæµè§ˆå™¨æ— æ³•è¯»å–åˆšæ‰ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶äº†">æƒ…å†µ1ï¼šæµè§ˆå™¨æ— æ³•è¯»å–åˆšæ‰ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶äº†</a></li>
                <li>
                    <a href="#%e6%83%85%e5%86%b52%e6%b5%8f%e8%a7%88%e5%99%a8%e5%8f%af%e4%bb%a5%e7%bb%a7%e7%bb%ad%e8%af%bb%e5%8f%96%e5%88%9a%e6%89%8d%e7%94%a8%e6%88%b7%e9%80%89%e6%8b%a9%e7%9a%84%e6%96%87%e4%bb%b6" aria-label="æƒ…å†µ2ï¼šæµè§ˆå™¨å¯ä»¥ç»§ç»­è¯»å–åˆšæ‰ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶">æƒ…å†µ2ï¼šæµè§ˆå™¨å¯ä»¥ç»§ç»­è¯»å–åˆšæ‰ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#2-%e5%a4%9a%e7%ba%bf%e7%a8%8b%e4%bb%bb%e5%8a%a1%e6%89%b9%e5%a4%84%e7%90%86%e9%80%9a%e7%94%a8%e5%b7%a5%e5%85%b7%e7%b1%bb" aria-label="2. å¤šçº¿ç¨‹ä»»åŠ¡æ‰¹å¤„ç†é€šç”¨å·¥å…·ç±»">2. å¤šçº¿ç¨‹ä»»åŠ¡æ‰¹å¤„ç†é€šç”¨å·¥å…·ç±»</a></li>
                <li>
                    <a href="#3-%e6%8e%a5%e5%8f%a3%e6%80%a7%e8%83%bd%e5%8e%8b%e5%8a%9b%e6%b5%8b%e8%af%95%e5%b7%a5%e5%85%b7" aria-label="3. æ¥å£æ€§èƒ½å‹åŠ›æµ‹è¯•å·¥å…·">3. æ¥å£æ€§èƒ½å‹åŠ›æµ‹è¯•å·¥å…·</a><ul>
                        
                <li>
                    <a href="#31-%e5%b8%b8%e7%94%a8%e5%8e%8b%e6%b5%8b%e5%b7%a5%e5%85%b7%e7%b1%bb" aria-label="3.1 å¸¸ç”¨å‹æµ‹å·¥å…·ç±»">3.1 å¸¸ç”¨å‹æµ‹å·¥å…·ç±»</a></li>
                <li>
                    <a href="#32-%e6%89%8b%e5%86%99%e5%8e%8b%e6%b5%8b%e5%b7%a5%e5%85%b7%e7%b1%bb" aria-label="3.2 æ‰‹å†™å‹æµ‹å·¥å…·ç±»">3.2 æ‰‹å†™å‹æµ‹å·¥å…·ç±»</a></li></ul>
                </li>
                <li>
                    <a href="#4-semaphore%e5%ae%9e%e7%8e%b0%e6%8e%a5%e5%8f%a3%e9%99%90%e6%b5%81" aria-label="4. Semaphoreå®ç°æ¥å£é™æµ">4. Semaphoreå®ç°æ¥å£é™æµ</a></li>
                <li>
                    <a href="#5-%e5%b9%b6%e8%a1%8c%e6%9f%a5%e8%af%a2---%e6%8f%90%e4%ba%a4%e6%8e%a5%e5%8f%a3%e5%93%8d%e5%ba%94%e9%80%9f%e5%ba%a6" aria-label="5. å¹¶è¡ŒæŸ¥è¯¢ - æäº¤æ¥å£å“åº”é€Ÿåº¦">5. å¹¶è¡ŒæŸ¥è¯¢ - æäº¤æ¥å£å“åº”é€Ÿåº¦</a><ul>
                        
                <li>
                    <a href="#51--%e5%b8%b8%e8%a7%84%e5%81%9a%e6%b3%95" aria-label="5.1  å¸¸è§„åšæ³•">5.1  å¸¸è§„åšæ³•</a></li>
                <li>
                    <a href="#52-%e4%bd%bf%e7%94%a8%e7%ba%bf%e7%a8%8b%e6%b1%a0%e5%b9%b6%e8%a1%8c%e6%9f%a5%e8%af%a2%e5%95%86%e5%93%81%e4%bf%a1%e6%81%af" aria-label="5.2 ä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡ŒæŸ¥è¯¢å•†å“ä¿¡æ¯">5.2 ä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡ŒæŸ¥è¯¢å•†å“ä¿¡æ¯</a></li></ul>
                </li>
                <li>
                    <a href="#6-%e5%b9%b6%e8%a1%8c%e6%9f%a5%e8%af%a2%e5%8f%af%e8%83%bd%e5%ad%98%e5%9c%a8%e7%9a%84%e9%97%ae%e9%a2%98%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3" aria-label="6. å¹¶è¡ŒæŸ¥è¯¢å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ">6. å¹¶è¡ŒæŸ¥è¯¢å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ</a><ul>
                        
                <li>
                    <a href="#61-%e5%b9%b6%e8%a1%8c%e6%9f%a5%e8%af%a2%e4%b8%ad%e5%ad%98%e5%9c%a8%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="6.1 å¹¶è¡ŒæŸ¥è¯¢ä¸­å­˜åœ¨çš„é—®é¢˜">6.1 å¹¶è¡ŒæŸ¥è¯¢ä¸­å­˜åœ¨çš„é—®é¢˜</a></li>
                <li>
                    <a href="#62-%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3%e5%b9%b6%e8%a1%8c%e6%9f%a5%e8%af%a2%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="6.2 å¦‚ä½•è§£å†³å¹¶è¡ŒæŸ¥è¯¢çš„é—®é¢˜">6.2 å¦‚ä½•è§£å†³å¹¶è¡ŒæŸ¥è¯¢çš„é—®é¢˜</a></li></ul>
                </li>
                <li>
                    <a href="#7-%e6%8e%a5%e5%8f%a3%e6%80%a7%e8%83%bd%e8%b0%83%e4%bc%98%e4%b9%8b%e5%a4%a7-%e9%95%bf-%e4%ba%8b%e5%8a%a1%e4%bc%98%e5%8c%96" aria-label="7. æ¥å£æ€§èƒ½è°ƒä¼˜ä¹‹å¤§ (é•¿) äº‹åŠ¡ä¼˜åŒ–">7. æ¥å£æ€§èƒ½è°ƒä¼˜ä¹‹å¤§ (é•¿) äº‹åŠ¡ä¼˜åŒ–</a><ul>
                        
                <li>
                    <a href="#71-%e5%a4%a7%e9%95%bf%e4%ba%8b%e5%8a%a1%e6%89%80%e5%b8%a6%e6%9d%a5%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="7.1 å¤§(é•¿)äº‹åŠ¡æ‰€å¸¦æ¥çš„é—®é¢˜">7.1 å¤§(é•¿)äº‹åŠ¡æ‰€å¸¦æ¥çš„é—®é¢˜</a></li>
                <li>
                    <a href="#72-%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3%e5%a4%a7-%e9%95%bf-%e4%ba%8b%e5%8a%a1%e7%9a%84%e9%97%ae%e9%a2%98-%e6%8b%86%e5%88%86%e4%b8%ba%e5%b0%8f%e4%ba%8b%e5%8a%a1" aria-label="7.2 å¦‚ä½•è§£å†³å¤§ (é•¿) äº‹åŠ¡çš„é—®é¢˜ (æ‹†åˆ†ä¸ºå°äº‹åŠ¡)">7.2 å¦‚ä½•è§£å†³å¤§ (é•¿) äº‹åŠ¡çš„é—®é¢˜ (æ‹†åˆ†ä¸ºå°äº‹åŠ¡)</a></li></ul>
                </li>
                <li>
                    <a href="#8-%e5%8a%a8%e6%80%81%e7%ba%bf%e7%a8%8b%e6%b1%a0" aria-label="8. åŠ¨æ€çº¿ç¨‹æ± ">8. åŠ¨æ€çº¿ç¨‹æ± </a><ul>
                        
                <li>
                    <a href="#81-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%8a%a8%e6%80%81%e7%ba%bf%e7%a8%8b%e6%b1%a0" aria-label="8.1 ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€çº¿ç¨‹æ± ">8.1 ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€çº¿ç¨‹æ± </a></li>
                <li>
                    <a href="#82-%e7%ba%bf%e7%a8%8b%e6%b1%a0%e7%ae%a1%e7%90%86%e5%99%a8" aria-label="8.2 çº¿ç¨‹æ± ç®¡ç†å™¨">8.2 çº¿ç¨‹æ± ç®¡ç†å™¨</a></li>
                <li>
                    <a href="#83-%e5%8a%a8%e6%80%81%e7%ba%bf%e7%a8%8b%e6%b1%a0" aria-label="8.3 åŠ¨æ€çº¿ç¨‹æ± ">8.3 åŠ¨æ€çº¿ç¨‹æ± </a><ul>
                        
                <li>
                    <a href="#831-%e5%b8%b8%e7%94%a8%e5%8a%a8%e6%80%81%e7%ba%bf%e7%a8%8b%e6%b1%a0" aria-label="8.3.1 å¸¸ç”¨åŠ¨æ€çº¿ç¨‹æ± ">8.3.1 å¸¸ç”¨åŠ¨æ€çº¿ç¨‹æ± </a></li>
                <li>
                    <a href="#832-%e6%89%8b%e5%8a%a8%e5%ae%9e%e7%8e%b0%e5%8a%a8%e6%80%81%e7%ba%bf%e7%a8%8b%e6%b1%a0" aria-label="8.3.2 æ‰‹åŠ¨å®ç°åŠ¨æ€çº¿ç¨‹æ± ">8.3.2 æ‰‹åŠ¨å®ç°åŠ¨æ€çº¿ç¨‹æ± </a></li></ul>
                </li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e4%b8%8e%e5%be%ae%e6%9c%8d%e5%8a%a1" aria-label="åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡">åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡</a><ul>
                        
                <li>
                    <a href="#1-springboot%e5%ae%9e%e7%8e%b0%e5%8a%a8%e6%80%81job%e7%9a%84%e5%ae%9e%e6%88%98" aria-label="1. SpringBootå®ç°åŠ¨æ€Jobçš„å®æˆ˜">1. SpringBootå®ç°åŠ¨æ€Jobçš„å®æˆ˜</a><ul>
                        
                <li>
                    <a href="#11-job%e8%a1%a8---%e8%a1%a8%e7%bb%93%e6%9e%84" aria-label="1.1 Jobè¡¨ - è¡¨ç»“æ„">1.1 Jobè¡¨ - è¡¨ç»“æ„</a></li>
                <li>
                    <a href="#12-job%e6%89%a7%e8%a1%8c%e7%ae%a1%e7%90%86%e5%99%a8" aria-label="1.2 Jobæ‰§è¡Œç®¡ç†å™¨">1.2 Jobæ‰§è¡Œç®¡ç†å™¨</a><ul>
                        
                <li>
                    <a href="#121-%e5%90%af%e5%8a%a8job" aria-label="1.2.1 å¯åŠ¨job">1.2.1 å¯åŠ¨job</a></li>
                <li>
                    <a href="#122-%e5%8a%a8%e6%80%81%e7%9b%91%e6%8e%a7db%e4%b8%adjob%e7%9a%84%e5%8f%98%e5%8c%96" aria-label="1.2.2 åŠ¨æ€ç›‘æ§DBä¸­jobçš„å˜åŒ–">1.2.2 åŠ¨æ€ç›‘æ§DBä¸­jobçš„å˜åŒ–</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>
  <div class="post-content"><h1 id="å¹¶å‘ä¸æ€§èƒ½ä¼˜åŒ–">å¹¶å‘ä¸æ€§èƒ½ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#å¹¶å‘ä¸æ€§èƒ½ä¼˜åŒ–">#</a></h1>
<h2 id="1-å¤§æ–‡ä»¶ä¸Šä¼ å¦‚ä½•å¤„ç†åˆ†ç‰‡ä¸Šä¼ ">1. å¤§æ–‡ä»¶ä¸Šä¼ å¦‚ä½•å¤„ç†ï¼Ÿåˆ†ç‰‡ä¸Šä¼ <a hidden class="anchor" aria-hidden="true" href="#1-å¤§æ–‡ä»¶ä¸Šä¼ å¦‚ä½•å¤„ç†åˆ†ç‰‡ä¸Šä¼ ">#</a></h2>
<p>ç›¸å…³ä»£ç ï¼š<a href="https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson001">https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson001</a></p>
<h3 id="11-ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ä¸Šä¼ ">1.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ä¸Šä¼ ?<a hidden class="anchor" aria-hidden="true" href="#11-ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ä¸Šä¼ ">#</a></h3>
<p>å¤§æ–‡ä»¶åœ¨ä¸Šä¼ çš„è¿‡ç¨‹ä¸­ï¼Œè€—è´¹çš„æ—¶é—´æ¯”è¾ƒé•¿ã€‚å¦‚æœç½‘ç»œä¸ç¨³å®šï¼Œå¾ˆå¯èƒ½å¯¼è‡´ä¸Šä¼ å¤±è´¥ï¼Œéœ€è¦é‡æ–°ä¸Šä¼ ã€‚åˆ†ç‰‡ä¸Šä¼ ï¼Œå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p><strong>åˆ†ç‰‡ä¸Šä¼ å®šä¹‰</strong>ï¼šå°†å¤§æ–‡ä»¶æ‹†åˆ†ä¸ºä¸åŒçš„æ–‡ä»¶å—ï¼Œé€å—è¿›è¡Œä¸Šä¼ </p>
<h3 id="12-å¦‚ä½•å®ç°åˆ†ç‰‡ä¸Šä¼ ">1.2 å¦‚ä½•å®ç°åˆ†ç‰‡ä¸Šä¼ ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#12-å¦‚ä½•å®ç°åˆ†ç‰‡ä¸Šä¼ ">#</a></h3>
<h4 id="121-å¦‚ä½•å­˜å‚¨åˆ†ç‰‡ä¿¡æ¯">1.2.1 å¦‚ä½•å­˜å‚¨åˆ†ç‰‡ä¿¡æ¯<a hidden class="anchor" aria-hidden="true" href="#121-å¦‚ä½•å­˜å‚¨åˆ†ç‰‡ä¿¡æ¯">#</a></h4>
<p>åˆ†ç‰‡ä¸Šä¼ éœ€è¦è®°å½•æ–‡ä»¶çš„å±æ€§ (md5ã€å¤§å°ã€åç§°)ã€åˆ†ç‰‡æ•°é‡ã€æ–‡ä»¶å­˜å‚¨çš„å®Œæ•´è·¯å¾„ (æœ¬åœ°è·¯å¾„)ï¼Œè¿˜éœ€è¦è®°å½•æ¯ä¸ªåˆ†å—çš„ä¸Šä¼ æƒ…å†µ (åˆ†å—å¤§å°ã€åˆ†å—é¡ºåºã€åˆ†å—ä»»åŠ¡id)ã€‚å¯ä»¥ç”¨ <strong>åˆ†å—ä¸Šä¼ ä»»åŠ¡è¡¨</strong> å’Œ <strong>åˆ†å—æ–‡ä»¶è¡¨</strong> æ¥è®°å½•ã€‚</p>
<ol>
<li>
<p><strong>åˆ†å—ä»»åŠ¡è¡¨ (t_shard_upload)</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">t_shard_upload</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">file_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æ–‡ä»¶åç§°&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">part_num</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;åˆ†ç‰‡æ•°é‡&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">md5</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æ–‡ä»¶md5å€¼&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">file_full_path</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æ–‡ä»¶å®Œæ•´è·¯å¾„&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;åˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡è¡¨&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p><strong>åˆ†å—æ–‡ä»¶è¡¨ (t_shard_upload_partï¼‰</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w">  </span><span class="n">t_shard_upload_part</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shard_upload_id</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;åˆ†ç‰‡ä»»åŠ¡idï¼ˆt_shard_upload.idï¼‰&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">part_order</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;ç¬¬å‡ ä¸ªåˆ†ç‰‡ï¼Œä»1å¼€å§‹&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">file_full_path</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;æ–‡ä»¶å®Œæ•´è·¯å¾„&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">uq_part_order</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">shard_upload_id</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">part_order</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;åˆ†ç‰‡æ–‡ä»¶è¡¨ï¼Œæ¯ä¸ªåˆ†ç‰‡æ–‡ä»¶å¯¹åº”ä¸€æ¡è®°å½•&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
</ol>
<p>åˆ†å—æ–‡ä»¶è¡¨å’Œåˆ†å—ä¸Šä¼ è¡¨æ˜¯ <strong>1 to M</strong> çš„å…³ç³»ï¼Œå‡å¦‚å½“å‰æ–‡ä»¶åˆ†ä¸º<strong>10</strong>å—ã€‚åˆ™ä¼šå‡ºç°<strong>1</strong>ä¸ªåˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡ï¼Œå’Œ<strong>10</strong>ä¸ªåˆ†ç‰‡æ–‡ä»¶è®°å½•ã€‚</p>
<h4 id="122-å¦‚ä½•å®šä¹‰åˆ†å—ä¸Šä¼ æ¥å£">1.2.2 å¦‚ä½•å®šä¹‰åˆ†å—ä¸Šä¼ æ¥å£<a hidden class="anchor" aria-hidden="true" href="#122-å¦‚ä½•å®šä¹‰åˆ†å—ä¸Šä¼ æ¥å£">#</a></h4>
<p>åˆ†å—ä¸Šä¼ å¯ä»¥åˆ†ä¸ºä¸‹é¢ 5 ä¸ªæ¥å£</p>
<ol>
<li>**åˆ›å»ºåˆ†ç‰‡ä¸Šä¼ ä»»åŠ¡æ¥å£ ** (<code>/shardUpload/init</code>)
<ul>
<li>å…¥å‚ï¼šæ–‡ä»¶åç§°ã€æ–‡ä»¶å¤§å°ã€æ–‡ä»¶md5</li>
<li>å‡ºå‚ï¼šä»»åŠ¡idã€åˆ†ç‰‡æ•°é‡</li>
<li>å®ç°ï¼šè®¡ç®—åˆ†ç‰‡æ•°é‡ï¼Œåˆ›å»ºåˆ†ç‰‡ä»»åŠ¡</li>
</ul>
</li>
<li><strong>ä¸Šä¼ åˆ†ç‰‡æ–‡ä»¶</strong> (<code>/shardUpload/uploadPart</code>)
<ul>
<li>å…¥å‚ï¼šMultiPartFile æ–‡ä»¶</li>
<li>å‡ºå‚ ï¼šåˆ†ç‰‡æ–‡ä»¶è®°å½•idã€ä»»åŠ¡id</li>
<li>å®ç°ï¼šå­˜å…¥æ–‡ä»¶åˆ°ç£ç›˜è‡ªåŠ¨ä½ç½®ï¼Œåˆ›å»ºåˆ†ç‰‡æ–‡ä»¶è®°å½•</li>
</ul>
</li>
<li>åˆå¹¶åˆ†ç‰‡ã€å®Œæˆä¸Šä¼  (<code>/shardUpload/complete</code>)
<ul>
<li>å…¥å‚ï¼šä»»åŠ¡id</li>
<li>å‡ºå‚ï¼šå¸ƒå°”å€¼</li>
<li>å®ç°ï¼šæŒ‰ç…§é¡ºåºåˆå¹¶æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶</li>
</ul>
</li>
<li>è·å–åˆ†ç‰‡ä»»åŠ¡è¯¦ç»†ä¿¡æ¯(<code>/shardUpload/detail</code>)
<ul>
<li>å…¥å‚ï¼šä»»åŠ¡id ã€æ–‡ä»¶md5 (äºŒé€‰ä¸€)</li>
<li>å‡ºå‚ï¼šä»»åŠ¡è¿›åº¦ã€æ–‡ä»¶åç§°ã€æ–‡ä»¶md5</li>
<li>å®ç°ï¼šè¯»å–åˆ†ç‰‡æ–‡ä»¶è¡¨æŸ¥çœ‹ä¸Šä¼ æƒ…å†µ</li>
<li>åŠŸèƒ½ï¼šè·å–åˆ†ç‰‡ä»»åŠ¡çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¦‚åˆ†ç‰‡ä»»åŠ¡æ˜¯å¦ä¸Šä¼ å®Œæ¯•ï¼Œå“ªäº›åˆ†ç‰‡å·²ä¸Šä¼ ç­‰ä¿¡æ¯ï¼Œç½‘ç»œå‡ºç°æ•…éšœï¼Œå¯ä»¥å€ŸåŠ©æ­¤æ¥å£æ¢å¤ä¸Šä¼ </li>
</ul>
</li>
</ol>
<h3 id="13-å¦‚æœä¸Šä¼ è¿‡ç¨‹ä¸­å‡ºç°æ•…éšœå¦‚ä½•å¤„ç†">1.3 å¦‚æœä¸Šä¼ è¿‡ç¨‹ä¸­ï¼Œå‡ºç°æ•…éšœå¦‚ä½•å¤„ç†ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#13-å¦‚æœä¸Šä¼ è¿‡ç¨‹ä¸­å‡ºç°æ•…éšœå¦‚ä½•å¤„ç†">#</a></h3>
<h4 id="æƒ…å†µ1æµè§ˆå™¨æ— æ³•è¯»å–åˆšæ‰ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶äº†">æƒ…å†µ1ï¼šæµè§ˆå™¨æ— æ³•è¯»å–åˆšæ‰ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶äº†<a hidden class="anchor" aria-hidden="true" href="#æƒ…å†µ1æµè§ˆå™¨æ— æ³•è¯»å–åˆšæ‰ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶äº†">#</a></h4>
<p>æ­¤æ—¶éœ€è¦ç”¨æˆ·é‡æ–°é€‰æ‹©æ–‡ä»¶ï¼Œé‡æ–°ä¸Šä¼ ã€‚è¿™ä¸ªåœ°æ–¹ä¹Ÿå¯ä»¥ç»™å¤§å®¶æä¾›å¦å¤–ä¸€ç§æ€è·¯ï¼Œç¬¬1ä¸ªæ¥å£åˆ›å»ºåˆ†ç‰‡ä»»åŠ¡çš„æ—¶å€™ä¼ å…¥äº†æ–‡ä»¶çš„md5ï¼ŒæŒ‰è¯´è¿™ä¸ªå€¼æ˜¯å…·æœ‰å”¯ä¸€æ€§çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡è¿™ä¸ªå€¼æ‰¾åˆ°åˆšæ‰çš„ä»»åŠ¡ï¼ŒæŒ‰ç…§è¿™ç§æ€è·¯ï¼Œå°±éœ€è¦åç«¯æä¾›ä¸€ä¸ªæ–°çš„æ¥å£ï¼šé€šè¿‡æ–‡ä»¶çš„md5å€¼æ‰¾åˆ°åˆšæ‰å¤±è´¥çš„é‚£ä¸ªä»»åŠ¡ï¼Œç„¶åç»§ç»­ä¸Šä¼ æœªä¸Šä¼ çš„åˆ†ç‰‡ã€‚</p>
<h4 id="æƒ…å†µ2æµè§ˆå™¨å¯ä»¥ç»§ç»­è¯»å–åˆšæ‰ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶">æƒ…å†µ2ï¼šæµè§ˆå™¨å¯ä»¥ç»§ç»­è¯»å–åˆšæ‰ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#æƒ…å†µ2æµè§ˆå™¨å¯ä»¥ç»§ç»­è¯»å–åˆšæ‰ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶">#</a></h4>
<p>è¿™ç§æƒ…å†µï¼Œå¯ä»¥å…ˆè°ƒç”¨ç¬¬4ä¸ªæ¥å£ï¼Œé€šè¿‡æ­¤æ¥å£å¯ä»¥çŸ¥é“é‚£äº›åˆ†ç‰‡è¿˜æœªä¸Šä¼ ï¼Œç„¶åç»§ç»­ä¸Šä¼ è¿™äº›åˆ†ç‰‡å°±å¯ä»¥äº†ã€‚</p>
<h2 id="2-å¤šçº¿ç¨‹ä»»åŠ¡æ‰¹å¤„ç†é€šç”¨å·¥å…·ç±»">2. å¤šçº¿ç¨‹ä»»åŠ¡æ‰¹å¤„ç†é€šç”¨å·¥å…·ç±»<a hidden class="anchor" aria-hidden="true" href="#2-å¤šçº¿ç¨‹ä»»åŠ¡æ‰¹å¤„ç†é€šç”¨å·¥å…·ç±»">#</a></h2>
<p>ç›¸å…³ä»£ç ï¼š<a href="https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson002">https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson002</a></p>
<blockquote>
<p>ä½¿ç”¨çº¿ç¨‹æ± æ‰¹é‡å‘é€çŸ­ä¿¡ï¼Œå½“çŸ­ä¿¡å‘é€å®Œæ¯•ä¹‹åï¼Œè®°å½•è€—æ—¶æƒ…å†µ
<strong>ã€ä¸»è¦çŸ¥è¯†ç‚¹ã€‘</strong></p></blockquote>
<ul>
<li>CountDownLatchï¼šå¦‚æœæƒ³è¦ç­‰å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œä¹‹åï¼Œå†ç»§ç»­å›åˆ°åŸæ–¹æ³•ä¸­ï¼Œå¯ä»¥ä½¿ç”¨CountDownLatch</li>
<li>Executorsï¼šç”¨äºåˆ›å»ºçº¿ç¨‹æ± ï¼Œé‡å†™ <code>executor.execute</code> ä¸­çš„ <code>Runnable</code> æ–¹æ³•ï¼Œå¯å®ç°å¼‚æ­¥æ‰§è¡Œçº¿ç¨‹</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TaskDisposeUtils</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ä½¿ç”¨çº¿ç¨‹æ± æ‰¹å¤„ç†æ–‡ä»¶ï¼Œå½“æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œæ¯•åæ‰ä¼šè¿”å›
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param taskList ä»»åŠ¡åˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param consumer å¤„ç†ä»»åŠ¡çš„æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param executor çº¿ç¨‹æ± 
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param &lt;T&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws InterruptedException
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">dispose</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">taskList</span><span class="p">,</span><span class="w"> </span><span class="n">Consumer</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">super</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">consumer</span><span class="p">,</span><span class="w"> </span><span class="n">Executor</span><span class="w"> </span><span class="n">executor</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">taskList</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">taskList</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">consumer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CountDownLatch</span><span class="w"> </span><span class="n">latch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CountDownLatch</span><span class="p">(</span><span class="n">taskList</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">taskList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">executor</span><span class="p">.</span><span class="na">execute</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">consumer</span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">item</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">latch</span><span class="p">.</span><span class="na">countDown</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">latch</span><span class="p">.</span><span class="na">await</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">taskList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&#34;çŸ­ä¿¡-1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;çŸ­ä¿¡-2&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;çŸ­ä¿¡-3&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="n">10</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">dispose</span><span class="p">(</span><span class="n">taskList</span><span class="p">,</span><span class="w"> </span><span class="n">TaskDisposeUtils</span><span class="p">::</span><span class="n">doTask</span><span class="p">,</span><span class="w"> </span><span class="n">executor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;ä»»åŠ¡å¤„ç†å®Œæ¯•,è€—æ—¶(ms):&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">startTime</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">executor</span><span class="p">.</span><span class="na">shutdown</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doTask</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">task</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">task</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;å‘é€æˆåŠŸ&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="3-æ¥å£æ€§èƒ½å‹åŠ›æµ‹è¯•å·¥å…·">3. æ¥å£æ€§èƒ½å‹åŠ›æµ‹è¯•å·¥å…·<a hidden class="anchor" aria-hidden="true" href="#3-æ¥å£æ€§èƒ½å‹åŠ›æµ‹è¯•å·¥å…·">#</a></h2>
<p>ç›¸å…³ä»£ç ï¼š<a href="https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson003">https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson003</a></p>
<h3 id="31-å¸¸ç”¨å‹æµ‹å·¥å…·ç±»">3.1 å¸¸ç”¨å‹æµ‹å·¥å…·ç±»<a hidden class="anchor" aria-hidden="true" href="#31-å¸¸ç”¨å‹æµ‹å·¥å…·ç±»">#</a></h3>
<p><a href="https://jmeter.apache.org/">Jemeter</a> ã€<a href="https://blog.csdn.net/light2081/article/details/131175276">LoadRunner</a>ã€ApiFox - è‡ªåŠ¨åŒ–æµ‹è¯•</p>
<p>ã€æ³¨æ„ã€‘LoadRunner åªæœ‰windowå¯ä»¥ç”¨</p>
<h3 id="32-æ‰‹å†™å‹æµ‹å·¥å…·ç±»">3.2 æ‰‹å†™å‹æµ‹å·¥å…·ç±»<a hidden class="anchor" aria-hidden="true" href="#32-æ‰‹å†™å‹æµ‹å·¥å…·ç±»">#</a></h3>
<p>ã€ä¸»è¦çŸ¥è¯†ç‚¹ã€‘</p>
<ul>
<li>
<p><strong>ä¸ºä»€ä¹ˆ <code>updateFastestTime</code> æ–¹æ³•éœ€è¦ä½¿ç”¨å¾ªç¯è€Œä¸æ˜¯ç›´æ¥ <code>compareAndSet</code></strong> ï¼šå› ä¸ºç›´æ¥ä½¿ç”¨ <code>compareAndSet</code> ä¼šå‡ºç°çº¿ç¨‹ä¸å®‰å…¨çš„æƒ…å†µï¼Œæ¯”å¦‚ä¸‹é¢çš„æƒ…å†µ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// é”™è¯¯çš„åšæ³•ï¼ˆéçº¿ç¨‹å®‰å…¨ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">int</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fastestCostTime</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">  </span><span class="c1">// çº¿ç¨‹Aè¯»å–åˆ°å€¼100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">costTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">             </span><span class="c1">// çº¿ç¨‹Aåˆ¤æ–­100 &gt; 30ï¼Œå‡†å¤‡æ›´æ–°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// æ­¤æ—¶çº¿ç¨‹Bä¹Ÿè¯»å–åˆ°100ï¼Œä¹Ÿåˆ¤æ–­100 &gt; 50ï¼Œä¹Ÿå‡†å¤‡æ›´æ–°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">fastestCostTime</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">costTime</span><span class="p">);</span><span class="w">    </span><span class="c1">// çº¿ç¨‹Aè®¾ç½®ä¸º30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// çº¿ç¨‹Bè®¾ç½®ä¸º50ï¼Œè¦†ç›–äº†çº¿ç¨‹Açš„ç»“æœ (æœ€å°æ—¶é—´åº”è¯¥æ˜¯30s)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// ä½¿ç”¨whileå¾ªç¯ä¿è¯çº¿ç¨‹å®‰å…¨ ï¼ˆå…¶å®å°±æ˜¯CASï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">fsCostTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fastestCostTime</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">  </span><span class="c1">// çº¿ç¨‹Aè¯»å–åˆ°100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// çº¿ç¨‹Bæ­¤æ—¶å°†å€¼æ”¹ä¸º90</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fastestCostTime</span><span class="p">.</span><span class="na">compareAndSet</span><span class="p">(</span><span class="n">fsCostTime</span><span class="p">,</span><span class="w"> </span><span class="n">costTime</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// çº¿ç¨‹Aå°è¯•å°†100æ”¹ä¸º50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// å¤±è´¥ï¼å› ä¸ºå½“å‰å€¼å·²ç»æ˜¯90ï¼Œä¸ç­‰äºé¢„æœŸçš„100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// ç»§ç»­å¾ªç¯ï¼Œé‡æ–°è·å–æœ€æ–°å€¼90ï¼Œå†æ¬¡å°è¯•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p><strong>çº¿ç¨‹æ± å‚æ•°</strong>ï¼šæ•°ä¾æ¬¡ä¸º <code>coolPoolSize</code> ã€<code>maxPoolSize</code>ã€<code>keepAliveTime</code>ã€<code>TimeUnit</code>ã€<code>waitQueue</code> ç­‰å¾…é˜Ÿåˆ—</p>
</li>
<li>
<p><strong>ä¸ºä»€ä¹ˆçº¿ç¨‹éœ€è¦é¢„çƒ­</strong>ï¼šé¢„çƒ­æ˜¯ä¸ºäº†é¿å…çº¿ç¨‹åˆ›å»ºæ—¶å¸¦æ¥çš„é¢å¤–å¼€é”€ï¼Œå¦‚æœä¸é¢„çƒ­ï¼Œå¾ˆå¯èƒ½å‰ <code>100</code> ä¸ªæ ¸å¿ƒçº¿ç¨‹éœ€è¦å¤šæ¶ˆè€— <code>10~50 ms</code> æ¥åˆ›å»ºçº¿ç¨‹</p>
</li>
<li>
<p><strong>AtomicInteger</strong>ï¼šé˜²æ­¢å¤šçº¿ç¨‹ä¿®æ”¹åŒä¸€æ•°æ®æ—¶ï¼Œå‡ºç°çº¿ç¨‹ä¸å®‰å…¨çš„æƒ…å†µ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// æ™®é€šIntegerçš„é—®é¢˜</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="p">;</span><span class="w">     </span><span class="c1">// 1. è¯»å–</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">       </span><span class="c1">// 2. ä¿®æ”¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">         </span><span class="c1">// 3. å†™å…¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// è¿™ä¸‰æ­¥ä¸æ˜¯åŸå­çš„ï¼Œå¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// AtomicIntegeré‡‡ç”¨CAS + volatile ä¿è¯åŸå­æ€§</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">atomicCounter</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">();</span><span class="w">  </span><span class="c1">// åŸå­æ“ä½œ</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p><code>volatile</code> å…³é”®å­—åœ¨<code>AtomicInteger</code>ä½œç”¨ï¼š<code>volatile</code> å°±åƒæ˜¯ç»™å˜é‡è´´äº†ä¸ª&quot;å®æ—¶æ›´æ–°&quot;çš„æ ‡ç­¾ã€‚é€šè¿‡å†…å­˜å¯è§æ€§å’Œç¦æ­¢æŒ‡ä»¤é‡æ’åºæ¥ä¿è¯å®æ—¶æ›´æ–°</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="cl"><span class="c1">// æ²¡æœ‰volatileçš„æƒ…å†µ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// çº¿ç¨‹Aä¿®æ”¹äº†count = 100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// çº¿ç¨‹Bå¯èƒ½è¿˜æ˜¯çœ‹åˆ°count = 0ï¼ˆå› ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ç¼“å­˜ï¼‰</span><span class="w">
</span></span></span></code></pre></div><p>æ‰€ä»¥ï¼Œå¦‚æœ æ²¡æœ‰<code>volatile</code> å…³é”®å­—ï¼Œ æ²¡æœ‰çº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„&quot;å°æœ¬æœ¬&quot;ï¼ˆCPUç¼“å­˜ï¼Œçº¿ç¨‹ç§æœ‰ï¼‰ï¼Œå¯èƒ½è®°å½•çš„æ•°æ®ä¸æ˜¯æœ€æ–°çš„ã€‚</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoadRunnerUtils</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoadRunnerResult</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">requests</span><span class="p">;</span><span class="w">           </span><span class="c1">// è¯·æ±‚æ€»æ•°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">concurrency</span><span class="p">;</span><span class="w">        </span><span class="c1">// å¹¶å‘é‡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">successRequests</span><span class="p">;</span><span class="w">    </span><span class="c1">// æˆåŠŸè¯·æ±‚æ•°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">failRequests</span><span class="p">;</span><span class="w">       </span><span class="c1">// å¤±è´¥è¯·æ±‚æ•°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">timeTakenForTests</span><span class="p">;</span><span class="w">  </span><span class="c1">// è¯·æ±‚æ€»è€—æ—¶(ms)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">requestsPerSecond</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ¯ç§’è¯·æ±‚æ•°ï¼ˆååé‡ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">timePerRequest</span><span class="p">;</span><span class="w">    </span><span class="c1">// æ¯ä¸ªè¯·æ±‚å¹³å‡è€—æ—¶(ms)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">fastestCostTime</span><span class="p">;</span><span class="w">   </span><span class="c1">// æœ€å¿«çš„è¯·æ±‚è€—æ—¶(ms)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">slowestCostTime</span><span class="p">;</span><span class="w">   </span><span class="c1">// æœ€æ…¢çš„è¯·æ±‚è€—æ—¶(ms)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * æ‰§è¡Œå¹¶å‘å‹åŠ›æµ‹è¯•
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param requests    æ€»è¯·æ±‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param concurrency å¹¶å‘æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param command     è¢«æµ‹è¯•çš„ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return å‹æµ‹ç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">LoadRunnerResult</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">requests</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">concurrency</span><span class="p">,</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="n">command</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;å‹æµ‹å¼€å§‹......&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// åˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ï¼Œé¢„çƒ­æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ThreadPoolExecutor</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createThreadPool</span><span class="p">(</span><span class="n">concurrency</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ç”¨äºç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆçš„åŒæ­¥å™¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CountDownLatch</span><span class="w"> </span><span class="n">latch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CountDownLatch</span><span class="p">(</span><span class="n">requests</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ç»Ÿè®¡æ•°æ®ï¼ˆä½¿ç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">successCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">fastestTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">slowestTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">MIN_VALUE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æäº¤æ‰€æœ‰å‹æµ‹ä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">requests</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">executor</span><span class="p">.</span><span class="na">execute</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">executeRequest</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">successCount</span><span class="p">,</span><span class="w"> </span><span class="n">fastestTime</span><span class="p">,</span><span class="w"> </span><span class="n">slowestTime</span><span class="p">,</span><span class="w"> </span><span class="n">latch</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">latch</span><span class="p">.</span><span class="na">await</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">executor</span><span class="p">.</span><span class="na">shutdown</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">endTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;å‹æµ‹ç»“æŸï¼Œæ€»è€—æ—¶(ms):{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">endTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">startTime</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è¿”å›å‹æµ‹ç»“æœ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * åˆ›å»ºçº¿ç¨‹æ± å¹¶é¢„çƒ­æ ¸å¿ƒçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="w"> </span><span class="nf">createThreadPool</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">concurrency</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// å‚æ•°ä¾æ¬¡ä¸º coolPoolSizeã€maxPoolSizeã€keepAliveTimeã€TimeUnitã€ç­‰å¾…é˜Ÿåˆ—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ThreadPoolExecutor</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">concurrency</span><span class="p">,</span><span class="w"> </span><span class="n">concurrency</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">0L</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedBlockingQueue</span><span class="o">&lt;&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">executor</span><span class="p">.</span><span class="na">prestartAllCoreThreads</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">executor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * æ‰§è¡Œå•ä¸ªè¯·æ±‚å¹¶ç»Ÿè®¡ç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">executeRequest</span><span class="p">(</span><span class="n">Runnable</span><span class="w"> </span><span class="n">command</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">successCount</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                     </span><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">fastestTime</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">slowestTime</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                     </span><span class="n">CountDownLatch</span><span class="w"> </span><span class="n">latch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">requestStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">command</span><span class="p">.</span><span class="na">run</span><span class="p">();</span><span class="w"> </span><span class="c1">// æ‰§è¡Œè¢«æµ‹è¯•çš„æ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">costTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">requestStart</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// æ›´æ–°ç»Ÿè®¡æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">updateFastestTime</span><span class="p">(</span><span class="n">fastestTime</span><span class="p">,</span><span class="w"> </span><span class="n">costTime</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">updateSlowestTime</span><span class="p">(</span><span class="n">slowestTime</span><span class="p">,</span><span class="w"> </span><span class="n">costTime</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">successCount</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;è¯·æ±‚æ‰§è¡Œå¤±è´¥: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">latch</span><span class="p">.</span><span class="na">countDown</span><span class="p">();</span><span class="w"> </span><span class="c1">// æ ‡è®°å½“å‰è¯·æ±‚å®Œæˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * åŸå­æ›´æ–°æœ€å¿«è€—æ—¶
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateFastestTime</span><span class="p">(</span><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">fastestTime</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">costTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fastestTime</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">costTime</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">fastestTime</span><span class="p">.</span><span class="na">compareAndSet</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">costTime</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="4-semaphoreå®ç°æ¥å£é™æµ">4. Semaphoreå®ç°æ¥å£é™æµ<a hidden class="anchor" aria-hidden="true" href="#4-semaphoreå®ç°æ¥å£é™æµ">#</a></h2>
<blockquote>
<p>å¦‚æœåç«¯æœåŠ¡æ˜¯å•ä½“æœåŠ¡ï¼Œä¸”åªéƒ¨ç½²åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥é‡‡ç”¨ <code>Semaphore</code> ä¿¡å·é‡çš„æ–¹å¼å®ç°ç®€å•çš„æ¥å£é™æµæœºåˆ¶</p></blockquote>
<p>ç›¸å…³ä»£ç ï¼š<a href="https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson005">https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson005</a></p>
<p><code>Semaphore</code> : JUCå½“ä¸­å¯¹ä¿¡å·é‡çš„å®ç°ï¼Œç”¨äºæ§åˆ¶åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Jucä¸­çš„Semaphoreå¯ä»¥å®ç°é™æµåŠŸèƒ½ï¼Œå¯ä»¥å°† Semaphore æƒ³è±¡æˆåœè½¦åœºå…¥å£çš„å¤§çˆ·ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">     * å¤§çˆ·æ‰‹é‡Œé¢æ‹¥æœ‰ä¸€å®šæ•°é‡çš„åœè½¦å¡ï¼ˆä¹Ÿå¯ä»¥è¯´æ˜¯ä»¤ç‰Œï¼‰ï¼Œå¡çš„æ•°é‡æ˜¯å¤šå°‘å‘¢ï¼Ÿå°±æ˜¯Semaphoreæ„é€ æ–¹æ³•ä¸­æŒ‡å®šçš„ï¼Œå¦‚ä¸‹å°±æ˜¯50ä¸ªå¡ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è½¦ä¸»æƒ³è¿›å»åœè½¦ï¼Œå…ˆè¦ä»å¤§çˆ·æ‰‹ä¸­æ‹¿åˆ°ä¸€å¼ å¡ï¼Œå‡ºæ¥çš„æ—¶å€™ï¼Œéœ€è¦è¿˜ç»™å¤§çˆ·ï¼Œå¦‚æœæ‹¿ä¸åˆ°å¡ï¼Œå°±ä¸èƒ½è¿›å»åœè½¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">     * semaphore å†…éƒ¨æä¾›äº†è·å–ä»¤ç‰Œï¼Œå’Œè¿˜ä»¤ç‰Œçš„ä¸€äº›æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Semaphore</span><span class="w"> </span><span class="n">semaphore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Semaphore</span><span class="p">(</span><span class="n">50</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * æ¥ä¸ªæ¡ˆä¾‹ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¸‹å•çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æœ€å¤šåªå…è®¸ 50 ä¸ªå¹¶å‘ï¼Œè‹¥è¶…è¿‡50ä¸ªå¹¶å‘ï¼Œåˆ™è¿›æ¥çš„è¯·æ±‚ï¼Œæœ€å¤šç­‰å¾…1ç§’ï¼Œå¦‚æœæ— æ³•è·å–åˆ°ä»¤ç‰Œï¼Œåˆ™å¿«é€Ÿè¿”å›å¤±è´¥ï¼Œè¯·é‡è¯•
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/placeOrder&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">placeOrder</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * semaphore åœ¨ä¸Šé¢å®šä¹‰çš„ï¼Œé‡Œé¢æœ‰50ä¸ªä»¤ç‰Œï¼Œä¹Ÿå°±æ˜¯åŒæ—¶å¯ä»¥æ”¯æŒ50ä¸ªå¹¶å‘è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ä¸‹é¢çš„ä»£ç ï¼Œå°è¯•æœ€å¤šç­‰å¾…1ç§’å»è·å–ä»¤ç‰Œï¼Œè·å–æˆåŠŸï¼Œåˆ™è¿›å…¥ä¸‹å•é€»è¾‘ï¼Œè·å–å¤±è´¥ï¼Œåˆ™è¿”å›ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">semaphore</span><span class="p">.</span><span class="na">tryAcquire</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">1L</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è·å–åˆ°ä»¤ç‰Œï¼Œåˆ™è¿›å…¥ä¸‹å•é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//è¿™é‡Œä¼‘çœ 2ç§’ï¼Œæ¨¡æ‹Ÿä¸‹å•çš„æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;ä¸‹å•æˆåŠŸ&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">//è¿™é‡Œä¸€å®šä¸è¦æ¼æ‰äº†ï¼Œä»¤ç‰Œç”¨å®Œäº†ï¼Œè¦è¿˜å›å»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="na">semaphore</span><span class="p">.</span><span class="na">release</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="5-å¹¶è¡ŒæŸ¥è¯¢---æäº¤æ¥å£å“åº”é€Ÿåº¦">5. å¹¶è¡ŒæŸ¥è¯¢ - æäº¤æ¥å£å“åº”é€Ÿåº¦<a hidden class="anchor" aria-hidden="true" href="#5-å¹¶è¡ŒæŸ¥è¯¢---æäº¤æ¥å£å“åº”é€Ÿåº¦">#</a></h2>
<blockquote>
<p>éœ€æ±‚åˆ†æï¼šå½“å‰æ¥å£éœ€è¦å®ç°ä¸‹é¢çš„åŠŸèƒ½</p>
<p>æ¥æ”¶ä¸€ä¸ªå•†å“idï¼Œéœ€è¦è¿”å›å•†å“ä¸‹é¢è¿™äº›ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯éƒ½åœ¨ä¸åŒçš„è¡¨ä¸­ï¼Œé€šè¿‡å•†å“idå°±å¯ä»¥æŸ¥åˆ°</p>
<ul>
<li>å•†å“åŸºæœ¬ä¿¡æ¯ï¼ˆå¦‚å•†å“åç§°ã€ä»·æ ¼ç­‰åŸºæœ¬ä¿¡æ¯)</li>
<li>å•†å“æè¿°ä¿¡æ¯ï¼ˆå¯èƒ½æ˜¯å¯Œæ–‡æœ¬ï¼Œæ”¾åœ¨å•ç‹¬çš„è¡¨ä¸­ï¼‰</li>
<li>å•†å“æ”¶è—é‡</li>
<li>å•†å“è¯„è®ºé‡</li>
</ul></blockquote>
<p>ç›¸å…³ä»£ç ï¼š<a href="https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson006">https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson006</a></p>
<h3 id="51--å¸¸è§„åšæ³•">5.1  å¸¸è§„åšæ³•<a hidden class="anchor" aria-hidden="true" href="#51--å¸¸è§„åšæ³•">#</a></h3>
<p>æŒ‰ç…§å•†å“ <code>id</code> åˆ†åˆ«æŸ¥è¯¢ä¸åŒçš„æ•°æ®åº“ï¼Œåœ¨JVMå†…å­˜ä¸­å¯¹ç»“æœè¿›è¡Œç»„è£…ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GoodsController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * æ ¹æ®å•†å“idè·å–å•†å“ä¿¡æ¯(åŸºæœ¬ä¿¡æ¯ã€æè¿°ä¿¡æ¯ã€è¯„è®ºé‡ï¼Œæ”¶è—é‡)
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param goodsId å•†å“id
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws InterruptedException
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/getGoodsDetail&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">GoodsDetailResponse</span><span class="w"> </span><span class="nf">getGoodsDetail</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="s">&#34;goodsId&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">goodsId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">GoodsDetailResponse</span><span class="w"> </span><span class="n">goodsDetailResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GoodsDetailResponse</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 1ã€è·å–å•†å“åŸºæœ¬ä¿¡æ¯ï¼Œè€—æ—¶100ms</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">goodsDetailResponse</span><span class="p">.</span><span class="na">setGoodsInfo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getGoodsInfo</span><span class="p">(</span><span class="n">goodsId</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2ã€è·å–å•†å“æè¿°ä¿¡æ¯ï¼Œè€—æ—¶100ms</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">goodsDetailResponse</span><span class="p">.</span><span class="na">setGoodsDescription</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getGoodsDescription</span><span class="p">(</span><span class="n">goodsId</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3ã€è·å–å•†å“è¯„è®ºé‡ï¼Œè€—æ—¶100ms</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">goodsDetailResponse</span><span class="p">.</span><span class="na">setCommentCount</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getGoodsCommentCount</span><span class="p">(</span><span class="n">goodsId</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//4ã€è·å–å•†å“æ”¶è—é‡ï¼Œè€—æ—¶100ms</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">goodsDetailResponse</span><span class="p">.</span><span class="na">setFavoriteCount</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getGoodsFavoriteCount</span><span class="p">(</span><span class="n">goodsId</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æ€»è€—æ—¶ä¸º500mså·¦å³</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;è·å–å•†å“ä¿¡æ¯ï¼Œæ™®é€šç‰ˆè€—æ—¶ï¼š{} ms&#34;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ä½¿ç”¨sleepæ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢çš„å»¶è¿Ÿ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getGoodsFavoriteCount</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">goodsId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;è·å–å•†å“æ”¶è—é‡&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">100</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">10000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="52-ä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡ŒæŸ¥è¯¢å•†å“ä¿¡æ¯">5.2 ä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡ŒæŸ¥è¯¢å•†å“ä¿¡æ¯<a hidden class="anchor" aria-hidden="true" href="#52-ä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡ŒæŸ¥è¯¢å•†å“ä¿¡æ¯">#</a></h3>
<blockquote>
<p>åˆ†æï¼šä¸Šæ–¹çš„4ä¸ªå•†å“ä¿¡æ¯æŸ¥è¯¢ä¹‹é—´å¹¶æ²¡æœ‰ä»»ä½•ä¾èµ–ï¼Œè¿™äº›æ²¡æœ‰ä¾èµ–çš„æŸ¥è¯¢å…¶å®æ˜¯å¯ä»¥å¹¶è¡ŒæŸ¥è¯¢çš„ã€‚æ‰€ä»¥å¯ä»¥ä½¿ç”¨çº¿ç¨‹æ± åŒæ—¶å»æ‹¿è¿™4ä¸ªç»“æœï¼Œç„¶ååœ¨JVMå†…å­˜ä¸­è¿›è¡Œç»„è£…</p></blockquote>
<p>ã€ä¸»è¦çŸ¥è¯†ç‚¹ã€‘</p>
<ul>
<li>
<p>CompletableFuture (CF)ï¼šä¸»è¦ç”¨äºå¼‚æ­¥æ‰§è¡Œå¤šä¸ªç›¸äº’ç‹¬ç«‹çš„ä»»åŠ¡ ï¼ˆé€‚åˆå¼‚æ­¥ä»»åŠ¡ç¼–æ’ï¼Œå¯ä»¥æ–¹ä¾¿åœ°ç»„åˆå’Œè½¬æ¢ä»»åŠ¡ç»“æœï¼‰</p>
</li>
<li>
<p>CountDownLatch (CDL): ä¸»è¦ç”¨äºçº¿ç¨‹åè°ƒï¼Œç­‰å¾…ä¸€ç»„çº¿ç¨‹å®Œæˆ ï¼ˆä¸€èˆ¬å°±æ˜¯ç”¨æ¥ç­‰å¾…ä¸€æ‰¹çº¿ç¨‹æ‰§è¡Œå®Œï¼‰</p>
</li>
<li>
<p>CF å’Œ CDL åŒºåˆ«</p>
<ul>
<li><strong>CountDownLatch</strong> ğŸ‘‰ <strong>è¿åŠ¨ä¼šèµ·è·‘</strong>
è£åˆ¤ï¼ˆä¸»çº¿ç¨‹ï¼‰ç­‰å¾…æ‰€æœ‰è¿åŠ¨å‘˜ï¼ˆå­çº¿ç¨‹ï¼‰å°±ä½ï¼ˆ<code>countDown</code>ï¼‰ï¼Œæªå“ï¼ˆè®¡æ•°å™¨å½’é›¶ï¼‰åç»Ÿä¸€å¼€è·‘ã€‚</li>
<li><strong>CompletableFuture</strong> ğŸ‘‰ <strong>å¤–å–è®¢å•æµç¨‹</strong>
ä¸‹å•ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰â†’ åˆ¶ä½œï¼ˆ<code>thenApply</code> åŠ å·¥ï¼‰â†’ é…é€ï¼ˆ<code>thenAccept</code> äº¤ä»˜ï¼‰ï¼Œæ¯ä¸ªç¯èŠ‚è‡ªåŠ¨è§¦å‘ä¸‹ä¸€æ­¥ï¼Œæ— éœ€é˜»å¡</li>
</ul>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>å¯¹æ¯”ç»´åº¦</strong></th>
          <th style="text-align: left"><strong>CountDownLatch</strong></th>
          <th style="text-align: left"><strong>CompletableFuture</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>æ ¸å¿ƒç”¨é€”</strong></td>
          <td style="text-align: left">çº¿ç¨‹ç­‰å¾…æœºåˆ¶ï¼ˆé˜»å¡çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆï¼‰</td>
          <td style="text-align: left">å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ï¼ˆéé˜»å¡é“¾å¼ä»»åŠ¡å¤„ç†ï¼‰</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>å·¥ä½œæ–¹å¼</strong></td>
          <td style="text-align: left">é€šè¿‡è®¡æ•°å™¨é€’å‡ï¼ˆ<code>countDown()</code>ï¼‰è§¦å‘é‡Šæ”¾</td>
          <td style="text-align: left">é€šè¿‡å›è°ƒé“¾ï¼ˆ<code>thenApply()</code>/<code>thenAccept()</code>ï¼‰ä¼ é€’ç»“æœ</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>çº¿ç¨‹é˜»å¡</strong></td>
          <td style="text-align: left">è°ƒç”¨çº¿ç¨‹ä¸»åŠ¨é˜»å¡ï¼ˆ<code>await()</code>ï¼‰</td>
          <td style="text-align: left">è°ƒç”¨çº¿ç¨‹ä¸é˜»å¡ï¼Œé€šè¿‡å›è°ƒå¤„ç†ç»“æœ</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>ç»“æœä¼ é€’</strong></td>
          <td style="text-align: left">âŒ ä¸æ”¯æŒä»»åŠ¡ç»“æœä¼ é€’</td>
          <td style="text-align: left">âœ… æ”¯æŒä»»åŠ¡ç»“æœä¼ é€’å’Œè½¬æ¢</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>å¼‚å¸¸å¤„ç†</strong></td>
          <td style="text-align: left">âŒ éœ€æ‰‹åŠ¨æ•è·å¼‚å¸¸</td>
          <td style="text-align: left">âœ… å†…ç½®å¼‚å¸¸å¤„ç†ï¼ˆ<code>exceptionally()</code>/<code>handle()</code>ï¼‰</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>ä»»åŠ¡ç»„åˆ</strong></td>
          <td style="text-align: left">âŒ ä»…æ”¯æŒå•æ¬¡è®¡æ•°</td>
          <td style="text-align: left">âœ… æ”¯æŒå¤šä»»åŠ¡ç»„åˆï¼ˆ<code>allOf()</code>/<code>anyOf()</code>ï¼‰</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>å¤ç”¨æ€§</strong></td>
          <td style="text-align: left">âŒ è®¡æ•°å™¨å½’é›¶åä¸å¯é‡ç”¨</td>
          <td style="text-align: left">âœ… å¯é‡å¤ç»„åˆæ–°ä»»åŠ¡</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>å…¸å‹åœºæ™¯</strong></td>
          <td style="text-align: left">å¯åŠ¨å‰ç­‰å¾…èµ„æºåˆå§‹åŒ–ã€æ‰¹é‡ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œ</td>
          <td style="text-align: left">å¼‚æ­¥APIè°ƒç”¨ã€æµæ°´çº¿å¼æ•°æ®å¤„ç†ã€å¾®æœåŠ¡ç¼–æ’</td>
      </tr>
  </tbody>
</table>
<p>ä¸‹é¢çœ‹ä¸€ç»„CFå’ŒCDLçš„ä»£ç å¯¹æ¯”ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AsyncDemo</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// æ¨¡æ‹Ÿçº¿ç¨‹æ± </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="n">3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * CompletableFutureæ–¹å¼ - æ”¯æŒä»»åŠ¡ç¼–æ’å’Œç»“æœå¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">GoodsInfo</span><span class="w"> </span><span class="nf">getGoodsInfoWithCF</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">goodsId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">GoodsInfo</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GoodsInfo</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 1. åˆ›å»ºå¤šä¸ªå¼‚æ­¥ä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">basicInfoFuture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">queryBasicInfo</span><span class="p">(</span><span class="n">goodsId</span><span class="p">),</span><span class="w"> </span><span class="n">executor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">priceFuture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">supplyAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">queryPrice</span><span class="p">(</span><span class="n">goodsId</span><span class="p">),</span><span class="w"> </span><span class="n">executor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 2. å¯¹ç»“æœè¿›è¡Œå¤„ç†è½¬æ¢    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">processedInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">basicInfoFuture</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">thenApply</span><span class="p">(</span><span class="n">info</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&#34;å¤„ç†åçš„å•†å“ä¿¡æ¯: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">exceptionally</span><span class="p">(</span><span class="n">ex</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&#34;è·å–å•†å“ä¿¡æ¯å¤±è´¥&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 3. ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆå¹¶ç»„è£…ç»“æœ    </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">allOf</span><span class="p">(</span><span class="n">processedInfo</span><span class="p">,</span><span class="w"> </span><span class="n">priceFuture</span><span class="p">).</span><span class="na">join</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="na">setInfo</span><span class="p">(</span><span class="n">processedInfo</span><span class="p">.</span><span class="na">join</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="na">setPrice</span><span class="p">(</span><span class="n">priceFuture</span><span class="p">.</span><span class="na">join</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * CountDownLatchæ–¹å¼ - ä»…æ”¯æŒç­‰å¾…å¤šä¸ªçº¿ç¨‹å®Œæˆ
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">GoodsInfo</span><span class="w"> </span><span class="nf">getGoodsInfoWithCDL</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">goodsId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">GoodsInfo</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GoodsInfo</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CountDownLatch</span><span class="w"> </span><span class="n">latch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CountDownLatch</span><span class="p">(</span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 1. éœ€è¦æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">setInfo</span><span class="p">(</span><span class="n">queryBasicInfo</span><span class="p">(</span><span class="n">goodsId</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">latch</span><span class="p">.</span><span class="na">countDown</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">setPrice</span><span class="p">(</span><span class="n">queryPrice</span><span class="p">(</span><span class="n">goodsId</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">latch</span><span class="p">.</span><span class="na">countDown</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 2. ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">latch</span><span class="p">.</span><span class="na">await</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¦‚æœéœ€è¦å¼‚æ­¥å¹¶è¡Œ + ä»»åŠ¡ç¼–æ’ï¼Œå°±ç”¨ <code>CompletableFuture</code> ï¼›å¦‚æœåªæ˜¯ç”¨äºç­‰å¾…ä¸€æ‰¹å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œï¼Œå°±ç”¨ <code>CountDownLaunch</code></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GoodsController</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ä¼˜åŒ–åçš„æ–¹æ³•ï¼Œæ ¹æ®å•†å“idè·å–å•†å“ä¿¡æ¯(åŸºæœ¬ä¿¡æ¯ã€æè¿°ä¿¡æ¯ã€è¯„è®ºé‡ï¼Œæ”¶è—é‡)
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param goodsId å•†å“id
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws InterruptedException
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/getGoodsDetailNew&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">GoodsDetailResponse</span><span class="w"> </span><span class="nf">getGoodsDetailNew</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="s">&#34;goodsId&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">goodsId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">GoodsDetailResponse</span><span class="w"> </span><span class="n">goodsDetailResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GoodsDetailResponse</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 1ã€è·å–å•†å“åŸºæœ¬ä¿¡æ¯ï¼Œè€—æ—¶100ms</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">goodsInfoCf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">runAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">goodsDetailResponse</span><span class="p">.</span><span class="na">setGoodsInfo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getGoodsInfo</span><span class="p">(</span><span class="n">goodsId</span><span class="p">)),</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">goodsThreadPool</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2ã€è·å–å•†å“æè¿°ä¿¡æ¯ï¼Œè€—æ—¶100ms</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">goodsDescriptionCf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">runAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">goodsDetailResponse</span><span class="p">.</span><span class="na">setGoodsDescription</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getGoodsDescription</span><span class="p">(</span><span class="n">goodsId</span><span class="p">)),</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">goodsThreadPool</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//3ã€è·å–å•†å“è¯„è®ºé‡ï¼Œè€—æ—¶100ms</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">goodsCommentCountCf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">runAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">goodsDetailResponse</span><span class="p">.</span><span class="na">setCommentCount</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getGoodsCommentCount</span><span class="p">(</span><span class="n">goodsId</span><span class="p">)),</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">goodsThreadPool</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//4ã€è·å–å•†å“æ”¶è—é‡ï¼Œè€—æ—¶100ms</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">goodsFavoriteCountCf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">runAsync</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">goodsDetailResponse</span><span class="p">.</span><span class="na">setFavoriteCount</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getGoodsFavoriteCount</span><span class="p">(</span><span class="n">goodsId</span><span class="p">)),</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">goodsThreadPool</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//ç­‰å¾…ä¸Šé¢æ‰§è¡Œç»“æŸ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">allOf</span><span class="p">(</span><span class="n">goodsInfoCf</span><span class="p">,</span><span class="w"> </span><span class="n">goodsDescriptionCf</span><span class="p">,</span><span class="w"> </span><span class="n">goodsCommentCountCf</span><span class="p">,</span><span class="w"> </span><span class="n">goodsFavoriteCountCf</span><span class="p">).</span><span class="na">join</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// æ€»è€—æ—¶å¤§çº¦åœ¨100mså·¦å³</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;è·å–å•†å“ä¿¡æ¯ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡ŒæŸ¥è¯¢è€—æ—¶ï¼š{} ms&#34;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">st</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">goodsDetailResponse</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="6-å¹¶è¡ŒæŸ¥è¯¢å¯èƒ½å­˜åœ¨çš„é—®é¢˜å¦‚ä½•è§£å†³">6. å¹¶è¡ŒæŸ¥è¯¢å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#6-å¹¶è¡ŒæŸ¥è¯¢å¯èƒ½å­˜åœ¨çš„é—®é¢˜å¦‚ä½•è§£å†³">#</a></h2>
<p>ç›¸å…³ä»£ç ï¼š<a href="https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson006">https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson006</a></p>
<h3 id="61-å¹¶è¡ŒæŸ¥è¯¢ä¸­å­˜åœ¨çš„é—®é¢˜">6.1 å¹¶è¡ŒæŸ¥è¯¢ä¸­å­˜åœ¨çš„é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#61-å¹¶è¡ŒæŸ¥è¯¢ä¸­å­˜åœ¨çš„é—®é¢˜">#</a></h3>
<p>å¹¶è¡ŒæŸ¥è¯¢æ‰€ç”¨åˆ°çš„çº¿ç¨‹æ± é…ç½®æ˜¯éå¸¸å…³é”®ä¸”é‡è¦çš„é…ç½®ï¼Œå¦‚æœè®¾ç½®ä¸å½“å¯èƒ½å‡ºç°ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚</p>
<p>æ¯”å¦‚å°†æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸ºäº† <code>1</code> ï¼Œè€Œé˜Ÿåˆ—å¤§å°æ²¡æœ‰é™åˆ¶ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„è¯·æ±‚éƒ½å˜æˆä¸²è¡Œäº†ï¼Œä¼šå¯¼è‡´è¯·æ±‚å“åº”éå¸¸æ…¢ã€‚å¦å¤–ï¼Œæ ¸å¿ƒçº¿ç¨‹æ± å’Œé˜Ÿåˆ—å¤§å°çš„ä¸Šé™ä¹Ÿåº”è¯¥åŒ¹é…ã€‚å¦‚æœæ ¸å¿ƒçº¿ç¨‹æ± è®¾ç½®ä¸º <code>10</code> ï¼Œè€Œé˜Ÿåˆ—å¤§å°æ²¡æœ‰è®¾ç½®ä¸Šé™ã€‚è¯¥çº¿ç¨‹æ± åŒæ—¶åªå¯æ”¯æŒ <code>10</code> ä¸ªä»»åŠ¡å¹¶è¡Œï¼Œå…¶ä»–çš„è¯·æ±‚éƒ½ä¼šå˜æˆä¸²è¡Œæ‰§è¡Œäº†ï¼Œè¿›å…¥é˜Ÿåˆ—æ’é˜Ÿï¼Œä»è€Œå¯¼è‡´æ¥å£å“åº”ç‰¹åˆ«æ…¢ã€‚</p>
<h3 id="62-å¦‚ä½•è§£å†³å¹¶è¡ŒæŸ¥è¯¢çš„é—®é¢˜">6.2 å¦‚ä½•è§£å†³å¹¶è¡ŒæŸ¥è¯¢çš„é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#62-å¦‚ä½•è§£å†³å¹¶è¡ŒæŸ¥è¯¢çš„é—®é¢˜">#</a></h3>
<p>è§£å†³å¹¶è¡ŒæŸ¥è¯¢é—®é¢˜çš„æ ¸å¿ƒï¼šä¸è¦è®©ä»»åŠ¡æ’é˜Ÿæˆ–è€…æ’é˜Ÿæ—¶é—´ä¸è¦å¤ªé•¿</p>
<p>ä¸‹é¢ä»çº¿ç¨‹æ± çš„æ‰§è¡Œæµç¨‹å…¥æ‰‹ï¼Œä¼˜åŒ–å¹¶è¡ŒæŸ¥è¯¢é—®é¢˜</p>
<p><img alt="image-20240405093250650" loading="lazy" src="https://oss.swimmingliu.cn/536e392e-6313-11f0-99d8-caaeffceb345"></p>
<p><strong>ã€è§£å†³æ–¹æ¡ˆã€‘</strong></p>
<ul>
<li>
<p><strong>å¢å¤§çº¿ç¨‹æ•°</strong>ï¼šå¯ä»¥å°†<strong>æ ¸å¿ƒçº¿ç¨‹æ•°</strong>ã€<strong>æœ€å¤§çº¿ç¨‹æ•°è°ƒå¤§</strong>ï¼Œä½†ä¸èƒ½è°ƒåˆ°è¶…è¿‡CPUçš„æœ€å¤§è´Ÿè½½ï¼Œä¸ç„¶å¯èƒ½ä¼šé™ä½ç³»ç»Ÿæ€§èƒ½åˆ†ã€‚è¯¥å‚æ•°åº”è¯¥æ ¹æ®ä¸šåŠ¡çš„æŒ‡æ ‡è¿›è¡Œå‹æµ‹å¾—åˆ°ä¸€ä¸ªåˆç†çš„å€¼</p>
</li>
<li>
<p><strong>å‡å°‘é˜Ÿåˆ—æ•°</strong>ï¼š</p>
<ul>
<li>
<p>å°†é˜Ÿåˆ—å¤§å°è®¾ç½®çš„æ¯”è¾ƒå°ï¼Œè¿™æ ·æ’é˜Ÿçš„æ—¶é—´å¤§æ¦‚ç‡ä¼šæ¯”è¾ƒçŸ­ï¼Œæˆ–è€…æ’é˜Ÿå¤±è´¥ï¼Œç›´æ¥åé¢çš„æµç¨‹</p>
<p>âš ï¸ ä¹‹å‰ç†è§£å­˜åœ¨è¯¯åŒºï¼šåº”è¯¥æ˜¯æ ¸å¿ƒçº¿ç¨‹æ£€æŸ¥å®Œäº†ï¼Œå°±æ£€æŸ¥èƒ½å¦æ”¾å…¥é˜Ÿåˆ—ï¼Œå†æ£€æŸ¥æœ€å¤§çº¿ç¨‹æ•°ã€‚è€Œä¸æ˜¯æ ¸å¿ƒçº¿ç¨‹æ£€æŸ¥å®Œï¼Œå°±å»æ£€æŸ¥æœ€å¤§çº¿ç¨‹æ•°ã€‚</p>
</li>
<li>
<p>å‡å°‘é˜Ÿåˆ—æ•°è‡³ <code>0</code>ï¼šè¿™æ ·ä»»åŠ¡å°±ä¸ä¼šè¿›å…¥é˜Ÿåˆ—ï¼Œè€Œç›´æ¥åˆ›å»ºæ–°çš„çº¿ç¨‹å»æ‰§è¡Œï¼Œæˆ–è€…èµ°æ‹’ç»ç­–ç•¥</p>
<blockquote>
<p><code>LinkedBlockingQueueã€ArrayBlockingQueue</code> å®¹é‡æ˜¯ä¸å…è®¸ä¸º0çš„ï¼Œå¦‚æœéœ€è¦ç”¨åˆ°å®¹é‡ä¸º0çš„é˜Ÿåˆ—ï¼Œåˆ™éœ€è¦ä½¿ç”¨<strong>åŒæ­¥é˜»å¡é˜Ÿåˆ—</strong> <code>SynchronousQueue</code></p></blockquote>
</li>
</ul>
</li>
<li>
<p><strong>æ‹’ç»ç­–ç•¥</strong>ï¼šå¯ä»¥ä½¿ç”¨ <code>CallerRunsPolicy</code>ï¼Œè¿™ä¸ªç­–ç•¥æ˜¯ç›´æ¥åœ¨è°ƒç”¨çº¿ç¨‹çš„å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œã€‚è¯¥ç­–ç•¥å¯ä»¥ä¿è¯ä»»åŠ¡èƒ½å¿«é€Ÿè¢«å¤„ç†ï¼Œä¸ä¼šä¸€ç›´å¤„äºé˜»å¡æ€</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">ç­–ç•¥åç§°</th>
          <th style="text-align: left">è¡Œä¸ºæè¿°</th>
          <th style="text-align: left">é€‚ç”¨åœºæ™¯</th>
          <th style="text-align: left">ç”Ÿæ´»å®ä¾‹ç±»æ¯”</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>AbortPolicy</strong></td>
          <td style="text-align: left">ç›´æ¥æŠ›å‡º <code>RejectedExecutionException</code> å¼‚å¸¸</td>
          <td style="text-align: left">éœ€è¦ä¸¥æ ¼ä¿è¯ä»»åŠ¡ä¸ä¸¢å¤±çš„åœºæ™¯</td>
          <td style="text-align: left">é¤å…æ»¡å‘˜æ—¶ç›´æ¥æ‹’ç»æ–°é¡¾å®¢</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>CallerRunsPolicy</strong></td>
          <td style="text-align: left">è®©æäº¤ä»»åŠ¡çš„çº¿ç¨‹è‡ªå·±æ‰§è¡Œè¯¥ä»»åŠ¡</td>
          <td style="text-align: left">éœ€è¦é™ä½ä»»åŠ¡æäº¤é€Ÿåº¦çš„åœºæ™¯</td>
          <td style="text-align: left">ç»ç†äº²è‡ªå¤„ç†æ— æ³•åˆ†é…çš„ä»»åŠ¡</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>DiscardPolicy</strong></td>
          <td style="text-align: left">é™é»˜ä¸¢å¼ƒæ–°ä»»åŠ¡ï¼Œä¸æŠ›å¼‚å¸¸ä¹Ÿä¸æ‰§è¡Œ</td>
          <td style="text-align: left">å…è®¸ä¸¢å¼ƒéå…³é”®ä»»åŠ¡çš„åœºæ™¯</td>
          <td style="text-align: left">å¿«é€’çˆ†ä»“æ—¶ç›´æ¥ä¸¢å¼ƒæ–°åŒ…è£¹</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>DiscardOldestPolicy</strong></td>
          <td style="text-align: left">ä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ä»»åŠ¡ï¼Œç„¶åå°è¯•é‡æ–°æäº¤å½“å‰ä»»åŠ¡</td>
          <td style="text-align: left">ä¼˜å…ˆå¤„ç†æ–°ä»»åŠ¡çš„åœºæ™¯</td>
          <td style="text-align: left">è¶…å¸‚æ’é˜Ÿæ—¶è®©ç­‰å¾…æœ€ä¹…çš„é¡¾å®¢ç¦»å¼€</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p><strong>çº¿ç¨‹æ± éš”ç¦»</strong>ï¼šä¸åŒçš„ä¸šåŠ¡æœ€å¥½ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼Œäº’ä¸å½±å“ï¼Œå¼ºçƒˆå»ºè®®<strong>æ ¸å¿ƒä¸šåŠ¡</strong>ä¸€å®šè¦ä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹æ± ã€‚</p>
</li>
</ul>
<p><strong>ã€ä¼˜åŒ–åçš„çº¿ç¨‹æ± é…ç½®ã€‘</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">ThreadPoolTaskExecutor</span><span class="w"> </span><span class="nf">goodsThreadPool</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ThreadPoolTaskExecutor</span><span class="w"> </span><span class="n">threadPoolTaskExecutor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolTaskExecutor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">threadPoolTaskExecutor</span><span class="p">.</span><span class="na">setThreadNamePrefix</span><span class="p">(</span><span class="s">&#34;ThreadPool-Goods-&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// æ ¸å¿ƒçº¿ç¨‹æ•°ä¸ºcpuæ ¸æ•° * 4ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ®ä¸ºcpuæ ¸æ•° * 8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">threadPoolTaskExecutor</span><span class="p">.</span><span class="na">setCorePoolSize</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">availableProcessors</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">4</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">threadPoolTaskExecutor</span><span class="p">.</span><span class="na">setMaxPoolSize</span><span class="p">(</span><span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">availableProcessors</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">8</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// é˜Ÿåˆ—å®¹é‡ä¸º0ï¼Œåˆ™ä»»åŠ¡å°±ä¸ä¼šè¿›å…¥é˜Ÿåˆ—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">threadPoolTaskExecutor</span><span class="p">.</span><span class="na">setQueueCapacity</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// æ‹’ç»ç­–ç•¥ä½¿ç”¨CallerRunsPolicyï¼Œè®©å½“å‰çº¿ç¨‹å»å…œåº•å»æ‰§è¡Œä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">threadPoolTaskExecutor</span><span class="p">.</span><span class="na">setRejectedExecutionHandler</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">.</span><span class="na">CallerRunsPolicy</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">threadPoolTaskExecutor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="7-æ¥å£æ€§èƒ½è°ƒä¼˜ä¹‹å¤§-é•¿-äº‹åŠ¡ä¼˜åŒ–">7. æ¥å£æ€§èƒ½è°ƒä¼˜ä¹‹å¤§ (é•¿) äº‹åŠ¡ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#7-æ¥å£æ€§èƒ½è°ƒä¼˜ä¹‹å¤§-é•¿-äº‹åŠ¡ä¼˜åŒ–">#</a></h2>
<blockquote>
<p>æ—¥å¸¸ç¼–ç¨‹ä¸­ï¼Œå®¹æ˜“é‡åˆ°äº‹åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„æƒ…å†µã€‚å¦‚æœè¯¥äº‹åŠ¡çš„å¯¹åº”çš„æ¥å£ï¼Œè¯·æ±‚é‡æš´å¢ï¼Œç”±äºæ•°æ®åº“è¿æ¥æ± çš„é™åˆ¶ï¼Œå¤§éƒ¨åˆ†è¯·æ±‚å¯èƒ½ä¼šå¤±è´¥ã€‚</p></blockquote>
<p>ç›¸å…³ä»£ç ï¼š<a href="https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson009">https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson009</a></p>
<h3 id="71-å¤§é•¿äº‹åŠ¡æ‰€å¸¦æ¥çš„é—®é¢˜">7.1 å¤§(é•¿)äº‹åŠ¡æ‰€å¸¦æ¥çš„é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#71-å¤§é•¿äº‹åŠ¡æ‰€å¸¦æ¥çš„é—®é¢˜">#</a></h3>
<p>ä¸‹é¢çš„ä»£ç å¸¦æœ‰ <code>@Transcational</code> æ³¨è§£ï¼Œ è¯´æ˜è¯¥æ–¹æ³•ä¼šäº¤ç»™ <code>Spring</code> æ¥ç®¡ç†è¯¥æ–¹æ³•çš„äº‹åŠ¡ã€‚å…·ä½“æ‰§è¡Œé€»è¾‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">1ã€Springå»æ•°æ®åº“è¿æ¥æ± æ‹¿åˆ°ä¸€ä¸ªæ•°æ®åº“è¿æ¥
</span></span><span class="line"><span class="cl">2ã€å¼€å¯äº‹åŠ¡
</span></span><span class="line"><span class="cl">3ã€æ‰§è¡ŒbigTransaction<span class="o">()</span>ä¸­çš„ä»£ç 
</span></span><span class="line"><span class="cl">4ã€æäº¤äº‹åŠ¡
</span></span><span class="line"><span class="cl">5ã€å°†æ•°æ®åº“è¿æ¥è¿˜ç»™æ•°æ®åº“è¿æ¥æ± ä¸­
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ•°æ®åº“è¿æ¥ä¼šä¸€ç›´è¢«å ç”¨ã€‚å› ä¸ºæ•°æ®åº“è¿æ¥æ—¶æœ‰é™çš„ï¼Œå¹¶ä¸”æ˜¯éå¸¸ç¨€ç¼ºçš„èµ„ã€‚å¦‚æœé•¿æ—¶é—´è¢«å ç”¨ï¼Œå¹¶ä¸”æ•°æ®åº“è¿æ¥æ± ä¸­çš„å¯ç”¨è¿æ¥éƒ½è¢«å ç”¨äº†ï¼Œåˆ™å…¶ä»–è¯·æ±‚æ— æ³•è¿æ¥æ•°æ®åº“ã€‚å®ƒä¼šå¯¼è‡´è¿æ¥è¶…æ—¶ï¼Œæ‰§è¡Œæ–¹æ³•å¤±è´¥ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢æ–¹æ³•ä¸­ <code>this.getData()</code> æ–¹æ³•ä¼šå ç”¨ <code>5s</code> çš„æ—¶é—´ã€‚å¦‚æœ <code>5s</code> å†…æœ‰ <code>100</code> æ¡è¯·æ±‚å¹¶å‘æ‰§è¡Œï¼Œä¸”æ•°æ®åº“è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ä¸º <code>20</code>ï¼Œè¶…æ—¶æ—¶é—´ä¸º<code>3s</code>ã€‚ åˆ™å‰©ä½™çš„ <code>80</code> æ¡è¯·æ±‚ï¼Œéƒ½ä¼šå‡ºç°è¿æ¥å¤±è´¥çš„ç°è±¡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">bigTransaction</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1ã€getData()æ–¹æ³•æ¨¡æ‹Ÿä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„è·å–æ•°æ®çš„æ“ä½œï¼Œè¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¼šä¼‘çœ 5ç§’</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//2ã€å°†ä¸Šé¢è·å–åˆ°çš„æ•°æ®å†™å…¥åˆ°dbä¸­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Lesson007PO</span><span class="w"> </span><span class="n">po</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Lesson007PO</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">po</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">po</span><span class="p">.</span><span class="na">setData</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">lesson007Mapper</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">po</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getData</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//ä¼‘çœ 5ç§’</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">5</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="72-å¦‚ä½•è§£å†³å¤§-é•¿-äº‹åŠ¡çš„é—®é¢˜-æ‹†åˆ†ä¸ºå°äº‹åŠ¡">7.2 å¦‚ä½•è§£å†³å¤§ (é•¿) äº‹åŠ¡çš„é—®é¢˜ (æ‹†åˆ†ä¸ºå°äº‹åŠ¡)<a hidden class="anchor" aria-hidden="true" href="#72-å¦‚ä½•è§£å†³å¤§-é•¿-äº‹åŠ¡çš„é—®é¢˜-æ‹†åˆ†ä¸ºå°äº‹åŠ¡">#</a></h3>
<p><strong>ä¼˜åŒ–æ–¹æ³•</strong>ï¼šå°†å¤§(é•¿)äº‹åŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œå°†æ— éœ€æ•°æ®åº“è¿æ¥çš„éƒ¨åˆ†æ‹†å‡ºæ¥ï¼Œå°†äº‹åŠ¡æœ€å°åŒ–ã€‚
ä¾‹å¦‚ï¼Œä¸Šæ–¹çš„ä»£ç ä¸­ï¼Œ<code>this.getData()</code> æ–¹æ³•æ˜¯ä¸éœ€è¦æ“ä½œæ•°æ®åº“çš„ï¼Œåªæœ‰æœ€åçš„ <code>insert</code> æ–¹æ³•æ‰éœ€è¦è¿æ¥æ•°æ®åº“ã€‚æ‰€ä»¥ï¼Œå¯ä»¥å°†äº‹åŠ¡çš„ç²’åº¦æ§åˆ¶åœ¨ <code>insert</code> æ–¹æ³•ä¸­ã€‚</p>
<p><strong>TranscationTemplate</strong>ï¼šSpringä¸­çš„ <code>TranscationTemplate</code> å·¥å…·ç±»èƒ½å¤Ÿé‡‡ç”¨ç¼–ç¨‹å¼çš„æ–¹æ¡ˆï¼Œçµæ´»æ§åˆ¶äº‹åŠ¡çš„ç²’åº¦ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ä½¿ç”¨ TransactionTemplate ç¼–ç¨‹å¼äº‹åŠ¡ï¼Œå¯ä»¥çµæ´»çš„æ§åˆ¶äº‹åŠ¡çš„èŒƒå›´
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @throws InterruptedException
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">smallTransaction</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1ã€è°ƒç”¨getData()æ–¹æ³•ï¼Œè®²è·å–çš„æ•°æ®å†™åˆ°dbä¸­ï¼Œå‡è®¾ getDataæ–¹æ³•æ¯”è¾ƒè€—æ—¶ï¼Œæ¯”å¦‚è€—æ—¶ 5ç§’</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//2ã€å°†ä¸Šé¢è·å–åˆ°çš„æ•°æ®å†™å…¥åˆ°dbä¸­</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Lesson007PO</span><span class="w"> </span><span class="n">po</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Lesson007PO</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">po</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">po</span><span class="p">.</span><span class="na">setData</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// this.transactionTemplate.executeWithoutResultå¯ä»¥ä¼ å…¥ä¸€ä¸ªConsumerï¼Œè¿™ä¸ªConsumerè¡¨è¿°éœ€è¦åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œçš„ä¸šåŠ¡æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">transactionTemplate</span><span class="p">.</span><span class="na">executeWithoutResult</span><span class="p">(</span><span class="n">action</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">lesson007Mapper</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">po</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ã€æ€»ç»“ã€‘</p>
<ol>
<li><strong>æ§åˆ¶äº‹åŠ¡ç²’åº¦</strong> ï¼šä½¿ç”¨ <code>TransactionTemplate</code> ç¼–ç¨‹å¼äº‹åŠ¡ï¼Œç²¾å‡†æ§åˆ¶äº‹åŠ¡çš„ç²’åº¦ï¼Œå°½é‡è®©äº‹åŠ¡å°å‹åŒ–</li>
<li><strong>éæ•°æ®åº“ç›¸å…³ä»£ç ï¼Œé¿å…å‡ºç°åœ¨äº‹åŠ¡ä¸­</strong>ï¼šå°½é‡é¿å…å°†æ²¡æœ‰äº‹åŠ¡çš„è€—æ—¶æ“ä½œæ”¾åˆ°äº‹åŠ¡ä»£ç ä¸­ï¼›é¿å…åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œè¿œç¨‹æ“ä½œï¼Œè¿œç¨‹æ“ä½œæ˜¯ä¸éœ€è¦ç”¨åˆ°æœ¬åœ°äº‹åŠ¡çš„ï¼Œæ‰€ä»¥æ²¡æœ‰å¿…è¦æ”¾åœ¨äº‹åŠ¡ä¸­</li>
<li><strong>äº‹åŠ¡é›†ä¸­åŒ–</strong>ï¼šå°½é‡è®©äº‹åŠ¡çš„æ“ä½œé›†ä¸­åœ¨ä¸€èµ·æ‰§è¡Œï¼Œæ¯”å¦‚éƒ½æ”¾åˆ°æ–¹æ³•æœ€åï¼Œä½¿ç”¨ <code>TransactionTemplate</code> æ‰§è¡Œï¼Œè¿™æ ·å¯ä½¿äº‹åŠ¡æœ€å°åŒ–</li>
</ol>
<h2 id="8-åŠ¨æ€çº¿ç¨‹æ± ">8. åŠ¨æ€çº¿ç¨‹æ± <a hidden class="anchor" aria-hidden="true" href="#8-åŠ¨æ€çº¿ç¨‹æ± ">#</a></h2>
<p>ç›¸å…³ä»£ç ï¼š<a href="https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson009">https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson009</a></p>
<h3 id="81-ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€çº¿ç¨‹æ± ">8.1 ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€çº¿ç¨‹æ± <a hidden class="anchor" aria-hidden="true" href="#81-ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€çº¿ç¨‹æ± ">#</a></h3>
<blockquote>
<p>å¹³æ—¶æˆ‘ä»¬åœ¨å¼€å‘ä¸­ï¼Œåˆ›å»ºäº†ä¸å°‘çº¿ç¨‹æ± ï¼Œè¿™äº›çº¿ç¨‹æ± éƒ½å¤„äºæ¸¸ç¦»çŠ¶æ€ï¼Œä¸æ–¹ä¾¿ç®¡ç†å’Œç›‘æ§ã€‚æ— æ³•çŸ¥é“ç›®å‰ç³»ç»Ÿä¸­æœ‰å“ªäº›çº¿ç¨‹æ± ã€ä»¥åŠæ¯ä¸ªçº¿ç¨‹æ± å½“å‰çš„ä¸€ä¸ªçŠ¶æ€ï¼Œè´Ÿè½½æƒ…å†µç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¼€å‘ä¸€ä¸ªçº¿ç¨‹æ± ç®¡ç†å™¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p></blockquote>
<h3 id="82-çº¿ç¨‹æ± ç®¡ç†å™¨">8.2 çº¿ç¨‹æ± ç®¡ç†å™¨<a hidden class="anchor" aria-hidden="true" href="#82-çº¿ç¨‹æ± ç®¡ç†å™¨">#</a></h3>
<p>ç»Ÿç®¡ç³»ç»Ÿä¸­æ‰€æœ‰çº¿ç¨‹æ± ï¼Œè´Ÿè´£æ‰€æœ‰çº¿ç¨‹æ± çš„åˆ›å»ºã€ç›‘æ§ç­‰æ“ä½œã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ThreadPoolManager</span><span class="w"> </span><span class="p">{</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="cm">/** çº¿ç¨‹æ± Map */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ThreadPoolTaskExecutor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">threadPoolMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ThreadPoolTaskExecutor</span><span class="o">&gt;</span><span class="p">(</span><span class="n">16</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * åˆ›å»ºæ–°çš„çº¿ç¨‹æ± ï¼Œå¦‚æœçº¿ç¨‹æ± å·²ç»åˆ›å»ºï¼Œè¿”å›å·²ç»åˆ›å»ºçš„çº¿ç¨‹æ± 
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param name                     çº¿ç¨‹æ± åç§°
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param corePoolSize             æ ¸å¿ƒçº¿ç¨‹æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param maxPoolSize              æœ€å¤§çº¿ç¨‹æ•°
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param queueCapacity            é˜Ÿåˆ—å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param keepAliveSeconds         çº¿ç¨‹æ± å­˜æ´»æ—¶é—´ï¼ˆç§’ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param threadFactory            çº¿ç¨‹å·¥å‚
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param rejectedExecutionHandler æ‹’ç»ç­–ç•¥
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ThreadPoolTaskExecutor</span><span class="w"> </span><span class="nf">newThreadPool</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">corePoolSize</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxPoolSize</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">queueCapacity</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">keepAliveSeconds</span><span class="p">,</span><span class="w"> </span><span class="n">ThreadFactory</span><span class="w"> </span><span class="n">threadFactory</span><span class="p">,</span><span class="w"> </span><span class="n">RejectedExecutionHandler</span><span class="w"> </span><span class="n">rejectedExecutionHandler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">threadPoolMap</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">threadGroupName</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ThreadPoolTaskExecutor</span><span class="w"> </span><span class="n">threadPoolExecutor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolTaskExecutor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">initialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// åˆå§‹åŒ–æ ‡è®°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">protected</span><span class="w"> </span><span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">createQueue</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">queueCapacity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">queueCapacity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      	</span><span class="c1">// ä½¿ç”¨è‡ªå®šä¹‰çš„ ResizeLinkedBlockingQueue æ›¿ä»£é»˜è®¤é˜Ÿåˆ—ï¼Œä¿è¯èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´é˜Ÿåˆ—å¤§å°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ResizeLinkedBlockingQueue</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">queueCapacity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      	</span><span class="c1">// å½“é˜Ÿåˆ—å®¹é‡è®¾ç½®ä¸º0æ—¶ï¼Œä½¿ç”¨ SynchronousQueueã€‚è¡¨ç¤ºä»»åŠ¡å¿…é¡»ç«‹å³è¢«çº¿ç¨‹å¤„ç†ï¼Œå¦åˆ™å°±ä¼šè¢«æ‹’ç»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SynchronousQueue</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setQueueCapacity</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">queueCapacity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  	</span><span class="c1">// ç¡®ä¿çº¿ç¨‹æ± å·²åˆå§‹åŒ–ä¸”é˜Ÿåˆ—ç±»å‹æ­£ç¡®æ—¶æ‰è°ƒæ•´å®¹é‡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">initialized</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getThreadPoolExecutor</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">this</span><span class="p">.</span><span class="na">getThreadPoolExecutor</span><span class="p">().</span><span class="na">getQueue</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">this</span><span class="p">.</span><span class="na">getThreadPoolExecutor</span><span class="p">().</span><span class="na">getQueue</span><span class="p">()</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">ResizeLinkedBlockingQueue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">((</span><span class="n">ResizeLinkedBlockingQueue</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getThreadPoolExecutor</span><span class="p">().</span><span class="na">getQueue</span><span class="p">()).</span><span class="na">setCapacity</span><span class="p">(</span><span class="n">queueCapacity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">super</span><span class="p">.</span><span class="na">setQueueCapacity</span><span class="p">(</span><span class="n">queueCapacity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterPropertiesSet</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  	</span><span class="c1">// ä½¿ç”¨ initialized æ ‡è®°ç¡®ä¿çº¿ç¨‹æ± åªè¢«åˆå§‹åŒ–ä¸€æ¬¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">initialized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kd">super</span><span class="p">.</span><span class="na">afterPropertiesSet</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">this</span><span class="p">.</span><span class="na">initialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// è®¾ç½®å‚æ•°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">threadPoolExecutor</span><span class="p">.</span><span class="na">setCorePoolSize</span><span class="p">(</span><span class="n">corePoolSize</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadFactory</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// ThreadFactoryç›¸å½“äºçº¿ç¨‹æ± çš„ä¸€äº›è§„å®š (æ‹›è˜æ ‡å‡†)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">threadPoolExecutor</span><span class="p">.</span><span class="na">setThreadFactory</span><span class="p">(</span><span class="n">threadFactory</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rejectedExecutionHandler</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// æ‹’ç»æ‰§è¡Œçš„ç­–ç•¥ï¼Œä¸Šæ–¹æåˆ°çš„å››ç§æ‹’ç»ç­–ç•¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">threadPoolExecutor</span><span class="p">.</span><span class="na">setRejectedExecutionHandler</span><span class="p">(</span><span class="n">rejectedExecutionHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">threadPoolExecutor</span><span class="p">.</span><span class="na">afterPropertiesSet</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">threadPoolExecutor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/** è·å–æ‰€æœ‰çº¿ç¨‹æ± ä¿¡æ¯ */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ThreadPoolInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">threadPoolInfoList</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">threadPoolMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">entrySet</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">threadPoolInfo</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">()))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="83-åŠ¨æ€çº¿ç¨‹æ± ">8.3 åŠ¨æ€çº¿ç¨‹æ± <a hidden class="anchor" aria-hidden="true" href="#83-åŠ¨æ€çº¿ç¨‹æ± ">#</a></h3>
<p>åŠ¨æ€çº¿ç¨‹æ± ï¼šæ— éœ€é‡å¯çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å¯¹çº¿ç¨‹æ± è¿›è¡Œæ‰©ç¼©å®¹ï¼Œæ¯”å¦‚æ”¹å˜çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡ã€æœ€å¤§çº¿ç¨‹æ•°é‡ã€é˜Ÿåˆ—å®¹é‡ç­‰ã€‚</p>
<h4 id="831-å¸¸ç”¨åŠ¨æ€çº¿ç¨‹æ± ">8.3.1 å¸¸ç”¨åŠ¨æ€çº¿ç¨‹æ± <a hidden class="anchor" aria-hidden="true" href="#831-å¸¸ç”¨åŠ¨æ€çº¿ç¨‹æ± ">#</a></h4>
<p><strong>dynamic-tp</strong>ï¼šhttps://github.com/dromara/dynamic-tp</p>
<h4 id="832-æ‰‹åŠ¨å®ç°åŠ¨æ€çº¿ç¨‹æ± ">8.3.2 æ‰‹åŠ¨å®ç°åŠ¨æ€çº¿ç¨‹æ± <a hidden class="anchor" aria-hidden="true" href="#832-æ‰‹åŠ¨å®ç°åŠ¨æ€çº¿ç¨‹æ± ">#</a></h4>
<blockquote>
<p>çº¿ç¨‹æ± ä¸­ä¼šç”¨åˆ°Javaä¸­çš„é˜»å¡é˜Ÿåˆ— <code>java.util.concurrent.BlockingQueue</code>ï¼Œç›®å‰ jdkä¸­è‡ªå¸¦å‡ ä¸ªé˜»å¡é˜Ÿåˆ—éƒ½ä¸æ”¯æŒåŠ¨æ€æ‰©å®¹ã€‚
æ¯”å¦‚ <code>java.util.concurrent.LinkedBlockingQueue</code>ï¼Œå®ƒçš„ <code>capacity</code> æ˜¯ <code>final</code> ä¿®é¥°çš„ï¼Œä¸æ”¯æŒä¿®æ”¹ã€‚</p></blockquote>
<p><strong>åŠ¨æ€è°ƒæ•´å¤§å°çš„å‰æ</strong>ï¼šåŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å¤§å°éœ€è¦é˜Ÿåˆ—å®¹é‡èƒ½å¤Ÿæ”¯æŒè°ƒæ•´ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºå¯æ‰©å®¹çš„é˜»å¡é˜Ÿåˆ— <code>ResizeLinkedBlockingQueue</code>ã€‚ä»£ç æ˜¯ä»<code>LinkedBlockingQueue</code> ä¸­æ‹·è´è¿‡æ¥çš„ï¼Œå¢åŠ å¯ä¿®æ”¹å®¹é‡ çš„<code>setCapacity</code> æ–¹æ³•ã€‚ç„¶ååˆ›å»ºçº¿ç¨‹æ± çš„æ—¶ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„é˜»å¡é˜Ÿåˆ—ä¾¿å¯ä»¥å®ç°çº¿ç¨‹æ± çš„åŠ¨æ€æ‰©å®¹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è®¾ç½®å®¹é‡
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param capacity
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setCapacity</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">capacity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">capacity</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">ReentrantLock</span><span class="w"> </span><span class="n">putLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">putLock</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">putLock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">capacity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">capacity</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">putLock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>åŠ¨æ€æ›´æ”¹çº¿ç¨‹æ± å¤§å°çš„æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ThreadPoolManager</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * åŠ¨æ€å˜æ›´çº¿ç¨‹æ± ï¼ˆå¦‚ï¼šæ‰©ç¼©å®¹ã€æ‰©ç¼©é˜Ÿåˆ—å¤§å°ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param threadPoolChange å˜æ›´çº¿ç¨‹æ± ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">changeThreadPool</span><span class="p">(</span><span class="n">ThreadPoolChange</span><span class="w"> </span><span class="n">threadPoolChange</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ThreadPoolTaskExecutor</span><span class="w"> </span><span class="n">threadPoolTaskExecutor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadPoolMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">threadPoolChange</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadPoolTaskExecutor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadPoolChange</span><span class="p">.</span><span class="na">getCorePoolSize</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">threadPoolChange</span><span class="p">.</span><span class="na">getMaxPoolSize</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">ThreadPoolManager</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// å¢åŠ çº¿ç¨‹æƒ…å†µï¼šéœ€è¦ä¿®æ”¹çš„æœ€å¤§çº¿ç¨‹å¤§äºå½“å‰æ ¸å¿ƒçº¿ç¨‹ï¼Œåˆ™è®¾ç½®å½“å‰æ ¸å¿ƒçº¿ç¨‹ä¸ºä¿®æ”¹åçš„æœ€å¤§çº¿ç¨‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threadPoolChange</span><span class="p">.</span><span class="na">getMaxPoolSize</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">threadPoolTaskExecutor</span><span class="p">.</span><span class="na">getCorePoolSize</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">// å…ˆè°ƒæ•´æœ€å¤§çº¿ç¨‹æ•°ï¼Œå†è°ƒæ•´æ ¸å¿ƒæ•° ï¼ˆå…ˆæ‰©å¤§æ€»é‡ï¼Œå†æ‰©å¤§å±€éƒ¨ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">threadPoolTaskExecutor</span><span class="p">.</span><span class="na">setMaxPoolSize</span><span class="p">(</span><span class="n">threadPoolChange</span><span class="p">.</span><span class="na">getMaxPoolSize</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">threadPoolTaskExecutor</span><span class="p">.</span><span class="na">setCorePoolSize</span><span class="p">(</span><span class="n">threadPoolChange</span><span class="p">.</span><span class="na">getCorePoolSize</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">threadPoolTaskExecutor</span><span class="p">.</span><span class="na">setQueueCapacity</span><span class="p">(</span><span class="n">threadPoolChange</span><span class="p">.</span><span class="na">getQueueCapacity</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              	</span><span class="c1">// å…ˆå‡å°‘å±€éƒ¨ï¼Œå†å‡å°‘æ€»é‡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">threadPoolTaskExecutor</span><span class="p">.</span><span class="na">setCorePoolSize</span><span class="p">(</span><span class="n">threadPoolChange</span><span class="p">.</span><span class="na">getCorePoolSize</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">threadPoolTaskExecutor</span><span class="p">.</span><span class="na">setMaxPoolSize</span><span class="p">(</span><span class="n">threadPoolChange</span><span class="p">.</span><span class="na">getMaxPoolSize</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">threadPoolTaskExecutor</span><span class="p">.</span><span class="na">setQueueCapacity</span><span class="p">(</span><span class="n">threadPoolChange</span><span class="p">.</span><span class="na">getQueueCapacity</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h1 id="åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡">åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡">#</a></h1>
<h2 id="1-springbootå®ç°åŠ¨æ€jobçš„å®æˆ˜">1. SpringBootå®ç°åŠ¨æ€Jobçš„å®æˆ˜<a hidden class="anchor" aria-hidden="true" href="#1-springbootå®ç°åŠ¨æ€jobçš„å®æˆ˜">#</a></h2>
<p>ç›¸å…³ä»£ç ï¼š<a href="https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson011">https://github.com/SwimmingLiu/JavaSceneQuiz100/tree/main/lesson011</a></p>
<h3 id="11-jobè¡¨---è¡¨ç»“æ„">1.1 Jobè¡¨ - è¡¨ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#11-jobè¡¨---è¡¨ç»“æ„">#</a></h3>
<table>
  <thead>
      <tr>
          <th>å­—æ®µå</th>
          <th>ç±»å‹</th>
          <th>å¯ç©º</th>
          <th>é»˜è®¤</th>
          <th>å¤‡æ³¨</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>id</td>
          <td>varchar(50)</td>
          <td>å¦</td>
          <td>-</td>
          <td>idï¼Œä¸»é”®</td>
      </tr>
      <tr>
          <td>name</td>
          <td>varchar(100)</td>
          <td>å¦</td>
          <td>-</td>
          <td>jobåç§°ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªæœ‰æ„ä¹‰çš„åç§°</td>
      </tr>
      <tr>
          <td>cron</td>
          <td>varchar(50)</td>
          <td>å¦</td>
          <td>-</td>
          <td>jobçš„æ‰§è¡Œå‘¨æœŸï¼Œcronè¡¨è¾¾å¼</td>
      </tr>
      <tr>
          <td>bean_name</td>
          <td>varchar(100)</td>
          <td>å¦</td>
          <td>-</td>
          <td>jobéœ€è¦æ‰§è¡Œé‚£ä¸ªbeanï¼Œå¯¹åº”springä¸­beançš„åç§°</td>
      </tr>
      <tr>
          <td>bean_method</td>
          <td>varchar(100)</td>
          <td>å¦</td>
          <td>-</td>
          <td>jobæ‰§è¡Œçš„beançš„æ–¹æ³•</td>
      </tr>
      <tr>
          <td>status</td>
          <td>smallint</td>
          <td>å¦</td>
          <td>0</td>
          <td>jobçš„çŠ¶æ€,0ï¼šåœæ­¢ï¼Œ1ï¼šæ‰§è¡Œä¸­</td>
      </tr>
  </tbody>
</table>
<h3 id="12-jobæ‰§è¡Œç®¡ç†å™¨">1.2 Jobæ‰§è¡Œç®¡ç†å™¨<a hidden class="anchor" aria-hidden="true" href="#12-jobæ‰§è¡Œç®¡ç†å™¨">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SpringJobRunManager</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CommandLineRunner</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  	</span><span class="c1">// applicationContext ä¸»è¦ç”¨äºåœ¨ä»»åŠ¡æ‰§è¡Œæ—¶åŠ¨æ€è·å–å’Œè°ƒç”¨æŒ‡å®šçš„ Bean å’Œæ–¹æ³•ï¼Œå®ç°çµæ´»çš„ä»»åŠ¡è°ƒåº¦ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// å¯ä»¥æŠŠå®ƒç†è§£ä¸ºâ€œSpring ç®¡ç†çš„å¯¹è±¡å·¥å‚å’ŒæœåŠ¡æ€»çº¿â€</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="c1">// threadPoolTaskScheduler æ˜¯ Spring æä¾›çš„çº¿ç¨‹æ± å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ï¼Œä¸»è¦ç”¨äºåœ¨åº”ç”¨ä¸­ä»¥å¤šçº¿ç¨‹æ–¹å¼æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼ˆå¦‚å®šæ—¶æ‰§è¡Œã€Cronè¡¨è¾¾å¼è°ƒåº¦ç­‰ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ThreadPoolTaskScheduler</span><span class="w"> </span><span class="n">threadPoolTaskScheduler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// jobè¡¨ç›¸å…³æœåŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Autowired</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">JobService</span><span class="w"> </span><span class="n">jobService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ç³»ç»Ÿé‡æ­£åœ¨è¿è¡Œä¸­çš„jobåˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">SpringJobTask</span><span class="o">&gt;</span><span class="w"> </span><span class="n">runningJobMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * springbootåº”ç”¨å¯åŠ¨åä¼šå›è°ƒ
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param args incoming main method arguments
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">String</span><span class="p">...</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//1ã€å¯åŠ¨job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">startAllJob</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//2ã€ç›‘æ§dbä¸­jobçš„å˜åŒ–ï¼ˆjobå¢ã€åˆ ã€æ”¹ï¼‰ï¼Œç„¶ååŒæ­¥ç»™jobæ‰§è¡Œå™¨å»æ‰§è¡Œ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">monitorDbJobChange</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Springbootåº”ç”¨å¯åŠ¨ä¹‹åä¼šå›è°ƒ <code>CommandLineRunner</code> ä¸­çš„ <code>run</code> æ–¹æ³•ï¼Œä¾æ¬¡å¯åŠ¨jobï¼Œå¹¶ç›‘æ§jobä¸­çš„å˜åŒ–ã€‚</p>
<h4 id="121-å¯åŠ¨job">1.2.1 å¯åŠ¨job<a hidden class="anchor" aria-hidden="true" href="#121-å¯åŠ¨job">#</a></h4>
<p>å¯åŠ¨jobçš„æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ä»æ•°æ®åº“ä¸­æ‰¾å‡ºæ‰€æœ‰éœ€è¦å¯åŠ¨çš„jobï¼ˆçŠ¶æ€ä¸ºstartï¼‰ï¼Œç„¶åå¾ªç¯å¯åŠ¨ã€‚</p>
<p>å¯åŠ¨jobå…·ä½“æ–¹å¼å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">startAllJob</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Job</span><span class="o">&gt;</span><span class="w"> </span><span class="n">jobList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">jobService</span><span class="p">.</span><span class="na">getStartJobList</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Job</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">jobList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">startJob</span><span class="p">(</span><span class="n">job</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼ˆjobï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param job éœ€è¦å¯åŠ¨çš„ä»»åŠ¡å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">startJob</span><span class="p">(</span><span class="n">Job</span><span class="w"> </span><span class="n">job</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. åˆ›å»ºä»»åŠ¡æ‰§è¡Œä½“ï¼Œæ³¨å…¥Springä¸Šä¸‹æ–‡ï¼Œä¾¿äºä»»åŠ¡å†…è·å–Beanå¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SpringJobTask</span><span class="w"> </span><span class="n">springJobTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SpringJobTask</span><span class="p">(</span><span class="n">job</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">applicationContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. æ ¹æ®jobçš„cronè¡¨è¾¾å¼åˆ›å»ºè°ƒåº¦è§¦å‘å™¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CronTrigger</span><span class="w"> </span><span class="n">trigger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CronTrigger</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="na">getCron</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. ä½¿ç”¨çº¿ç¨‹æ± è°ƒåº¦å™¨æ³¨å†Œä»»åŠ¡ï¼Œè¿”å›è°ƒåº¦å¥æŸ„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ScheduledFuture</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">scheduledFuture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">threadPoolTaskScheduler</span><span class="p">.</span><span class="na">schedule</span><span class="p">(</span><span class="n">springJobTask</span><span class="p">,</span><span class="w"> </span><span class="n">trigger</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 4. è®°å½•è°ƒåº¦å¥æŸ„åˆ°ä»»åŠ¡å¯¹è±¡ï¼Œä¾¿äºåç»­å–æ¶ˆ -&gt; </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">springJobTask</span><span class="p">.</span><span class="na">setScheduledFuture</span><span class="p">(</span><span class="n">scheduledFuture</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 5. å°†ä»»åŠ¡æ”¾å…¥è¿è¡Œä¸­çš„ä»»åŠ¡Mapï¼Œæ–¹ä¾¿ç®¡ç†å’ŒæŸ¥æ‰¾</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">runningJobMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="n">springJobTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 6. è®°å½•æ—¥å¿—ï¼Œæ–¹ä¾¿è¿½è¸ª</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;å¯åŠ¨ job æˆåŠŸ:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toJsonStr</span><span class="p">(</span><span class="n">job</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * åˆ é™¤ï¼ˆåœæ­¢ï¼‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param job éœ€è¦åˆ é™¤çš„ä»»åŠ¡å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">deleteJob</span><span class="p">(</span><span class="n">Job</span><span class="w"> </span><span class="n">job</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">job</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. ä»è¿è¡Œä¸­çš„ä»»åŠ¡Mapè·å–ä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SpringJobTask</span><span class="w"> </span><span class="n">springJobTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">runningJobMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">springJobTask</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="p">;}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. å–æ¶ˆä»»åŠ¡è°ƒåº¦ï¼ˆåœæ­¢å®šæ—¶æ‰§è¡Œï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">springJobTask</span><span class="p">.</span><span class="na">getScheduledFuture</span><span class="p">().</span><span class="na">cancel</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. ä»Mapä¸­ç§»é™¤è¯¥ä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">runningJobMap</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 4. è®°å½•æ—¥å¿—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç§»é™¤ job æˆåŠŸ:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toJsonStr</span><span class="p">(</span><span class="n">job</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æ›´æ–°ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼ˆå…ˆåˆ é™¤å†å¯åŠ¨ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param job éœ€è¦æ›´æ–°çš„ä»»åŠ¡å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateJob</span><span class="p">(</span><span class="n">Job</span><span class="w"> </span><span class="n">job</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 1. å…ˆåˆ é™¤æ—§çš„ä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">deleteJob</span><span class="p">(</span><span class="n">job</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 2. å†å¯åŠ¨æ–°çš„ä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">startJob</span><span class="p">(</span><span class="n">job</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 3. è®°å½•æ—¥å¿—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ›´æ–° job æˆåŠŸ:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toJsonStr</span><span class="p">(</span><span class="n">job</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="122-åŠ¨æ€ç›‘æ§dbä¸­jobçš„å˜åŒ–">1.2.2 åŠ¨æ€ç›‘æ§DBä¸­jobçš„å˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#122-åŠ¨æ€ç›‘æ§dbä¸­jobçš„å˜åŒ–">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ç›‘æ§dbä¸­jobçš„å˜åŒ–ï¼Œæ¯5ç§’ç›‘æ§ä¸€æ¬¡ï¼Œè¿™ä¸ªé¢‘ç‡å¤§å®¶ä½¿ç”¨çš„æ—¶å€™å¯ä»¥ç¨å¾®è°ƒå¤§ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">monitorDbJobChange</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">threadPoolTaskScheduler</span><span class="p">.</span><span class="na">scheduleWithFixedDelay</span><span class="p">(</span><span class="k">this</span><span class="p">::</span><span class="n">jobChangeDispose</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="n">5</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// ä»»åŠ¡å˜åŒ–å¤„ç†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">jobChangeDispose</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//1ã€ä»dbä¸­æ‹¿åˆ°æ‰€æœ‰jobï¼Œå’Œç›®å‰å†…å­˜ä¸­æ­£åœ¨è¿è¡Œçš„æ‰€æœ‰jobå¯¹æ¯”ï¼Œå¯å¾—åˆ°æœ¬æ¬¡æ–°å¢çš„jobã€åˆ é™¤çš„jobã€æ›´æ–°çš„job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">JobChange</span><span class="w"> </span><span class="n">jobChange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getJobChange</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//2ã€å¤„ç†æ–°å¢çš„job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Job</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">jobChange</span><span class="p">.</span><span class="na">getAddJobList</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">startJob</span><span class="p">(</span><span class="n">job</span><span class="p">);}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//3ã€å¤„ç†åˆ é™¤çš„job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Job</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">jobChange</span><span class="p">.</span><span class="na">getDeleteJobList</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">deleteJob</span><span class="p">(</span><span class="n">job</span><span class="p">);}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//4ã€å¤„ç†å˜åŒ–çš„job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Job</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">jobChange</span><span class="p">.</span><span class="na">getUpdateJobList</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">updateJob</span><span class="p">(</span><span class="n">job</span><span class="p">);}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">JobChange</span><span class="w"> </span><span class="nf">getJobChange</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//æ–°å¢çš„job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Job</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addJobList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//åˆ é™¤çš„job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Job</span><span class="o">&gt;</span><span class="w"> </span><span class="n">deleteJobList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//æ›´æ–°çš„job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Job</span><span class="o">&gt;</span><span class="w"> </span><span class="n">updateJobList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//ä»dbä¸­æ‹¿åˆ°æ‰€æœ‰jobï¼Œå’Œç›®å‰å†…å­˜ä¸­æ­£åœ¨è¿è¡Œçš„æ‰€æœ‰jobå¯¹æ¯”ï¼Œå¯å¾—åˆ°æœ¬æ¬¡æ–°å¢çš„jobã€åˆ é™¤çš„jobã€æ›´æ–°çš„job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Job</span><span class="o">&gt;</span><span class="w"> </span><span class="n">startJobList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">jobService</span><span class="p">.</span><span class="na">getStartJobList</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Job</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">startJobList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SpringJobTask</span><span class="w"> </span><span class="n">springJobTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runningJobMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">springJobTask</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">addJobList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">job</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">//jobçš„æ‰§è¡Œè§„åˆ™å˜äº†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jobIsChange</span><span class="p">(</span><span class="n">job</span><span class="p">,</span><span class="w"> </span><span class="n">springJobTask</span><span class="p">.</span><span class="na">getJob</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">updateJobList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">job</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//è·å–è¢«åˆ é™¤çš„jobï¼ŒspringJobTaskMapä¸­å­˜åœ¨çš„ï¼Œè€ŒstartJobListä¸å­˜åœ¨çš„ï¼Œåˆ™æ˜¯éœ€è¦ä»å½“å‰è¿è¡Œåˆ—è¡¨ä¸­åœæ­¢ç§»é™¤çš„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">startJobIdList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CollUtils</span><span class="p">.</span><span class="na">convertSet</span><span class="p">(</span><span class="n">startJobList</span><span class="p">,</span><span class="w"> </span><span class="n">Job</span><span class="p">::</span><span class="n">getId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">SpringJobTask</span><span class="o">&gt;</span><span class="w"> </span><span class="n">springJobTaskEntry</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">runningJobMap</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">startJobIdList</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">springJobTaskEntry</span><span class="p">.</span><span class="na">getKey</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">deleteJobList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">springJobTaskEntry</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">getJob</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//è¿”å›jobå˜æ›´ç»“æœ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JobChange</span><span class="p">(</span><span class="n">addJobList</span><span class="p">,</span><span class="w"> </span><span class="n">updateJobList</span><span class="p">,</span><span class="w"> </span><span class="n">deleteJobList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æ£€æµ‹ä¸¤ä¸ªjobæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œï¼ˆcronã€beanNameã€beanMethodï¼‰ä¸­æœ‰ä»»æ„ä¸€é¡¹å˜åŠ¨äº†ï¼Œåˆ™è¿”å›true
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param job1
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param job2
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">jobIsChange</span><span class="p">(</span><span class="n">Job</span><span class="w"> </span><span class="n">job1</span><span class="p">,</span><span class="w"> </span><span class="n">Job</span><span class="w"> </span><span class="n">job2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">job1</span><span class="p">.</span><span class="na">getCron</span><span class="p">(),</span><span class="w"> </span><span class="n">job2</span><span class="p">.</span><span class="na">getCron</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">job1</span><span class="p">.</span><span class="na">getBeanName</span><span class="p">(),</span><span class="w"> </span><span class="n">job2</span><span class="p">.</span><span class="na">getBeanName</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">job1</span><span class="p">.</span><span class="na">getBeanMethod</span><span class="p">(),</span><span class="w"> </span><span class="n">job2</span><span class="p">.</span><span class="na">getBeanMethod</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div>

  </div>



  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://swimmingliu.cn/tags/java/">Java</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://swimmingliu.cn/posts/job/hensheng-interview-questions/">
    <span class="title">Next Â»</span>
    <br>
    <span>æ’ç”Ÿèšæºé¢ç»è®°å½•</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2023-2025 <a href="https://swimmingliu.cn/">SwimmingLiu&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
    <span>
        <a href="https://beian.miit.gov.cn/">æµ™ICPå¤‡2024056260å·</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
